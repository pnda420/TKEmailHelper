<header class="site-header" role="banner">
  <div class="container header__inner">

    <!-- Logo als Button für besseres Touch-Handling -->
    <button type="button" class="brand-btn" (click)="routeTo(user ? '/' : '/welcome', $event)"
      aria-label="Zur Startseite">
      <img class="brand" src="assets/logos/lm-mf_s.png" alt="LeonardsMedia" decoding="async" loading="eager"
        fetchpriority="high" />
      <!-- <span class="brand-name">MailFlow</span> -->
    </button>

    <nav id="primary-nav" class="nav" [class.open]="open">
      <div class="nav__main">
        <!-- Nav links only shown when logged in -->
        <ng-container *ngIf="user">
          <a routerLink="/" routerLinkActive="active" [routerLinkActiveOptions]="{ exact: true }"
            (click)="servicesDropdownOpen = false; closeMenu()">
            <span class="material-symbols-outlined ms-size-18">home</span>
            Home
          </a>
          <a routerLink="/emails" routerLinkActive="active" (click)="servicesDropdownOpen = false; closeMenu()">
            <span class="material-symbols-outlined ms-size-18">inbox</span>
            Posteingang
          </a>
          <a routerLink="/spam-killer" routerLinkActive="active" (click)="servicesDropdownOpen = false; closeMenu()"
            [routerLinkActiveOptions]="{ exact: true }">
            <span class="material-symbols-outlined ms-size-18">shield</span>
            Spam Killer
            <span class="nav-spam-badge" *ngIf="totalSpamCount > 0">{{ totalSpamCount > 99 ? '99+' : totalSpamCount
              }}</span>
          </a>
          <a routerLink="/history" routerLinkActive="active" (click)="servicesDropdownOpen = false; closeMenu()">
            <span class="material-symbols-outlined ms-size-18">history</span>
            Verlauf
          </a>
          <a *ngIf="user.role === UserRole.ADMIN" routerLink="/admin" routerLinkActive="active"
            class="nav-link--admin-main" (click)="servicesDropdownOpen = false; closeMenu()">
            <span class="material-symbols-outlined ms-size-18">admin_panel_settings</span>
            Admin
          </a>
        </ng-container>
      </div>

      <div class="nav__auth">
        <!-- Connection Status Indicator -->
        <div class="connection-status-container" *ngIf="user">
          <button class="connection-status-btn" (click)="toggleConnectionPopup($event)" [title]="connectionLabel">
            <span class="connection-dot" [ngClass]="connectionDotClass"></span>
          </button>

          <!-- Connection Popup -->
          <div class="connection-popup" *ngIf="connectionPopupOpen">
            <div class="connection-popup__header">
              <span class="material-symbols-outlined">lan</span>
              <span>Verbindungen</span>
              <button class="connection-popup__refresh" (click)="refreshConnectionStatus($event)" title="Aktualisieren">
                <span class="material-symbols-outlined">refresh</span>
              </button>
            </div>
            <div class="connection-popup__body" *ngIf="connectionStatus">
              <div class="connection-row">
                <span class="connection-row__dot" [class.ok]="connectionStatus.vpn"
                  [class.fail]="!connectionStatus.vpn"></span>
                <span class="connection-row__label">VPN ({{ connectionStatus.vpnLatency}}ms)</span>
                <span class="connection-row__value" *ngIf="connectionStatus.vpn">Online</span>
                <span class="connection-row__value fail" *ngIf="!connectionStatus.vpn">Offline</span>
              </div>
              <div class="connection-row">
                <span class="connection-row__dot" [class.ok]="connectionStatus.postgres"
                  [class.fail]="!connectionStatus.postgres"></span>
                <span class="connection-row__label">MailFlow Datenbank</span>
                <span class="connection-row__value" *ngIf="connectionStatus.postgres">Online</span>
                <span class="connection-row__value fail" *ngIf="!connectionStatus.postgres">Offline</span>
              </div>
              <div class="connection-row">
                <span class="connection-row__dot" [class.ok]="connectionStatus.mssql"
                  [class.fail]="!connectionStatus.mssql"></span>
                <span class="connection-row__label">TKS Wawi</span>
                <span class="connection-row__value" *ngIf="connectionStatus.mssql">Online</span>
                <span class="connection-row__value fail" *ngIf="!connectionStatus.mssql">Offline</span>
              </div>
              <div class="connection-row">
                <span class="connection-row__dot" [class.ok]="connectionStatus.imap"
                  [class.fail]="!connectionStatus.imap"></span>
                <span class="connection-row__label">Mail Service</span>
                <span class="connection-row__value" *ngIf="connectionStatus.imap">Online</span>
                <span class="connection-row__value fail" *ngIf="!connectionStatus.imap">Offline</span>
              </div>
            </div>
            <div class="connection-popup__body" *ngIf="!connectionStatus">
              <div class="connection-popup__loading">Lade...</div>
            </div>
            <div class="connection-popup__footer">
              <span class="connection-popup__time" *ngIf="connectionStatus">
                {{ connectionStatus.timestamp | date:'HH:mm:ss' }}
              </span>
              <a routerLink="/admin/health" *ngIf="user.role === UserRole.ADMIN" class="connection-popup__link"
                (click)="connectionPopupOpen = false; closeMenu()">
                Details →
              </a>
            </div>
          </div>
        </div>

        <!-- Mailbox Selector (only show if user has multiple mailboxes) -->
        <div class="mailbox-selector-container" *ngIf="user && myMailboxes.length > 0">
          <button class="mailbox-selector-btn" (click)="toggleMailboxDropdown($event)" title="Postfächer">
            <span class="material-symbols-outlined ms-size-20">inbox</span>
            <span class="mailbox-count" *ngIf="hasMultipleMailboxes">{{ activeMailboxCount }}/{{ myMailboxes.length
              }}</span>
          </button>

          <div class="mailbox-dropdown" *ngIf="mailboxDropdownOpen">
            <div class="mailbox-dropdown__header">
              <span class="material-symbols-outlined">inbox</span>
              <span>Postfächer</span>
            </div>
            <div class="mailbox-dropdown__body">
              <label class="mailbox-option" *ngFor="let um of myMailboxes" [class.active]="um.isActive"
                [style.border-left-color]="um.mailbox.color || '#1565c0'">
                <input type="checkbox" [checked]="um.isActive" (change)="toggleMailboxActive(um, $event)" />
                <div class="mailbox-option__info">
                  <span class="mailbox-option__name">{{ um.mailbox.name || 'Postfach' }}</span>
                  <span class="mailbox-option__email">{{ um.mailbox.email }}</span>
                </div>
              </label>
            </div>
          </div>
        </div>

        <ng-container *ngIf="!user">
          <a routerLink="/login" routerLinkActive="active" class="nav-link--primary"
            (click)="servicesDropdownOpen = false; closeMenu()">
            <span class="material-symbols-outlined ms-size-20">login</span>
            Login
          </a>
        </ng-container>

        <ng-container *ngIf="user">
          <a routerLink="/profile" routerLinkActive="active" class="nav-link--profile" title="Profil"
            (click)="servicesDropdownOpen = false; closeMenu()">
            <span class="material-symbols-outlined ms-size-22 ms-fill">account_circle</span>
            <span class="nav-profile-name">{{ user.name.split(' ')[0] }}</span>
          </a>

          <button class="nav-link--icon nav-link--logout" type="button" (click)="servicesDropdownOpen = false; logout()"
            title="Ausloggen">
            <span class="material-symbols-outlined ms-size-22">logout</span>
          </button>
        </ng-container>
      </div>
    </nav>

    <div class="header__mobile-actions">

      <button class="nav-toggle" type="button" [attr.aria-expanded]="open"
        [attr.aria-label]="open ? 'Menü schließen' : 'Menü öffnen'" (click)="toggle($event)">
        <span class="material-symbols-outlined">{{ open ? 'close' : 'menu' }}</span>
      </button>
    </div>
  </div>

  <div class="backdrop" *ngIf="open" (click)="toggle($event)"></div>
</header>