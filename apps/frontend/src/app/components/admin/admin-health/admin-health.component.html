<app-admin-layout>
<section class="admin-health">

  <!-- Header -->
  <div class="page-header">
    <div class="header-left">
      <h1>
        <span class="material-symbols-outlined">monitor_heart</span>
        System Status
      </h1>
      <span class="status-badge" [class]="overallStatus">
        <span class="material-symbols-outlined">{{ overallStatusIcon }}</span>
        {{ overallStatusLabel }}
      </span>
    </div>
    <div class="header-actions">
      <span class="last-check" *ngIf="lastChecked">
        <span class="material-symbols-outlined">schedule</span>
        {{ formatLastChecked() }}
      </span>
      <button class="btn-icon" (click)="loadHealth()" [disabled]="loading" title="Aktualisieren">
        <span class="material-symbols-outlined" [class.spinning]="loading">refresh</span>
      </button>
    </div>
  </div>

  <!-- Loading -->
  <div class="loading-state" *ngIf="loading && !health">
    <div class="skeleton-grid">
      <div class="skeleton-card" *ngFor="let i of [1,2,3,4,5]"></div>
    </div>
  </div>

  <!-- Error -->
  <div class="error-state" *ngIf="error && !health">
    <span class="material-symbols-outlined">cloud_off</span>
    <p>{{ error }}</p>
    <button class="btn-retry" (click)="loadHealth()">Erneut versuchen</button>
  </div>

  <!-- Scrollable Content -->
  <div class="health-content" *ngIf="health">

    <!-- Quick Stats Row -->
    <div class="quick-stats">
      <div class="quick-stat">
        <span class="material-symbols-outlined" [class.text-green]="connectedCount === totalServices" [class.text-yellow]="connectedCount > 0 && connectedCount < totalServices" [class.text-red]="connectedCount === 0">dns</span>
        <div class="qs-text">
          <span class="qs-value">{{ connectedCount }}/{{ totalServices }}</span>
          <span class="qs-label">Services online</span>
        </div>
      </div>
      <div class="quick-stat">
        <span class="material-symbols-outlined text-blue">speed</span>
        <div class="qs-text">
          <span class="qs-value">{{ health.totalLatency }}ms</span>
          <span class="qs-label">Health-Check</span>
        </div>
      </div>
      <div class="quick-stat">
        <span class="material-symbols-outlined" [class]="'text-' + getCpuColor()">memory</span>
        <div class="qs-text">
          <span class="qs-value">{{ health.system.cpuPercent }}%</span>
          <span class="qs-label">CPU</span>
        </div>
      </div>
      <div class="quick-stat">
        <span class="material-symbols-outlined" [class]="'text-' + getMemoryColor()">database</span>
        <div class="qs-text">
          <span class="qs-value">{{ health.system.memoryMb.heapUsed }}MB</span>
          <span class="qs-label">Heap</span>
        </div>
      </div>
      <div class="quick-stat">
        <span class="material-symbols-outlined text-purple">schedule</span>
        <div class="qs-text">
          <span class="qs-value">{{ health.system.uptimeFormatted }}</span>
          <span class="qs-label">Uptime</span>
        </div>
      </div>
    </div>

    <!-- Health Cards -->
    <div class="health-grid">

    <!-- VPN / Netzwerk -->
    <div class="health-card" [class.healthy]="health.services.vpn.connected" [class.unhealthy]="!health.services.vpn.connected">
      <div class="card-header">
        <div class="card-icon-wrap vpn">
          <span class="material-symbols-outlined">vpn_lock</span>
        </div>
        <div class="card-title">
          <h3>VPN / Netzwerk</h3>
          <span class="card-subtitle">WaWi-Zugang</span>
        </div>
        <div class="status-dot" [class.online]="health.services.vpn.connected" [class.offline]="!health.services.vpn.connected">
          <span class="dot-pulse" *ngIf="health.services.vpn.connected"></span>
        </div>
      </div>
      <div class="card-details">
        <div class="detail-row">
          <span class="detail-label">Status</span>
          <span class="detail-value" [class.text-green]="health.services.vpn.connected" [class.text-red]="!health.services.vpn.connected">
            {{ health.services.vpn.connected ? 'Erreichbar' : 'Nicht erreichbar' }}
          </span>
        </div>
        <div class="detail-row">
          <span class="detail-label">Ziel</span>
          <span class="detail-value mono">{{ health.services.vpn.host }}:{{ health.services.vpn.port }}</span>
        </div>
        <div class="detail-row" *ngIf="health.services.vpn.connected">
          <span class="detail-label">Latenz</span>
          <span class="detail-value">{{ health.services.vpn.latency }}ms</span>
        </div>
        <div class="detail-row error-row" *ngIf="health.services.vpn.error">
          <span class="detail-label">Fehler</span>
          <span class="detail-value text-red">{{ health.services.vpn.error }}</span>
        </div>
        <div class="detail-row" *ngIf="!health.services.vpn.connected">
          <span class="detail-label">Hinweis</span>
          <span class="detail-value text-yellow" style="font-size: 0.7rem;">VPN-Tunnel prüfen!</span>
        </div>
      </div>
    </div>

    <!-- PostgreSQL -->
    <div class="health-card" [class.healthy]="health.services.postgres.connected" [class.unhealthy]="!health.services.postgres.connected">
      <div class="card-header">
        <div class="card-icon-wrap postgres">
          <span class="material-symbols-outlined">database</span>
        </div>
        <div class="card-title">
          <h3>PostgreSQL</h3>
          <span class="card-subtitle">App-Datenbank</span>
        </div>
        <div class="status-dot" [class.online]="health.services.postgres.connected" [class.offline]="!health.services.postgres.connected">
          <span class="dot-pulse" *ngIf="health.services.postgres.connected"></span>
        </div>
      </div>
      <div class="card-details">
        <div class="detail-row">
          <span class="detail-label">Status</span>
          <span class="detail-value" [class.text-green]="health.services.postgres.connected" [class.text-red]="!health.services.postgres.connected">
            {{ health.services.postgres.connected ? 'Verbunden' : 'Getrennt' }}
          </span>
        </div>
        <div class="detail-row">
          <span class="detail-label">Host</span>
          <span class="detail-value mono">{{ health.services.postgres.host }}</span>
        </div>
        <div class="detail-row">
          <span class="detail-label">Datenbank</span>
          <span class="detail-value mono">{{ health.services.postgres.database }}</span>
        </div>
        <div class="detail-row" *ngIf="health.services.postgres.connected">
          <span class="detail-label">Latenz</span>
          <span class="detail-value">{{ health.services.postgres.latency }}ms</span>
        </div>
        <div class="detail-row error-row" *ngIf="health.services.postgres.error">
          <span class="detail-label">Fehler</span>
          <span class="detail-value text-red">{{ health.services.postgres.error }}</span>
        </div>
      </div>
    </div>

    <!-- MSSQL (WaWi) -->
    <div class="health-card" [class.healthy]="health.services.mssql.connected" [class.unhealthy]="!health.services.mssql.connected">
      <div class="card-header">
        <div class="card-icon-wrap mssql">
          <span class="material-symbols-outlined">lan</span>
        </div>
        <div class="card-title">
          <h3>MSSQL / WaWi</h3>
          <span class="card-subtitle">JTL-Wawi (Read-Only)</span>
        </div>
        <div class="status-dot" [class.online]="health.services.mssql.connected" [class.offline]="!health.services.mssql.connected">
          <span class="dot-pulse" *ngIf="health.services.mssql.connected"></span>
        </div>
      </div>
      <div class="card-details">
        <div class="detail-row">
          <span class="detail-label">Status</span>
          <span class="detail-value" [class.text-green]="health.services.mssql.connected" [class.text-red]="!health.services.mssql.connected">
            {{ health.services.mssql.connected ? 'Verbunden' : 'Getrennt' }}
          </span>
        </div>
        <div class="detail-row">
          <span class="detail-label">Host</span>
          <span class="detail-value mono">{{ health.services.mssql.host }}:{{ health.services.mssql.port }}</span>
        </div>
        <div class="detail-row">
          <span class="detail-label">Datenbank</span>
          <span class="detail-value mono">{{ health.services.mssql.database }}</span>
        </div>
        <div class="detail-row" *ngIf="health.services.mssql.connected">
          <span class="detail-label">Latenz</span>
          <span class="detail-value">{{ health.services.mssql.latency }}ms</span>
        </div>
        <div class="detail-row" *ngIf="health.services.mssql.reconnectAttempts">
          <span class="detail-label">Reconnects</span>
          <span class="detail-value text-yellow">{{ health.services.mssql.reconnectAttempts }}</span>
        </div>
        <div class="detail-row" *ngIf="health.services.mssql.lastHealthPing">
          <span class="detail-label">Letzter Ping</span>
          <span class="detail-value mono">{{ formatLastHealthPing() }}</span>
        </div>
        <div class="detail-row error-row" *ngIf="health.services.mssql.error">
          <span class="detail-label">Fehler</span>
          <span class="detail-value text-red">{{ health.services.mssql.error }}</span>
        </div>
      </div>
    </div>

    <!-- IMAP IDLE -->
    <div class="health-card"
         [class.healthy]="health.services.imapIdle.connected"
         [class.unhealthy]="!health.services.imapIdle.connected">
      <div class="card-header">
        <div class="card-icon-wrap imap">
          <span class="material-symbols-outlined">sync</span>
        </div>
        <div class="card-title">
          <h3>IMAP IDLE</h3>
          <span class="card-subtitle">Echtzeit-Posteingang</span>
        </div>
        <div class="status-dot"
             [class.online]="health.services.imapIdle.connected"
             [class.offline]="!health.services.imapIdle.connected">
          <span class="dot-pulse" *ngIf="health.services.imapIdle.connected"></span>
        </div>
      </div>
      <div class="card-details">
        <div class="detail-row">
          <span class="detail-label">Status</span>
          <span class="detail-value"
                [class.text-green]="health.services.imapIdle.connected"
                [class.text-red]="!health.services.imapIdle.connected">
            {{ health.services.imapIdle.connected ? 'Verbunden (IDLE)' : 'Getrennt' }}
          </span>
        </div>
        <div class="detail-row" *ngIf="health.services.imapIdle.folder">
          <span class="detail-label">Ordner</span>
          <span class="detail-value mono">{{ health.services.imapIdle.folder }}</span>
        </div>
        <div class="detail-row" *ngIf="health.services.imapIdle.reconnectAttempts">
          <span class="detail-label">Reconnects</span>
          <span class="detail-value text-yellow">{{ health.services.imapIdle.reconnectAttempts }}</span>
        </div>
        <div class="detail-row" *ngIf="!health.services.imapIdle.connected">
          <span class="detail-label">Hinweis</span>
          <span class="detail-value text-yellow" style="font-size: 0.7rem;">IMAP IDLE nicht aktiv — neue E-Mails werden nicht automatisch erkannt</span>
        </div>
      </div>
    </div>

    <!-- System / Backend -->
    <div class="health-card system-card healthy">
      <div class="card-header">
        <div class="card-icon-wrap system">
          <span class="material-symbols-outlined">memory</span>
        </div>
        <div class="card-title">
          <h3>Backend / Runtime</h3>
          <span class="card-subtitle">Node.js &amp; System</span>
        </div>
        <div class="status-dot online">
          <span class="dot-pulse"></span>
        </div>
      </div>
      <div class="card-details">
        <div class="detail-row">
          <span class="detail-label">Uptime</span>
          <span class="detail-value">{{ health.system.uptimeFormatted }}</span>
        </div>
        <div class="detail-row">
          <span class="detail-label">Node.js</span>
          <span class="detail-value mono">{{ health.system.nodeVersion }}</span>
        </div>
        <div class="detail-row">
          <span class="detail-label">Environment</span>
          <span class="detail-value">
            <span class="env-badge" [class]="health.system.env">{{ health.system.env }}</span>
          </span>
        </div>
        <div class="detail-row">
          <span class="detail-label">CPU</span>
          <span class="detail-value">
            {{ health.system.cpuPercent }}%
            <span class="memory-bar">
              <span class="memory-fill" [class]="getCpuColor()" [style.width.%]="health.system.cpuPercent"></span>
            </span>
          </span>
        </div>
        <div class="detail-row">
          <span class="detail-label">Heap</span>
          <span class="detail-value">
            {{ health.system.memoryMb.heapUsed }} / {{ health.system.memoryMb.heapTotal }} MB
            <span class="memory-bar">
              <span class="memory-fill" [class]="getMemoryColor()" [style.width.%]="getMemoryPercent()"></span>
            </span>
          </span>
        </div>
        <div class="detail-row">
          <span class="detail-label">RSS</span>
          <span class="detail-value">{{ health.system.memoryMb.rss }} MB</span>
        </div>
        <div class="detail-row">
          <span class="detail-label">CPU Kerne</span>
          <span class="detail-value mono">{{ health.system.cpuCores }}x</span>
        </div>
        <div class="detail-row">
          <span class="detail-label">Plattform</span>
          <span class="detail-value mono">{{ health.system.platform }}/{{ health.system.arch }}</span>
        </div>
      </div>
    </div>

    <!-- Host / OS -->
    <div class="health-card system-card healthy" *ngIf="health.system.os">
      <div class="card-header">
        <div class="card-icon-wrap host">
          <span class="material-symbols-outlined">dns</span>
        </div>
        <div class="card-title">
          <h3>Host / Server</h3>
          <span class="card-subtitle">{{ health.system.os.hostname }}</span>
        </div>
        <div class="status-dot online">
          <span class="dot-pulse"></span>
        </div>
      </div>
      <div class="card-details">
        <div class="detail-row">
          <span class="detail-label">OS Uptime</span>
          <span class="detail-value">{{ health.system.os.uptimeFormatted }}</span>
        </div>
        <div class="detail-row">
          <span class="detail-label">RAM gesamt</span>
          <span class="detail-value">{{ health.system.os.totalMemMb }} MB</span>
        </div>
        <div class="detail-row">
          <span class="detail-label">RAM belegt</span>
          <span class="detail-value">
            {{ health.system.os.usedMemMb }} MB ({{ getOsMemoryPercent() }}%)
            <span class="memory-bar">
              <span class="memory-fill" [class]="getOsMemoryPercent() > 85 ? 'red' : getOsMemoryPercent() > 65 ? 'yellow' : 'green'" [style.width.%]="getOsMemoryPercent()"></span>
            </span>
          </span>
        </div>
        <div class="detail-row">
          <span class="detail-label">RAM frei</span>
          <span class="detail-value">{{ health.system.os.freeMemMb }} MB</span>
        </div>
        <div class="detail-row">
          <span class="detail-label">CPU Model</span>
          <span class="detail-value mono" style="font-size: 0.65rem;">{{ health.system.cpuModel }}</span>
        </div>
      </div>
    </div>

  </div>

  <!-- Charts Section -->
  <div class="charts-section" *ngIf="health?.history?.length">
    <div class="charts-header">
      <h2>
        <span class="material-symbols-outlined">insights</span>
        Monitoring
      </h2>
      <div class="chart-tabs">
        <button class="chart-tab" [class.active]="activeChart === 'latency'" (click)="switchChart('latency')">
          <span class="material-symbols-outlined">speed</span>
          Latenz
        </button>
        <button class="chart-tab" [class.active]="activeChart === 'memory'" (click)="switchChart('memory')">
          <span class="material-symbols-outlined">memory</span>
          Memory
        </button>
        <button class="chart-tab" [class.active]="activeChart === 'cpu'" (click)="switchChart('cpu')">
          <span class="material-symbols-outlined">developer_board</span>
          CPU
        </button>
        <button class="chart-tab" [class.active]="activeChart === 'uptime'" (click)="switchChart('uptime')">
          <span class="material-symbols-outlined">timeline</span>
          Verfügbarkeit
        </button>
      </div>
      <span class="chart-hint">{{ health.history.length }} Datenpunkte</span>
    </div>
    <div class="chart-container">
      <canvas #latencyCanvas class="chart-canvas" *ngIf="activeChart === 'latency'"></canvas>
      <canvas #memoryCanvas class="chart-canvas" *ngIf="activeChart === 'memory'"></canvas>
      <canvas #cpuCanvas class="chart-canvas" *ngIf="activeChart === 'cpu'"></canvas>
      <canvas #uptimeCanvas class="chart-canvas" *ngIf="activeChart === 'uptime'"></canvas>
      <div class="chart-empty" *ngIf="!health.history.length">
        <span class="material-symbols-outlined">analytics</span>
        <p>Noch keine Verlaufsdaten — werden nach mehreren Health-Checks verfügbar</p>
      </div>
    </div>
  </div>

  <!-- Database Management -->
  <div class="db-management-section" *ngIf="health">
    <div class="section-header">
      <h2>
        <span class="material-symbols-outlined">database</span>
        Datenbank-Verwaltung
      </h2>
      <span class="section-hint">E-Mail Datenbank bereinigen</span>
    </div>

    <!-- Confirmation Dialog -->
    <div class="confirm-overlay" *ngIf="confirmAction" (click)="cancelClear()">
      <div class="confirm-dialog" (click)="$event.stopPropagation()">
        <span class="material-symbols-outlined confirm-icon">warning</span>
        <h3>Wirklich löschen?</h3>
        <p *ngIf="confirmAction === 'all'">Alle E-Mails werden unwiderruflich aus der Datenbank gelöscht.</p>
        <p *ngIf="confirmAction === 'inbox'">Alle Inbox-E-Mails werden gelöscht.</p>
        <p *ngIf="confirmAction === 'sent'">Alle gesendeten E-Mails werden gelöscht.</p>
        <p *ngIf="confirmAction === 'trash'">Alle Papierkorb-E-Mails werden gelöscht.</p>
        <p *ngIf="confirmAction === 'ai'">AI-Analyse-Daten aller E-Mails werden zurückgesetzt. Die E-Mails selbst bleiben erhalten.</p>
        <div class="confirm-actions">
          <button class="btn-cancel" (click)="cancelClear()">Abbrechen</button>
          <button class="btn-confirm-delete" (click)="confirmClear()">
            <span class="material-symbols-outlined">delete_forever</span>
            Ja, löschen
          </button>
        </div>
      </div>
    </div>

    <!-- Success/Error Message -->
    <div class="db-message" *ngIf="dbMessage" [class.success]="dbMessageType === 'success'" [class.error]="dbMessageType === 'error'">
      <span class="material-symbols-outlined">{{ dbMessageType === 'success' ? 'check_circle' : 'error' }}</span>
      {{ dbMessage }}
    </div>

    <div class="db-actions-grid">
      <button class="db-action-btn danger" (click)="requestClear('all')" [disabled]="dbClearing !== ''">
        <span class="material-symbols-outlined" [class.spinning]="dbClearing === 'all'">{{ dbClearing === 'all' ? 'progress_activity' : 'delete_sweep' }}</span>
        <div class="btn-text">
          <span class="btn-label">Alle E-Mails löschen</span>
          <span class="btn-desc">Inbox + Sent + Trash</span>
        </div>
      </button>

      <button class="db-action-btn warning" (click)="requestClear('inbox')" [disabled]="dbClearing !== ''">
        <span class="material-symbols-outlined" [class.spinning]="dbClearing === 'inbox'">{{ dbClearing === 'inbox' ? 'progress_activity' : 'inbox' }}</span>
        <div class="btn-text">
          <span class="btn-label">Inbox leeren</span>
          <span class="btn-desc">Nur Inbox-Mails</span>
        </div>
      </button>

      <button class="db-action-btn warning" (click)="requestClear('sent')" [disabled]="dbClearing !== ''">
        <span class="material-symbols-outlined" [class.spinning]="dbClearing === 'sent'">{{ dbClearing === 'sent' ? 'progress_activity' : 'send' }}</span>
        <div class="btn-text">
          <span class="btn-label">Sent leeren</span>
          <span class="btn-desc">Nur gesendete Mails</span>
        </div>
      </button>

      <button class="db-action-btn warning" (click)="requestClear('trash')" [disabled]="dbClearing !== ''">
        <span class="material-symbols-outlined" [class.spinning]="dbClearing === 'trash'">{{ dbClearing === 'trash' ? 'progress_activity' : 'delete' }}</span>
        <div class="btn-text">
          <span class="btn-label">Papierkorb leeren</span>
          <span class="btn-desc">Nur Papierkorb-Mails</span>
        </div>
      </button>

      <button class="db-action-btn info" (click)="requestClear('ai')" [disabled]="dbClearing !== ''">
        <span class="material-symbols-outlined" [class.spinning]="dbClearing === 'ai'">{{ dbClearing === 'ai' ? 'progress_activity' : 'psychology' }}</span>
        <div class="btn-text">
          <span class="btn-label">AI-Daten zurücksetzen</span>
          <span class="btn-desc">E-Mails bleiben, AI neu anlysieren</span>
        </div>
      </button>
    </div>
  </div>

  <!-- Response Time -->
  <div class="response-row" *ngIf="health">
    <span class="material-symbols-outlined">speed</span>
    Health-Check in <strong>{{ health.totalLatency }}ms</strong> abgeschlossen
    <span class="auto-refresh-hint">Auto-Refresh alle 30s</span>
  </div>

  </div><!-- /health-content -->

</section>
</app-admin-layout>
