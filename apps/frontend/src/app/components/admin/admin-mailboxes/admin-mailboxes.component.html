<app-admin-layout>
  <div class="admin-page">

    <!-- ═══════════ PAGE HEADER ═══════════ -->
    <div class="admin-page-header">
      <div class="admin-page-header__left">
        <h1 class="admin-page-title">
          <span class="material-symbols-outlined ms-fill">mail</span>
          Postfächer
        </h1>
        <p class="admin-page-subtitle">IMAP/SMTP-Postfächer verwalten, Benutzer zuweisen und Signaturen konfigurieren.
        </p>
      </div>
      <button class="admin-btn admin-btn--primary" (click)="openCreateModal()">
        <span class="material-symbols-outlined ms-size-20">add</span>
        Neues Postfach
      </button>
    </div>

    <!-- ═══════════ STATS ═══════════ -->
    <div class="admin-stats-row" *ngIf="!loading && mailboxes.length > 0">
      <div class="admin-stat-chip">
        <span class="material-symbols-outlined ms-size-18">inbox</span>
        <strong>{{ mailboxes.length }}</strong> Postfächer
      </div>
      <div class="admin-stat-chip admin-stat-chip--success">
        <span class="material-symbols-outlined ms-size-18">check_circle</span>
        <strong>{{ activeCount }}</strong> Aktiv
      </div>
      <div class="admin-stat-chip admin-stat-chip--warning" *ngIf="inactiveCount > 0">
        <span class="material-symbols-outlined ms-size-18">pause_circle</span>
        <strong>{{ inactiveCount }}</strong> Inaktiv
      </div>
    </div>

    <!-- ═══════════ LOADING ═══════════ -->
    <div class="admin-loading-state" *ngIf="loading">
      <span class="admin-spinner"></span>
      <span>Postfächer werden geladen...</span>
    </div>

    <!-- ═══════════ ERROR ═══════════ -->
    <div class="admin-error-state" *ngIf="error && !loading">
      <span class="material-symbols-outlined ms-size-40">error</span>
      <h3>Fehler beim Laden</h3>
      <p>{{ error }}</p>
      <button class="admin-btn admin-btn--secondary" (click)="loadMailboxes()">
        <span class="material-symbols-outlined ms-size-18">refresh</span>
        Erneut versuchen
      </button>
    </div>

    <!-- ═══════════ EMPTY STATE ═══════════ -->
    <div class="admin-empty-state" *ngIf="!loading && !error && mailboxes.length === 0">
      <span class="material-symbols-outlined ms-size-48 empty-icon">inbox</span>
      <h3>Keine Postfächer vorhanden</h3>
      <p>Erstelle dein erstes IMAP/SMTP-Postfach, um E-Mails empfangen und senden zu können.</p>
      <button class="admin-btn admin-btn--primary" (click)="openCreateModal()">
        <span class="material-symbols-outlined ms-size-20">add</span>
        Erstes Postfach erstellen
      </button>
    </div>

    <!-- ═══════════ MAILBOX CARDS ═══════════ -->
    <div class="mailbox-grid" *ngIf="!loading && mailboxes.length > 0">
      <div class="mailbox-card" *ngFor="let mb of mailboxes; let i = index" [style.--accent]="mb.color || '#3b82f6'"
        [style.animation-delay]="i * 0.04 + 's'" [class.mailbox-card--inactive]="!mb.isActive">

        <!-- Color accent bar -->
        <div class="mailbox-card__accent" [style.background]="mb.color || '#3b82f6'"></div>

        <div class="mailbox-card__content">
          <!-- Header: Name + Status -->
          <div class="mailbox-card__header">
            <div class="mailbox-card__identity">
              <div class="mailbox-card__icon" [style.background]="mb.color || '#3b82f6'">
                <span class="material-symbols-outlined ms-fill ms-size-20">mail</span>
              </div>
              <div>
                <h3 class="mailbox-card__name">{{ mb.name }}</h3>
                <span class="mailbox-card__email">{{ mb.email }}</span>
              </div>
            </div>
            <span class="admin-badge" [class.admin-badge--success]="mb.isActive"
              [class.admin-badge--error]="!mb.isActive">
              <span class="admin-status-dot" [class.admin-status-dot--active]="mb.isActive"
                [class.admin-status-dot--error]="!mb.isActive"></span>
              {{ mb.isActive ? 'Aktiv' : 'Inaktiv' }}
            </span>
          </div>

          <!-- ── Server Section ── -->
          <div class="mailbox-card__section">
            <div class="section-title">
              <span class="material-symbols-outlined ms-size-14">dns</span>
              Server
            </div>
            <div class="mailbox-card__info">
              <div class="info-item">
                <span class="material-symbols-outlined ms-size-16">download</span>
                <span class="info-label">IMAP</span>
                <span class="info-value" [title]="mb.imapHost + ':' + mb.imapPort">{{ mb.imapHost }}:{{ mb.imapPort }}</span>
              </div>
              <div class="info-item">
                <span class="material-symbols-outlined ms-size-16">upload</span>
                <span class="info-label">SMTP</span>
                <span class="info-value" [title]="mb.smtpHost + ':' + mb.smtpPort">{{ mb.smtpHost }}:{{ mb.smtpPort }}</span>
              </div>
              <div class="info-item">
                <span class="material-symbols-outlined ms-size-16">lock</span>
                <span class="info-label">IMAP TLS</span>
                <span class="info-value" [class.info-value--on]="mb.imapTls" [class.info-value--off]="!mb.imapTls">
                  {{ mb.imapTls ? 'Ja' : 'Nein' }}
                </span>
              </div>
              <div class="info-item">
                <span class="material-symbols-outlined ms-size-16">lock</span>
                <span class="info-label">SMTP SSL</span>
                <span class="info-value" [class.info-value--on]="mb.smtpSecure" [class.info-value--off]="!mb.smtpSecure">
                  {{ mb.smtpSecure ? 'Ja' : 'Nein' }}
                </span>
              </div>
            </div>
          </div>

          <!-- ── Folders Section ── -->
          <div class="mailbox-card__section">
            <div class="section-title">
              <span class="material-symbols-outlined ms-size-14">folder_open</span>
              Ordner
            </div>
            <div class="mailbox-card__info">
              <div class="info-item">
                <span class="material-symbols-outlined ms-size-16">inbox</span>
                <span class="info-label">Eingang</span>
                <span class="info-value" [title]="mb.imapSourceFolder || 'INBOX'">{{ mb.imapSourceFolder || 'INBOX' }}</span>
              </div>
              <div class="info-item">
                <span class="material-symbols-outlined ms-size-16">send</span>
                <span class="info-label">Gesendet</span>
                <span class="info-value" [title]="mb.imapSentFolder || 'Sent'">{{ mb.imapSentFolder || 'Sent' }}</span>
              </div>
              <div class="info-item" *ngIf="mb.imapDoneFolder">
                <span class="material-symbols-outlined ms-size-16">task_alt</span>
                <span class="info-label">Erledigt</span>
                <span class="info-value" [title]="mb.imapDoneFolder">{{ mb.imapDoneFolder }}</span>
              </div>
              <div class="info-item" *ngIf="mb.imapTrashFolder">
                <span class="material-symbols-outlined ms-size-16">delete</span>
                <span class="info-label">Papierkorb</span>
                <span class="info-value" [title]="mb.imapTrashFolder">{{ mb.imapTrashFolder }}</span>
              </div>
            </div>
          </div>

          <!-- ── Company Section ── -->
          <div class="mailbox-card__section" *ngIf="mb.companyName || mb.companyPhone || mb.companyWebsite || mb.companyAddress">
            <div class="section-title">
              <span class="material-symbols-outlined ms-size-14">business</span>
              Firma
            </div>
            <div class="mailbox-card__info">
              <div class="info-item" *ngIf="mb.companyName">
                <span class="material-symbols-outlined ms-size-16">badge</span>
                <span class="info-label">Name</span>
                <span class="info-value" [title]="mb.companyName">{{ mb.companyName }}</span>
              </div>
              <div class="info-item" *ngIf="mb.companyPhone">
                <span class="material-symbols-outlined ms-size-16">call</span>
                <span class="info-label">Telefon</span>
                <span class="info-value" [title]="mb.companyPhone">{{ mb.companyPhone }}</span>
              </div>
              <div class="info-item" *ngIf="mb.companyWebsite">
                <span class="material-symbols-outlined ms-size-16">language</span>
                <span class="info-label">Website</span>
                <span class="info-value" [title]="mb.companyWebsite">{{ mb.companyWebsite }}</span>
              </div>
              <div class="info-item info-item--full" *ngIf="mb.companyAddress">
                <span class="material-symbols-outlined ms-size-16">location_on</span>
                <span class="info-label">Adresse</span>
                <span class="info-value" [title]="mb.companyAddress">{{ mb.companyAddress }}</span>
              </div>
            </div>
          </div>

          <!-- ── Spam & Signature chips ── -->
          <div class="mailbox-card__chips">
            <span class="info-chip" *ngIf="mb.spamScanIntervalMinutes"
              [title]="'Spam-Scan alle ' + mb.spamScanIntervalMinutes + ' Minuten'">
              <span class="material-symbols-outlined ms-size-14">shield</span>
              Spam alle {{ mb.spamScanIntervalMinutes }} min
            </span>
            <span class="info-chip" *ngIf="mb.spamAutoDeleteCategories?.length"
              [title]="'Auto-Löschen: ' + mb.spamAutoDeleteCategories!.join(', ')">
              <span class="material-symbols-outlined ms-size-14">auto_delete</span>
              {{ mb.spamAutoDeleteCategories!.length }} Auto-Lösch-Kat.
            </span>
            <span class="info-chip info-chip--signature" *ngIf="mb.signatureTemplate">
              <span class="material-symbols-outlined ms-size-14">draw</span>
              Signatur
            </span>
            <span class="info-chip info-chip--no-signature" *ngIf="!mb.signatureTemplate">
              <span class="material-symbols-outlined ms-size-14">block</span>
              Keine Signatur
            </span>
          </div>

          <!-- ── Footer meta ── -->
          <div class="mailbox-card__meta">
            <div class="meta-item" *ngIf="mailboxUserCounts[mb.id] !== undefined">
              <span class="material-symbols-outlined ms-size-14">group</span>
              {{ mailboxUserCounts[mb.id] }} Benutzer
            </div>
            <div class="meta-item" *ngIf="mb.createdAt">
              <span class="material-symbols-outlined ms-size-14">schedule</span>
              {{ mb.createdAt | date:'dd.MM.yyyy' }}
            </div>
          </div>

          <!-- Actions -->
          <div class="mailbox-card__actions">
            <button class="admin-btn admin-btn--ghost admin-btn--sm" (click)="openAssignModal(mb)"
              title="Benutzer zuweisen">
              <span class="material-symbols-outlined ms-size-18">group_add</span>
              Benutzer
            </button>
            <div class="mailbox-card__actions-right">
              <button class="admin-btn admin-btn--icon admin-btn--sm" (click)="testConnectionForMailbox(mb)"
                title="Verbindung testen" [disabled]="testing">
                <span class="material-symbols-outlined ms-size-18" [class.spin]="testing">{{ testing ?
                  'progress_activity' : 'cable' }}</span>
              </button>
              <button class="admin-btn admin-btn--icon admin-btn--sm" (click)="openEditModal(mb)" title="Bearbeiten">
                <span class="material-symbols-outlined ms-size-18">edit</span>
              </button>
              <button class="admin-btn admin-btn--icon admin-btn--sm" (click)="toggleActive(mb)"
                [title]="mb.isActive ? 'Deaktivieren' : 'Aktivieren'" [class.toggle-active]="mb.isActive">
                <span class="material-symbols-outlined ms-size-18">{{ mb.isActive ? 'toggle_on' : 'toggle_off' }}</span>
              </button>
              <button class="admin-btn admin-btn--icon admin-btn--sm btn-delete" (click)="deleteMailbox(mb)"
                title="Löschen">
                <span class="material-symbols-outlined ms-size-18">delete</span>
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ═══════════════════════════════════════════════════════════
       CREATE / EDIT MODAL
       ═══════════════════════════════════════════════════════════ -->
  <div class="admin-modal-overlay" *ngIf="showModal">
    <div class="admin-modal admin-modal--lg">

      <div class="admin-modal-header">
        <h2>
          <span class="material-symbols-outlined">{{ editingMailbox ? 'edit' : 'add_circle' }}</span>
          {{ editingMailbox ? 'Postfach bearbeiten' : 'Neues Postfach erstellen' }}
        </h2>
        <button class="close-btn" (click)="closeModal()">
          <span class="material-symbols-outlined">close</span>
        </button>
      </div>

      <div class="admin-modal-body">
        <!-- Tab Navigation -->
        <div class="form-tabs">
          <button class="form-tab" [class.active]="activeFormTab === 'basic'" (click)="activeFormTab = 'basic'">
            <span class="material-symbols-outlined ms-size-18">info</span>
            Grunddaten
          </button>
          <button class="form-tab" [class.active]="activeFormTab === 'imap'" (click)="activeFormTab = 'imap'">
            <span class="material-symbols-outlined ms-size-18">download</span>
            IMAP
          </button>
          <button class="form-tab" [class.active]="activeFormTab === 'smtp'" (click)="activeFormTab = 'smtp'">
            <span class="material-symbols-outlined ms-size-18">upload</span>
            SMTP
          </button>
          <button class="form-tab" [class.active]="activeFormTab === 'spamkiller'" (click)="activeFormTab = 'spamkiller'">
            <span class="material-symbols-outlined ms-size-18">shield</span>
            Spam Killer
          </button>
          <button class="form-tab" [class.active]="activeFormTab === 'company'" (click)="activeFormTab = 'company'">
            <span class="material-symbols-outlined ms-size-18">business</span>
            Firma
          </button>
          <button class="form-tab" [class.active]="activeFormTab === 'signature'" (click)="activeFormTab = 'signature'">
            <span class="material-symbols-outlined ms-size-18">draw</span>
            Signatur
          </button>
        </div>

        <form class="mailbox-form" (ngSubmit)="saveMailbox()">

          <!-- TAB: Basic Info -->
          <div class="form-section" *ngIf="activeFormTab === 'basic'">
            <div class="form-row two-col">
              <div class="admin-form-group">
                <label class="admin-form-group__label">Name <span class="required">*</span></label>
                <input class="admin-input" type="text" [(ngModel)]="form.name" name="name"
                  placeholder="z.B. Support Postfach" />
              </div>
              <div class="admin-form-group">
                <label class="admin-form-group__label">E-Mail-Adresse <span class="required">*</span></label>
                <input class="admin-input" type="email" [(ngModel)]="form.email" name="email"
                  placeholder="z.B. support@firma.de" />
              </div>
            </div>
            <div class="form-row two-col">
              <div class="admin-form-group">
                <label class="admin-form-group__label">
                  {{ editingMailbox ? 'Neues Passwort' : 'Passwort' }}
                  <span class="required" *ngIf="!editingMailbox">*</span>
                </label>
                <div class="password-input-wrapper">
                  <input class="admin-input" [type]="showPassword ? 'text' : 'password'" [(ngModel)]="form.password"
                    name="password"
                    [placeholder]="editingMailbox ? 'Leer lassen = Passwort bleibt unverändert' : '••••••••'" />
                  <button type="button" class="password-toggle-btn" (click)="showPassword = !showPassword"
                    tabindex="-1">
                    <span class="material-symbols-outlined ms-size-20">{{ showPassword ? 'visibility_off' : 'visibility'
                      }}</span>
                  </button>
                </div>
              </div>
              <div class="admin-form-group">
                <label class="admin-form-group__label">Erkennungsfarbe</label>
                <div class="color-picker-row">
                  <input type="color" class="color-input" [(ngModel)]="form.color" name="color" />
                  <span class="color-hex">{{ form.color }}</span>
                  <div class="color-presets">
                    <button type="button" *ngFor="let c of colorPresets" class="color-dot" [style.background]="c"
                      [class.active]="form.color === c" (click)="form.color = c" [title]="c"></button>
                  </div>
                </div>
              </div>
            </div>
            <div class="form-row" *ngIf="editingMailbox">
              <div class="admin-form-group">
                <div class="switch-group">
                  <label class="switch">
                    <input type="checkbox" [(ngModel)]="form.isActive" name="isActive" />
                    <span class="slider"></span>
                  </label>
                  <span class="switch-group__label">Postfach aktiv</span>
                </div>
              </div>
            </div>
          </div>

          <!-- TAB: IMAP -->
          <div class="form-section" *ngIf="activeFormTab === 'imap'">
            <div class="section-info">
              <span class="material-symbols-outlined">info</span>
              IMAP wird zum Empfangen von E-Mails verwendet.
            </div>
            <div class="form-row three-col">
              <div class="admin-form-group" style="flex: 2">
                <label class="admin-form-group__label">IMAP Host <span class="required">*</span></label>
                <input class="admin-input" type="text" [(ngModel)]="form.imapHost" name="imapHost"
                  placeholder="z.B. imap.provider.de" />
              </div>
              <div class="admin-form-group">
                <label class="admin-form-group__label">Port</label>
                <input class="admin-input" type="number" [(ngModel)]="form.imapPort" name="imapPort" />
              </div>
              <div class="admin-form-group">
                <label class="admin-form-group__label">Verschlüsselung</label>
                <div class="switch-group" style="margin-top: 4px">
                  <label class="switch">
                    <input type="checkbox" [(ngModel)]="form.imapTls" name="imapTls" />
                    <span class="slider"></span>
                  </label>
                  <span class="switch-group__label">TLS</span>
                </div>
              </div>
            </div>

            <hr class="form-divider" />
            <h4 class="form-section-title">IMAP-Ordner</h4>

            <div class="form-row two-col">
              <div class="admin-form-group">
                <label class="admin-form-group__label">Quell-Ordner</label>
                <input class="admin-input" type="text" [(ngModel)]="form.imapSourceFolder" name="imapSourceFolder"
                  placeholder="INBOX" />
              </div>
              <div class="admin-form-group">
                <label class="admin-form-group__label">Gesendet-Ordner</label>
                <input class="admin-input" type="text" [(ngModel)]="form.imapSentFolder" name="imapSentFolder"
                  placeholder="Sent" />
              </div>
            </div>

          </div>

          <!-- TAB: Spam Killer -->
          <div class="form-section" *ngIf="activeFormTab === 'spamkiller'">
            <div class="section-info">
              <span class="material-symbols-outlined">info</span>
              Lege fest, wie oft der Spam Killer automatisch nach neuen E-Mails sucht. Leer oder 0 = deaktiviert (manuell durch User).
            </div>
            <div class="form-row two-col">
              <div class="admin-form-group">
                <label class="admin-form-group__label">Auto-Scan Intervall (Minuten)</label>
                <input class="admin-input" type="number" [(ngModel)]="form.spamScanIntervalMinutes" name="spamScanIntervalMinutes"
                  placeholder="z.B. 60 (leer = deaktiviert)" min="0" />
              </div>
              <div class="admin-form-group">
                <label class="admin-form-group__label">Status</label>
                <div class="spam-scan-status" style="margin-top: 4px">
                  <span class="admin-badge" [class.admin-badge--success]="form.spamScanIntervalMinutes && form.spamScanIntervalMinutes > 0"
                    [class.admin-badge--warning]="!form.spamScanIntervalMinutes || form.spamScanIntervalMinutes === 0">
                    <span class="admin-status-dot" [class.admin-status-dot--active]="form.spamScanIntervalMinutes && form.spamScanIntervalMinutes > 0"
                      [class.admin-status-dot--error]="!form.spamScanIntervalMinutes || form.spamScanIntervalMinutes === 0"></span>
                    {{ form.spamScanIntervalMinutes && form.spamScanIntervalMinutes > 0 ? ('Alle ' + form.spamScanIntervalMinutes + ' Min.') : 'Deaktiviert (manuell)' }}
                  </span>
                </div>
              </div>
            </div>

            <hr class="form-divider" />
            <h4 class="form-section-title">
              <span class="material-symbols-outlined ms-size-18">category</span>
              Kategorie-Zuordnung
            </h4>

            <!-- Spam Kategorie-Zuordnung -->
            <div class="section-info">
              <span class="material-symbols-outlined">info</span>
              Ordne die Kategorien zu: <strong>Nachfragen</strong> zeigt E-Mails im Spam Killer zur manuellen Prüfung an. <strong>Auto Löschen</strong> entfernt E-Mails dieser Kategorien automatisch.
            </div>
            <div class="spam-category-columns">
              <!-- Nachfragen (manual review) -->
              <div class="spam-category-column spam-category-column--inquiry">
                <div class="spam-category-column__header">
                  <span class="material-symbols-outlined" style="color: #f59e0b; font-size: 20px;">visibility</span>
                  <span>Nachfragen</span>
                  <span class="spam-category-column__count">{{ inquiryCategories.length }}</span>
                </div>
                <div class="spam-category-column__list">
                  <div class="spam-category-chip spam-category-chip--review"
                    *ngFor="let cat of inquiryCategories"
                    (click)="moveToAutoDelete(cat.key)">
                    <span class="material-symbols-outlined spam-category-chip__icon" [style.color]="cat.color">{{ cat.icon }}</span>
                    <span class="spam-category-chip__label">{{ cat.label }}</span>
                    <span class="spam-category-chip__action" title="Zu Auto Löschen verschieben">
                      <span class="material-symbols-outlined" style="color: #94a3b8; font-size: 16px;">arrow_forward</span>
                    </span>
                  </div>
                  <div class="spam-category-column__empty" *ngIf="inquiryCategories.length === 0">
                    <span class="material-symbols-outlined" style="font-size: 28px; color: #cbd5e1;">inbox</span>
                    <span>Keine Kategorien</span>
                  </div>
                </div>
              </div>

              <!-- Auto Löschen -->
              <div class="spam-category-column spam-category-column--delete">
                <div class="spam-category-column__header">
                  <span class="material-symbols-outlined" style="color: #dc2626; font-size: 20px;">delete_forever</span>
                  <span>Auto Löschen</span>
                  <span class="spam-category-column__count spam-category-column__count--danger">{{ autoDeleteCategories.length }}</span>
                </div>
                <div class="spam-category-column__list">
                  <div class="spam-category-chip spam-category-chip--active"
                    *ngFor="let cat of autoDeleteCategories"
                    (click)="moveToInquiry(cat.key)">
                    <span class="material-symbols-outlined spam-category-chip__icon" [style.color]="cat.color">{{ cat.icon }}</span>
                    <span class="spam-category-chip__label">{{ cat.label }}</span>
                    <span class="spam-category-chip__action" title="Zu Nachfragen verschieben">
                      <span class="material-symbols-outlined" style="color: #94a3b8; font-size: 16px;">arrow_back</span>
                    </span>
                  </div>
                  <div class="spam-category-column__empty" *ngIf="autoDeleteCategories.length === 0">
                    <span class="material-symbols-outlined" style="font-size: 28px; color: #cbd5e1;">delete_outline</span>
                    <span>Keine Kategorien</span>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- TAB: SMTP -->
          <div class="form-section" *ngIf="activeFormTab === 'smtp'">
            <div class="section-info">
              <span class="material-symbols-outlined">info</span>
              SMTP wird zum Versenden von E-Mails verwendet.
            </div>
            <div class="form-row three-col">
              <div class="admin-form-group" style="flex: 2">
                <label class="admin-form-group__label">SMTP Host <span class="required">*</span></label>
                <input class="admin-input" type="text" [(ngModel)]="form.smtpHost" name="smtpHost"
                  placeholder="z.B. smtp.provider.de" />
              </div>
              <div class="admin-form-group">
                <label class="admin-form-group__label">Port</label>
                <input class="admin-input" type="number" [(ngModel)]="form.smtpPort" name="smtpPort" />
              </div>
              <div class="admin-form-group">
                <label class="admin-form-group__label">Verschlüsselung</label>
                <div class="switch-group" style="margin-top: 4px">
                  <label class="switch">
                    <input type="checkbox" [(ngModel)]="form.smtpSecure" name="smtpSecure" />
                    <span class="slider"></span>
                  </label>
                  <span class="switch-group__label">SSL/TLS</span>
                </div>
              </div>
            </div>
          </div>

          <!-- TAB: Company -->
          <div class="form-section" *ngIf="activeFormTab === 'company'">
            <div class="section-info">
              <span class="material-symbols-outlined">info</span>
              Firmendaten werden als Platzhalter in der E-Mail-Signatur verwendet.
            </div>
            <div class="form-row two-col">
              <div class="admin-form-group">
                <label class="admin-form-group__label">Firmenname</label>
                <input class="admin-input" type="text" [(ngModel)]="form.companyName" name="companyName"
                  placeholder="z.B. Meine Firma GmbH" />
              </div>
              <div class="admin-form-group">
                <label class="admin-form-group__label">Telefon</label>
                <input class="admin-input" type="text" [(ngModel)]="form.companyPhone" name="companyPhone"
                  placeholder="z.B. +49 123 456789" />
              </div>
            </div>
            <div class="form-row two-col">
              <div class="admin-form-group">
                <label class="admin-form-group__label">Website</label>
                <input class="admin-input" type="text" [(ngModel)]="form.companyWebsite" name="companyWebsite"
                  placeholder="z.B. www.firma.de" />
              </div>
              <div class="admin-form-group">
                <label class="admin-form-group__label">Adresse</label>
                <input class="admin-input" type="text" [(ngModel)]="form.companyAddress" name="companyAddress"
                  placeholder="z.B. Musterstr. 1, 12345 Stadt" />
              </div>
            </div>
          </div>

          <!-- TAB: Signature -->
          <div class="form-section" *ngIf="activeFormTab === 'signature'">
            <div class="section-info">
              <span class="material-symbols-outlined">info</span>
              HTML-Signaturvorlage. Platzhalter werden beim Versenden automatisch ersetzt.
            </div>

            <div class="placeholder-chips">
              <span class="placeholder-chip" *ngFor="let p of placeholders" (click)="insertPlaceholder(p.key)"
                [title]="'Klicken zum Einfügen: ' + p.key">
                <code>{{ p.key }}</code>
                <span class="placeholder-desc">{{ p.label }}</span>
              </span>
            </div>

            <div class="signature-toolbar">
              <button type="button" class="admin-btn admin-btn--sm" [class.admin-btn--primary]="showSignaturePreview"
                [class.admin-btn--ghost]="!showSignaturePreview" (click)="showSignaturePreview = !showSignaturePreview">
                <span class="material-symbols-outlined ms-size-18">{{ showSignaturePreview ? 'code' : 'preview'
                  }}</span>
                {{ showSignaturePreview ? 'HTML bearbeiten' : 'Vorschau' }}
              </button>
            </div>

            <textarea *ngIf="!showSignaturePreview" [(ngModel)]="form.signatureTemplate" name="signatureTemplate"
              rows="14" class="admin-textarea code-editor"
              placeholder="HTML-Signatur mit Platzhaltern eingeben..."></textarea>


            <div *ngIf="showSignaturePreview" class="signature-preview">
              <div class="signature-preview__label">Vorschau mit Beispieldaten</div>
              <div class="signature-preview__content" [innerHTML]="signaturePreviewHtml"></div>
            </div>
            <button type="button" class="admin-btn admin-btn--ghost admin-btn--sm" (click)="generateDefaultSignature()">
              <span class="material-symbols-outlined ms-size-18">auto_awesome</span>
              Standard generieren
            </button>
          </div>
        </form>
      </div>

      <div class="admin-modal-footer">
        <div class="modal-footer-left">
          <button type="button" class="admin-btn admin-btn--ghost admin-btn--sm" *ngIf="canGoPrev" (click)="prevTab()">
            <span class="material-symbols-outlined ms-size-18">arrow_back</span>
            Zurück
          </button>
          <button type="button" class="admin-btn admin-btn--outline admin-btn--sm test-connection-btn"
            (click)="testConnectionFromForm()"
            [disabled]="testing || !form.email || !form.imapHost || !form.smtpHost || (!form.password && !editingMailbox)">
            <span class="material-symbols-outlined ms-size-18" [class.spin]="testing">{{ testing ? 'progress_activity' :
              'cable' }}</span>
            {{ testing ? 'Teste...' : 'Verbindung testen' }}
          </button>
        </div>

        <!-- Connection Test Results (inline) -->
        <div class="connection-test-results" *ngIf="testResult">
          <span class="test-result-chip" [class.success]="testResult.imap.success"
            [class.error]="!testResult.imap.success" [title]="testResult.imap.message">
            <span class="material-symbols-outlined ms-size-16">{{ testResult.imap.success ? 'check_circle' : 'cancel'
              }}</span>
            IMAP <span class="test-duration">{{ testResult.imap.durationMs }}ms</span>
          </span>
          <span class="test-result-chip" [class.success]="testResult.smtp.success"
            [class.error]="!testResult.smtp.success" [title]="testResult.smtp.message">
            <span class="material-symbols-outlined ms-size-16">{{ testResult.smtp.success ? 'check_circle' : 'cancel'
              }}</span>
            SMTP <span class="test-duration">{{ testResult.smtp.durationMs }}ms</span>
          </span>
        </div>

        <!-- Detailed error messages -->
        <div class="test-error-details" *ngIf="testResult && (!testResult.imap.success || !testResult.smtp.success)">
          <div class="test-error-line" *ngIf="!testResult.imap.success">
            <strong>IMAP:</strong> {{ testResult.imap.message }}
          </div>
          <div class="test-error-line" *ngIf="!testResult.smtp.success">
            <strong>SMTP:</strong> {{ testResult.smtp.message }}
          </div>
        </div>

        <div class="modal-footer-right">
          <button class="admin-btn admin-btn--ghost" (click)="closeModal()" [disabled]="saving">Abbrechen</button>
          <button *ngIf="canGoNext" type="button" class="admin-btn admin-btn--secondary" (click)="nextTab()">
            Weiter
            <span class="material-symbols-outlined ms-size-18">arrow_forward</span>
          </button>
          <button class="admin-btn admin-btn--primary" (click)="saveMailbox()" [disabled]="saving || !formValid">
            <span class="admin-spinner admin-spinner--sm" *ngIf="saving"></span>
            {{ saving ? 'Speichern...' : (editingMailbox ? 'Speichern' : 'Postfach erstellen') }}
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- ═══════════════════════════════════════════════════════════
       USER ASSIGNMENT MODAL
       ═══════════════════════════════════════════════════════════ -->
  <div class="admin-modal-overlay" *ngIf="showAssignModal">
    <div class="admin-modal">

      <div class="admin-modal-header">
        <h2>
          <span class="material-symbols-outlined">group_add</span>
          Benutzer zuweisen
        </h2>
        <button class="close-btn" (click)="closeAssignModal()">
          <span class="material-symbols-outlined">close</span>
        </button>
      </div>

      <div class="assign-mailbox-info" *ngIf="assignMailbox">
        <div class="assign-mailbox-badge" [style.background]="assignMailbox.color || '#3b82f6'">
          <span class="material-symbols-outlined ms-fill ms-size-18">mail</span>
        </div>
        <div>
          <strong>{{ assignMailbox.name }}</strong>
          <span class="assign-mailbox-email">{{ assignMailbox.email }}</span>
        </div>
      </div>

      <div class="admin-modal-body">
        <div class="admin-loading-state" *ngIf="loadingUsers">
          <span class="admin-spinner"></span>
          <span>Benutzer werden geladen...</span>
        </div>

        <div class="user-assign-list" *ngIf="!loadingUsers">
          <div class="user-assign-count">
            {{ assignedUserIds.length }} von {{ allUsers.length }} Benutzern zugewiesen
          </div>

          <label class="user-assign-row" *ngFor="let u of allUsers" [class.assigned]="isUserAssigned(u.id)">
            <input type="checkbox" [checked]="isUserAssigned(u.id)" (change)="toggleUserAssignment(u.id)" />
            <div class="user-assign-row__avatar">
              {{ u.name.charAt(0).toUpperCase() }}
            </div>
            <div class="user-assign-row__info">
              <span class="user-assign-row__name">{{ u.name }}</span>
              <span class="user-assign-row__email">{{ u.email }}</span>
            </div>
            <span class="admin-badge admin-badge--sm" [class.admin-badge--warning]="u.role === 'admin'"
              [class.admin-badge--primary]="u.role !== 'admin'">
              {{ u.role }}
            </span>
          </label>
        </div>
      </div>

      <div class="admin-modal-footer">
        <button class="admin-btn admin-btn--ghost" (click)="closeAssignModal()" [disabled]="saving">Abbrechen</button>
        <button class="admin-btn admin-btn--primary" (click)="saveAssignments()" [disabled]="saving || loadingUsers">
          <span class="admin-spinner admin-spinner--sm" *ngIf="saving"></span>
          {{ saving ? 'Speichern...' : 'Zuweisungen speichern' }}
        </button>
      </div>
    </div>
  </div>

</app-admin-layout>