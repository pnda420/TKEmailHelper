<app-admin-layout>
<section class="admin-ai-usage">

  <!-- Header -->
  <div class="page-header">
    <div class="header-left">
      <h1><span class="material-symbols-outlined">smart_toy</span> AI Usage</h1>
      <span class="entry-count">{{ total }} Calls</span>
    </div>
    <div class="time-chips" *ngIf="stats">
      <button class="time-chip" [class.active]="statsDays === 1" (click)="statsDays = 1; loadStats()">1d</button>
      <button class="time-chip" [class.active]="statsDays === 7" (click)="statsDays = 7; loadStats()">7d</button>
      <button class="time-chip" [class.active]="statsDays === 30" (click)="statsDays = 30; loadStats()">30d</button>
      <button class="time-chip" [class.active]="statsDays === 90" (click)="statsDays = 90; loadStats()">90d</button>
      <button class="time-chip" [class.active]="statsDays === 365" (click)="statsDays = 365; loadStats()">1y</button>
    </div>
    <div class="header-actions">
      <button class="btn-icon" (click)="loadAll()" [disabled]="loading" title="Aktualisieren">
        <span class="material-symbols-outlined" [class.spinning]="loading">refresh</span>
      </button>
    </div>
  </div>

  <!-- Stats Row: balance + 4 stat chips -->
  <div class="stats-row" *ngIf="stats && !statsLoading">
    <div class="balance-chip" *ngIf="balance && !balanceLoading">
      <span class="material-symbols-outlined">account_balance_wallet</span>
      <strong>{{ formatCost(balance.used || 0) }}</strong>
      <span>30d Kosten</span>
    </div>
    <div class="stat-chip stat-requests">
      <span class="material-symbols-outlined">api</span>
      <strong>{{ stats.totalRequests }}</strong>
      <span>Requests</span>
    </div>
    <div class="stat-chip stat-tokens">
      <span class="material-symbols-outlined">token</span>
      <strong>{{ formatTokens(stats.totalTokens) }}</strong>
      <span>Tokens</span>
    </div>
    <div class="stat-chip stat-cost">
      <span class="material-symbols-outlined">payments</span>
      <strong>{{ formatCost(stats.totalCostUsd) }}</strong>
      <span>Kosten</span>
    </div>
    <div class="stat-chip stat-errors">
      <span class="material-symbols-outlined">error</span>
      <strong>{{ stats.totalErrors }}</strong>
      <span>Fehler</span>
    </div>
  </div>

  <!-- Breakdowns + Chart compact row -->
  <div class="breakdowns-strip" *ngIf="stats && (stats.costByFeature.length || stats.costByModel.length || stats.costByUser.length)">
    <!-- Cost by Feature -->
    <div class="mini-breakdown" *ngIf="stats.costByFeature.length">
      <span class="mini-title"><span class="material-symbols-outlined">category</span> Features</span>
      <div class="mini-items">
        <div class="mini-item" *ngFor="let f of stats.costByFeature.slice(0, 4)">
          <span class="mini-name">{{ getFeatureLabel(f.feature) }}</span>
          <span class="mini-cost">{{ formatCost(f.cost) }}</span>
        </div>
      </div>
    </div>
    <!-- Cost by Model -->
    <div class="mini-breakdown" *ngIf="stats.costByModel.length">
      <span class="mini-title"><span class="material-symbols-outlined">memory</span> Modelle</span>
      <div class="mini-items">
        <div class="mini-item" *ngFor="let m of stats.costByModel.slice(0, 4)">
          <span class="mini-name mono">{{ m.model }}</span>
          <span class="mini-cost">{{ formatCost(m.cost) }}</span>
        </div>
      </div>
    </div>
    <!-- Cost by User -->
    <div class="mini-breakdown" *ngIf="stats.costByUser.length">
      <span class="mini-title"><span class="material-symbols-outlined">group</span> Users</span>
      <div class="mini-items">
        <div class="mini-item" *ngFor="let u of stats.costByUser.slice(0, 4)">
          <span class="mini-name">{{ u.userEmail }}</span>
          <span class="mini-cost">{{ formatCost(u.cost) }}</span>
        </div>
      </div>
    </div>
    <!-- Mini daily chart -->
    <div class="mini-chart" *ngIf="stats.dailyCost.length > 1">
      <span class="mini-title"><span class="material-symbols-outlined">bar_chart</span> Täglich</span>
      <div class="mini-bars">
        <div class="mini-bar" *ngFor="let d of stats.dailyCost" [title]="d.date + ': ' + formatCost(d.cost)" [style.height.%]="(d.cost / getMaxDailyCost()) * 100"></div>
      </div>
    </div>
  </div>

  <!-- Filters Row -->
  <div class="filters-row">
    <select [(ngModel)]="featureFilter" (change)="applyFilters()" class="filter-select">
      <option value="">Alle Features</option>
      <option value="agent-analyze">KI-Agent</option>
      <option value="agent-analyze-summary">KI-Agent (Summary)</option>
      <option value="generate-email">E-Mail generieren</option>
      <option value="analyze-email-for-reply">E-Mail analysieren</option>
      <option value="summarize-email">Zusammenfassung</option>
      <option value="recommend-template">Template-Empfehlung</option>
    </select>
    <select [(ngModel)]="modelFilter" (change)="applyFilters()" class="filter-select">
      <option value="">Alle Modelle</option>
      <option value="gpt-5">gpt-5</option>
      <option value="gpt-5-mini">gpt-5-mini</option>
    </select>
    <input type="date" [(ngModel)]="dateFrom" (change)="applyFilters()" class="filter-date">
    <input type="date" [(ngModel)]="dateTo" (change)="applyFilters()" class="filter-date">
    <button *ngIf="hasActiveFilters" class="btn-reset" (click)="clearFilters()">
      <span class="material-symbols-outlined">filter_alt_off</span>
    </button>
  </div>

  <!-- Loading -->
  <div class="state-fill" *ngIf="loading">
    <div class="spinner"></div>
    <p>Lade AI Usage Daten...</p>
  </div>

  <!-- Empty -->
  <div class="state-fill" *ngIf="!loading && entries.length === 0">
    <span class="material-symbols-outlined empty-icon">smart_toy</span>
    <h3>Keine AI Requests</h3>
    <p>{{ hasActiveFilters ? 'Versuche andere Filter' : 'Noch keine AI API Calls getrackt' }}</p>
  </div>

  <!-- Table -->
  <div class="table-wrap" *ngIf="!loading && entries.length > 0">
    <table class="usage-table">
      <thead>
        <tr>
          <th>Feature</th>
          <th>Modell</th>
          <th>Zeit</th>
          <th>User</th>
          <th>Prompt</th>
          <th>Compl.</th>
          <th>Total</th>
          <th>Kosten</th>
          <th>Dauer</th>
          <th>Status</th>
          <th>Kontext</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let e of entries" class="usage-row" [class.error-row]="!e.success">
          <td>
            <span class="feature-badge">
              <span class="material-symbols-outlined feature-icon">{{ getFeatureIcon(e.feature) }}</span>
              {{ getFeatureLabel(e.feature) }}
            </span>
          </td>
          <td><span class="model-tag">{{ e.model }}</span></td>
          <td class="col-time">{{ formatDate(e.createdAt) }}</td>
          <td class="col-user">{{ e.userEmail || '-' }}</td>
          <td class="col-tokens tok-in">{{ formatTokens(e.promptTokens) }}</td>
          <td class="col-tokens tok-out">{{ formatTokens(e.completionTokens) }}</td>
          <td class="col-tokens tok-total">{{ formatTokens(e.totalTokens) }}</td>
          <td class="col-cost">{{ formatCost(e.costUsd) }}</td>
          <td class="col-duration">{{ formatDuration(e.durationMs) }}</td>
          <td>
            <span class="status-dot" [class.success]="e.success" [class.fail]="!e.success"></span>
            <span *ngIf="!e.success" class="error-msg" [title]="e.errorMessage || ''">Fehler</span>
          </td>
          <td class="col-context" [title]="e.context || ''">{{ e.context ? (e.context.length > 30 ? e.context.substring(0, 30) + '…' : e.context) : '-' }}</td>
        </tr>
      </tbody>
    </table>
  </div>

  <!-- Pagination -->
  <div class="pagination" *ngIf="totalPages > 1">
    <button class="page-btn" [disabled]="page <= 1" (click)="goToPage(1)"><span class="material-symbols-outlined">first_page</span></button>
    <button class="page-btn" [disabled]="page <= 1" (click)="goToPage(page - 1)"><span class="material-symbols-outlined">chevron_left</span></button>
    <button *ngFor="let p of pageNumbers" class="page-btn" [class.active]="p === page" (click)="goToPage(p)">{{ p }}</button>
    <button class="page-btn" [disabled]="page >= totalPages" (click)="goToPage(page + 1)"><span class="material-symbols-outlined">chevron_right</span></button>
    <button class="page-btn" [disabled]="page >= totalPages" (click)="goToPage(totalPages)"><span class="material-symbols-outlined">last_page</span></button>
    <span class="page-info">{{ page }}/{{ totalPages }} ({{ total }})</span>
  </div>

</section>
</app-admin-layout>
