<div class="sk" [class.sk--list-view]="activeMailbox">

  <!-- ============================================ -->
  <!-- VIEW 1: MAILBOX SELECTION                    -->
  <!-- ============================================ -->
  <ng-container *ngIf="!activeMailbox">

    <div class="sk-pick" @fadeSlide>

      <!-- Hero header -->
      <header class="sk-pick__header">
        <div class="sk-pick__header-content">
          <div class="sk-pick__title-row">
            <span class="material-symbols-outlined sk-pick__icon">shield</span>
            <div>
              <h1>Mailwächter</h1>
              <p>KI-gestützte Spam-Erkennung für deine Postfächer</p>
            </div>
          </div>
          <div class="sk-pick__actions">
            <div class="sk-pick__alert" *ngIf="totalFlaggedCount > 0">
              <span class="material-symbols-outlined">warning</span>
              <span><strong>{{ totalFlaggedCount }}</strong> verdächtig</span>
            </div>
            <a routerLink="/spam-killer/history" class="sk-pick__history-btn">
              <span class="material-symbols-outlined">delete_sweep</span>
              Löschverlauf
            </a>
          </div>
        </div>
      </header>

      <!-- Loading skeletons -->
      <div class="sk-pick__grid" *ngIf="loadingMailboxes">
        <div class="sk-pick__skeleton" *ngFor="let i of [1,2,3,4]" @scaleIn>
          <div class="sk-pick__skeleton-avatar"></div>
          <div class="sk-pick__skeleton-lines">
            <div class="sk-pick__skeleton-line sk-pick__skeleton-line--short"></div>
            <div class="sk-pick__skeleton-line"></div>
          </div>
        </div>
      </div>

      <!-- Mailbox grid -->
      <div class="sk-pick__grid" *ngIf="!loadingMailboxes && mailboxes.length > 0">
        <div class="sk-pick__card" *ngFor="let mb of mailboxes; trackBy: trackByMailbox" (click)="selectMailbox(mb)"
          [class.sk-pick__card--danger]="mailboxSpamCounts[mb.mailboxId] >= 10"
          [class.sk-pick__card--warn]="mailboxSpamCounts[mb.mailboxId] > 0 && mailboxSpamCounts[mb.mailboxId] < 10"
          [class.sk-pick__card--clean]="!mailboxSpamCounts[mb.mailboxId] || mailboxSpamCounts[mb.mailboxId] === 0"
          [style.--mb-color]="mb.mailbox.color || '#6366f1'" @scaleIn>

          <div class="sk-pick__accent" [style.background]="mb.mailbox.color || '#6366f1'"></div>

          <div class="sk-pick__avatar" [style.background-image]="mb.mailbox.email | identicon">
          </div>

          <div class="sk-pick__info">
            <strong class="sk-pick__name">{{ mb.mailbox.name || 'Postfach' }}</strong>
            <span class="sk-pick__email">{{ mb.mailbox.email }}</span>
            <div class="sk-pick__tags"
              *ngIf="mb.mailbox.spamAutoDeleteCategories && mb.mailbox.spamAutoDeleteCategories.length > 0">
              <span class="material-symbols-outlined">auto_delete</span>
              <span class="sk-cat-badge sk-cat-badge--xs" *ngFor="let cat of mb.mailbox.spamAutoDeleteCategories"
                [class]="getCategoryClass(cat)">
                {{ getCategoryLabel(cat) }}
              </span>
            </div>
          </div>

          <div class="sk-pick__status">
            <div class="sk-pick__count" *ngIf="mailboxSpamCounts[mb.mailboxId] > 0"
              [class.sk-pick__count--high]="mailboxSpamCounts[mb.mailboxId] >= 10">
              <span class="sk-pick__count-number">{{ mailboxSpamCounts[mb.mailboxId] }}</span>
              <span class="sk-pick__count-label">verdächtig</span>
            </div>
            <div class="sk-pick__clean"
              *ngIf="!mailboxSpamCounts[mb.mailboxId] || mailboxSpamCounts[mb.mailboxId] === 0">
              <span class="material-symbols-outlined">check_circle</span>
              <span>Sauber</span>
            </div>
          </div>

          <span class="material-symbols-outlined sk-pick__arrow">chevron_right</span>
        </div>
      </div>

      <!-- Empty state -->
      <div class="sk-pick__empty" *ngIf="!loadingMailboxes && mailboxes.length === 0">
        <div class="sk-pick__empty-icon">
          <span class="material-symbols-outlined">mail_lock</span>
        </div>
        <h3>Keine Postfächer</h3>
        <p>Es sind noch keine Postfächer konfiguriert.</p>
      </div>

    </div>

  </ng-container>

  <!-- ============================================ -->
  <!-- VIEW 2: EMAIL LIST (redesigned)              -->
  <!-- ============================================ -->
  <ng-container *ngIf="activeMailbox">

    <!-- Top bar -->
    <div class="sk-topbar" @fadeSlide>
      <div class="sk-topbar__left">
        <button class="sk-topbar__back" (click)="backToMailboxes()" title="Zurück">
          <span class="material-symbols-outlined">arrow_back</span>
        </button>
        <div class="sk-topbar__mailbox">
          <strong>{{ activeMailbox.mailbox.name || 'Postfach' }}</strong>
          <span>{{ activeMailbox.mailbox.email }}</span>
        </div>
      </div>

      <div class="sk-topbar__center">
        <!-- Scan indicator -->
        <div class="sk-topbar__scanning" *ngIf="scanning">
          <div class="sk-pulse-dot"></div>
          <span>{{ scanStatus }}</span>
          <span class="sk-topbar__scan-pct" *ngIf="scanTotal > 0">{{ scanProgress }}/{{ scanTotal }}</span>
        </div>
        <!-- Stats pills -->
        <div class="sk-topbar__stats" *ngIf="loaded && emails.length > 0 && !scanning">
          <span class="sk-stat-pill sk-stat-pill--danger" *ngIf="spamCount > 0">{{ spamCount }} Spam</span>
          <span class="sk-stat-pill sk-stat-pill--info" *ngIf="newsletterCount > 0">{{ newsletterCount }} NL</span>
          <span class="sk-stat-pill sk-stat-pill--ok">{{ legitimateCount }} OK</span>
        </div>
      </div>

      <div class="sk-topbar__right">
        <div class="sk-topbar__search">
          <span class="material-symbols-outlined">search</span>
          <input type="text" placeholder="Suchen..." [(ngModel)]="searchQuery" />
          <button class="sk-topbar__search-clear" *ngIf="searchQuery" (click)="clearSearch()">
            <span class="material-symbols-outlined">close</span>
          </button>
        </div>
        <button class="sk-topbar__icon-btn" (click)="startScan()" [disabled]="scanning" title="Neu scannen">
          <span class="material-symbols-outlined" [class.sk-spin]="scanning">{{ scanning ? 'hourglass_top' : 'radar'
            }}</span>
        </button>
        <a routerLink="/spam-killer/history" class="sk-topbar__icon-btn" title="Löschverlauf">
          <span class="material-symbols-outlined">delete_sweep</span>
        </a>
      </div>

      <!-- Progress bar -->
      <div class="sk-topbar__progress" *ngIf="scanning">
        <div class="sk-topbar__progress-fill" [style.width.%]="scanTotal > 0 ? (scanProgress / scanTotal * 100) : 0">
        </div>
      </div>
    </div>

    <!-- Toolbar: filters + bulk actions -->
    <div class="sk-toolbar" *ngIf="loaded && emails.length > 0" @fadeSlide>

      <div class="sk-toolbar__right">
        <span class="sk-toolbar__info" *ngIf="scanDurationMs > 0">{{ formatDuration(scanDurationMs) }} &middot; {{
          totalInbox }} geprüft</span>
      </div>
    </div>

    <!-- Filter chips -->
    <div class="sk-filters" *ngIf="loaded && emails.length > 0">
      <div class="sk-toolbar__left">
        <label class="sk-toolbar__select-all">
          <input type="checkbox" [checked]="allSelected" (change)="toggleAll()" />
          <span>Alle</span>
          <span class="sk-toolbar__count">({{ filteredEmails.length }})</span>
        </label>

        <!-- Delete selected button -->
        <button class="sk-toolbar__delete-btn" *ngIf="selectedCount > 0" [disabled]="isDeleting"
          (click)="deleteSelected()" @fadeSlide>
          <span class="material-symbols-outlined">delete_forever</span>
          {{ isDeleting ? 'Lösche...' : selectedCount + ' markierte löschen' }}
        </button>
      </div>
      <button class="sk-filter-chip"
        *ngFor="let cat of ['spam','scam','phishing','newsletter','marketing','legitimate']"
        [class.sk-filter-chip--active]="filterCategory === cat" (click)="setFilterCategory($any(cat))">
        <span class="material-symbols-outlined">{{ getCategoryIcon(cat) }}</span>
        {{ getCategoryLabel(cat) }}
        <span class="sk-filter-chip__count" *ngIf="categoryCountMap[cat]">{{ categoryCountMap[cat] }}</span>
      </button>
      <button class="sk-filter-chip sk-filter-chip--clear" *ngIf="hasActiveFilters" (click)="clearFilters()">
        <span class="material-symbols-outlined">filter_list_off</span>
        Zurücksetzen
      </button>
    </div>

    <!-- Email list (single column, expandable cards) -->
    <div class="sk-email-list" [@listAnim]="filteredEmails.length">

      <div *ngFor="let e of filteredEmails; trackBy: trackByUid" class="sk-card"
        [class.sk-card--expanded]="expandedEmail?.uid === e.uid" [class.sk-card--checked]="e.selected">

        <!-- Card row -->
        <div class="sk-card__row" (click)="toggleExpand(e)">
          <label class="sk-card__check" (click)="$event.stopPropagation()">
            <input type="checkbox" [checked]="e.selected" (change)="toggle(e)" />
          </label>

          <div class="sk-card__score" [class]="getScoreClass(e.spamScore)">{{ e.spamScore }}</div>

          <div class="sk-card__avatar"
               [style.background-image]="e.from | identicon"
               [style.background-color]="activeMailbox!.mailbox.color || '#6366f1'">
          </div>

          <div class="sk-card__content">
            <div class="sk-card__header">
              <span class="sk-card__from">{{ e.fromName || e.from }}</span>
              <span class="sk-cat-badge" [class]="getCategoryClass(e.category)">
                <span class="material-symbols-outlined">{{ getCategoryIcon(e.category) }}</span>
                {{ getCategoryLabel(e.category) }}
              </span>
            </div>
            <div class="sk-card__subject">{{ e.subject }}</div>
            <div class="sk-card__reason">{{ e.spamReason }}</div>
          </div>

          <span class="sk-card__date">{{ formatDate(e.date) }}</span>

          <!-- Per-email actions -->
          <div class="sk-card__actions" (click)="$event.stopPropagation()">
            <button class="sk-card__action-btn sk-card__action-btn--delete" (click)="deleteSingle(e)" title="Löschen"
              [disabled]="isDeleting">
              <span class="material-symbols-outlined">delete</span>
            </button>
          </div>

          <span class="material-symbols-outlined sk-card__chevron">
            {{ expandedEmail?.uid === e.uid ? 'expand_less' : 'expand_more' }}
          </span>
        </div>

        <!-- Expanded detail -->
        <div class="sk-card__detail" *ngIf="expandedEmail?.uid === e.uid" @fadeSlide>
          <div class="sk-card__detail-inner">

            <!-- Score + Category hero -->
            <div class="sk-card__hero" [class]="'sk-card__hero--' + getScoreClass(e.spamScore)">
              <div class="sk-card__hero-score" [class]="getScoreClass(e.spamScore)">{{ e.spamScore }}</div>
              <div class="sk-card__hero-info">
                <span class="sk-cat-badge sk-cat-badge--lg" [class]="getCategoryClass(e.category)">
                  <span class="material-symbols-outlined">{{ getCategoryIcon(e.category) }}</span>
                  {{ getCategoryLabel(e.category) }}
                </span>
                <p>{{ e.spamReason }}</p>
              </div>
            </div>

            <!-- Meta table -->
            <div class="sk-card__meta">
              <div class="sk-card__meta-row">
                <span class="sk-card__meta-label">Von</span>
                <span class="sk-card__meta-value">{{ e.fromName }} &lt;{{ e.from }}&gt;</span>
              </div>
              <div class="sk-card__meta-row">
                <span class="sk-card__meta-label">An</span>
                <span class="sk-card__meta-value">{{ e.to }}</span>
              </div>
              <div class="sk-card__meta-row">
                <span class="sk-card__meta-label">Betreff</span>
                <span class="sk-card__meta-value">{{ e.subject }}</span>
              </div>
              <div class="sk-card__meta-row">
                <span class="sk-card__meta-label">Datum</span>
                <span class="sk-card__meta-value">{{ formatDateFull(e.date) }}</span>
              </div>
            </div>

            <!-- Preview -->
            <div class="sk-card__preview" *ngIf="e.preview && !emailBodyVisible">
              <p>{{ e.preview }}</p>
            </div>

            <!-- Full email body -->
            <div class="sk-card__body" *ngIf="emailBodyVisible && emailBodyText">
              <h4>
                <span class="material-symbols-outlined">article</span>
                E-Mail Inhalt
              </h4>
              <div class="sk-card__body-text">{{ emailBodyText }}</div>
            </div>

            <!-- Action buttons -->
            <div class="sk-card__detail-actions">
              <button class="sk-card__detail-btn sk-card__detail-btn--read" (click)="toggleEmailBody()"
                [disabled]="emailBodyLoading">
                <span class="material-symbols-outlined" [class.sk-spin]="emailBodyLoading">
                  {{ emailBodyLoading ? 'hourglass_top' : emailBodyVisible ? 'visibility_off' : 'visibility' }}
                </span>
                {{ emailBodyLoading ? 'Lade...' : emailBodyVisible ? 'Ausblenden' : 'E-Mail lesen' }}
              </button>
              <button class="sk-card__detail-btn sk-card__detail-btn--mark" (click)="toggle(e)"
                [class.sk-card__detail-btn--marked]="e.selected">
                <span class="material-symbols-outlined">{{ e.selected ? 'check_circle' : 'radio_button_unchecked'
                  }}</span>
                {{ e.selected ? 'Markiert' : 'Markieren' }}
              </button>
              <button class="sk-card__detail-btn sk-card__detail-btn--destroy" (click)="deleteSingle(e)"
                [disabled]="isDeleting">
                <span class="material-symbols-outlined">delete_forever</span>
                Löschen
              </button>
            </div>
          </div>
        </div>
      </div>

    </div>

    <!-- Loading state -->
    <div class="sk-state" *ngIf="!loaded && !error">
      <span class="material-symbols-outlined sk-spin">sync</span>
      <span>Lade Ergebnisse...</span>
    </div>

    <!-- Error state -->
    <div class="sk-state" *ngIf="error && !scanning">
      <span class="material-symbols-outlined" style="color: #dc2626;">error</span>
      <span>Scan fehlgeschlagen</span>
      <button class="sk-inline-btn" (click)="startScan()">
        <span class="material-symbols-outlined">refresh</span> Erneut versuchen
      </button>
    </div>

    <!-- Empty state -->
    <div class="sk-state sk-state--empty" *ngIf="loaded && emails.length === 0 && !error && !scanning">
      <div class="sk-state__icon-wrap">
        <span class="material-symbols-outlined">verified_user</span>
      </div>
      <h3>Alles sauber!</h3>
      <p>Keine verdächtigen E-Mails gefunden.</p>
      <button class="sk-inline-btn" (click)="startScan()">
        <span class="material-symbols-outlined">radar</span> Neu scannen
      </button>
    </div>

    <!-- No filter results -->
    <div class="sk-state sk-state--empty" *ngIf="loaded && emails.length > 0 && filteredEmails.length === 0">
      <span class="material-symbols-outlined">filter_list_off</span>
      <h3>Keine Treffer</h3>
      <p>Keine E-Mails passen zu diesem Filter.</p>
      <button class="sk-inline-btn" (click)="clearFilters()">
        <span class="material-symbols-outlined">clear_all</span> Filter zurücksetzen
      </button>
    </div>

  </ng-container>

</div>