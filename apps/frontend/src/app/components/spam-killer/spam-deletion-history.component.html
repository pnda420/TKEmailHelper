<app-page-title title="Mail Wächter"></app-page-title>

<div class="dh">

  <!-- ── Unified Command Bar ── -->
  <header class="inbox-header">
    <div class="header-row">
      <a routerLink="/spam-killer" class="header-back" title="Zurück zum Spam Killer">
        <span class="material-symbols-outlined">arrow_back</span>
      </a>

      <div class="header-title">
        <span class="material-symbols-outlined header-title__icon">delete_sweep</span>
        <strong>Löschverlauf</strong>
      </div>

      <span class="header-divider"></span>

      <div class="header-stats">
        <span class="stat-pill">
          <span class="material-symbols-outlined">analytics</span>
          <strong>{{ totalLogs }}</strong> Einträge
        </span>
      </div>

      <span class="header-divider"></span>

      <!-- Filter: User -->
      <div class="header-filters">
        <div class="header-filter-select">
          <span class="material-symbols-outlined">person</span>
          <select [(ngModel)]="filterUserEmail" (ngModelChange)="onFilterChange()">
            <option value="">Alle Benutzer</option>
            <option *ngFor="let u of availableUsers" [value]="u">{{ u }}</option>
          </select>
        </div>

        <div class="header-filter-select">
          <span class="material-symbols-outlined">mail</span>
          <select [(ngModel)]="filterMailboxId" (ngModelChange)="onFilterChange()">
            <option value="">Alle Postfächer</option>
            <option *ngFor="let mb of availableMailboxes" [value]="mb.mailboxId">{{ mb.mailbox.email }}</option>
          </select>
        </div>

        <div class="header-filter-select">
          <span class="material-symbols-outlined">label</span>
          <select [(ngModel)]="filterCategory" (ngModelChange)="onFilterChange()">
            <option value="">Alle Kategorien</option>
            <option *ngFor="let cat of categories" [value]="cat.key">{{ cat.label }}</option>
          </select>
        </div>

        <button class="filter-chip filter-chip--clear" *ngIf="hasActiveFilters" (click)="clearFilters()">
          <span class="material-symbols-outlined">filter_list_off</span>
          Zurücksetzen
        </button>
      </div>

      <div class="header-search">
        <span class="material-symbols-outlined header-search__icon">search</span>
        <input type="text"
               [(ngModel)]="searchQuery"
               (input)="onSearchInput()"
               placeholder="Suchen…"
               class="header-search__input" />
        <button class="header-search__clear" *ngIf="searchQuery" (click)="clearSearch()">
          <span class="material-symbols-outlined">close</span>
        </button>
      </div>
    </div>
  </header>

  <!-- ── Loading State ── -->
  <div class="dh-loading" *ngIf="loading && initialLoad">
    <div class="loading-spinner"></div>
    <span>Lade Löschverlauf…</span>
  </div>

  <!-- ── Empty State ── -->
  <div class="list-empty" *ngIf="!loading && logs.length === 0 && !initialLoad">
    <span class="material-symbols-outlined">inbox</span>
    <h3 *ngIf="!hasActiveFilters">Noch keine Löschungen</h3>
    <h3 *ngIf="hasActiveFilters">Keine Treffer</h3>
    <p *ngIf="!hasActiveFilters">Gelöschte Spam-E-Mails werden hier protokolliert.</p>
    <p *ngIf="hasActiveFilters">Versuche andere Filter oder Suchbegriffe.</p>
  </div>

  <!-- ── Main split view ── -->
  <div class="inbox-split" *ngIf="logs.length > 0">

    <!-- List pane -->
    <aside class="list-pane" [class.has-detail]="selectedLog">
      <div class="mail-item"
           *ngFor="let log of logs"
           [class.active]="selectedLog?.id === log.id"
           [class.system]="isSystemUser(log.deletedByUserEmail)"
           (click)="selectLog(log)">

        <div class="mail-avatar" [class.mail-avatar--system]="isSystemUser(log.deletedByUserEmail)">
          <span class="material-symbols-outlined" *ngIf="isSystemUser(log.deletedByUserEmail)">smart_toy</span>
          <span *ngIf="!isSystemUser(log.deletedByUserEmail)">{{ log.deletedByUserEmail.charAt(0).toUpperCase() }}</span>
        </div>

        <div class="mail-content">
          <div class="mail-top">
            <span class="mail-sender" [class.mail-sender--system]="isSystemUser(log.deletedByUserEmail)">
              {{ isSystemUser(log.deletedByUserEmail) ? 'Auto-Delete' : log.deletedByUserEmail }}
            </span>
            <span class="mail-time">{{ formatDate(log.deletedAt) }}</span>
          </div>
          <div class="mail-subject">
            {{ log.mailboxEmail || getMailboxName(log.mailboxId) }}
          </div>
          <div class="mail-snippet">
            <span class="count-badge">
              <span class="material-symbols-outlined">delete</span>
              {{ log.count }} E-Mails gelöscht
            </span>
          </div>
        </div>
      </div>
    </aside>

    <!-- Detail pane -->
    <main class="detail-pane" *ngIf="selectedLog">

      <!-- Hero Header -->
      <div class="detail-hero">
        <div class="hero-row">
          <button class="hero-back" (click)="selectedLog = null">
            <span class="material-symbols-outlined">arrow_back</span>
          </button>

          <div class="hero-sender">
            <div class="hero-avatar hero-avatar--log"
              [class.hero-avatar--system]="isSystemUser(selectedLog.deletedByUserEmail)">
              <span class="material-symbols-outlined" *ngIf="isSystemUser(selectedLog.deletedByUserEmail)">smart_toy</span>
              <span *ngIf="!isSystemUser(selectedLog.deletedByUserEmail)">{{ selectedLog.deletedByUserEmail.charAt(0).toUpperCase() }}</span>
            </div>
            <div class="hero-sender-info">
              <span class="hero-sender-name">
                {{ isSystemUser(selectedLog.deletedByUserEmail) ? 'Auto-Delete (System)' : selectedLog.deletedByUserEmail }}
              </span>
              <span class="hero-sender-meta">
                <span class="hero-date">{{ formatDateFull(selectedLog.deletedAt) }}</span>
              </span>
            </div>
          </div>

          <div class="hero-actions">
            <span class="hero-count-badge">
              <span class="material-symbols-outlined">delete</span>
              {{ selectedLog.count }}
            </span>
          </div>
        </div>

        <h2 class="hero-subject">
          {{ selectedLog.mailboxEmail || getMailboxName(selectedLog.mailboxId) }}
        </h2>

        <div class="hero-to">
          <span class="material-symbols-outlined">schedule</span>
          {{ formatDateFull(selectedLog.deletedAt) }}
        </div>
      </div>

      <!-- Deleted emails list -->
      <div class="detail-content">
        <div class="dh-email-list">
          <div class="dh-email-item"
               *ngFor="let email of parseEmailSummaries(selectedLog.emailSummaries); let i = index"
               [class.dh-email-item--expanded]="isEmailBodyExpanded(selectedLog.id, i)"
               (click)="(email.bodyText || email.preview) ? toggleEmailBody(selectedLog.id, i) : null"
               [class.dh-email-item--clickable]="email.bodyText || email.preview">

            <div class="dh-email-item__row">
              <div class="dh-email-item__cat">
                <span class="material-symbols-outlined"
                  [style.color]="getCategoryInfo(email.category).color"
                  [title]="getCategoryInfo(email.category).label">
                  {{ getCategoryInfo(email.category).icon }}
                </span>
              </div>

              <div class="dh-email-item__content">
                <div class="dh-email-item__top">
                  <span class="dh-email-item__from">{{ email.fromName || email.from }}</span>
                  <span class="dh-email-item__cat-badge"
                    [style.background]="getCategoryInfo(email.category).color + '14'"
                    [style.color]="getCategoryInfo(email.category).color">
                    {{ getCategoryInfo(email.category).label }}
                  </span>
                </div>
                <div class="dh-email-item__subject">{{ email.subject || '(Kein Betreff)' }}</div>
              </div>

              <div class="dh-email-item__meta">
                <span class="dh-email-item__score" *ngIf="email.spamScore">{{ email.spamScore }}%</span>
                <span class="material-symbols-outlined dh-email-item__expand"
                  *ngIf="email.bodyText || email.preview"
                  [class.dh-email-item__expand--open]="isEmailBodyExpanded(selectedLog.id, i)">
                  expand_more
                </span>
              </div>
            </div>

            <!-- Expanded body -->
            <div class="dh-email-item__body" *ngIf="isEmailBodyExpanded(selectedLog.id, i) && (email.bodyText || email.preview)"
              (click)="$event.stopPropagation()">
              {{ email.bodyText || email.preview }}
            </div>
          </div>

          <div class="dh-no-details" *ngIf="parseEmailSummaries(selectedLog.emailSummaries).length === 0">
            <span class="material-symbols-outlined">info</span>
            Keine Details verfügbar
          </div>
        </div>
      </div>
    </main>

    <!-- No Selection -->
    <div class="detail-empty" *ngIf="!selectedLog">
      <span class="material-symbols-outlined">delete_sweep</span>
      <p>Wähle einen Eintrag aus</p>
    </div>
  </div>

  <!-- ── Pagination ── -->
  <div class="dh-pagination" *ngIf="totalPages > 1">
    <button class="dh-pagination__btn" [disabled]="currentPage === 1" (click)="prevPage()">
      <span class="material-symbols-outlined">chevron_left</span>
    </button>

    <button class="dh-pagination__btn dh-pagination__btn--first" *ngIf="pageNumbers[0] > 1" (click)="goToPage(1)">1</button>
    <span class="dh-pagination__dots" *ngIf="pageNumbers[0] > 2">…</span>

    <button class="dh-pagination__btn"
            *ngFor="let p of pageNumbers"
            [class.dh-pagination__btn--active]="p === currentPage"
            (click)="goToPage(p)">
      {{ p }}
    </button>

    <span class="dh-pagination__dots" *ngIf="pageNumbers[pageNumbers.length - 1] < totalPages - 1">…</span>
    <button class="dh-pagination__btn dh-pagination__btn--last" *ngIf="pageNumbers[pageNumbers.length - 1] < totalPages" (click)="goToPage(totalPages)">{{ totalPages }}</button>

    <button class="dh-pagination__btn" [disabled]="currentPage === totalPages" (click)="nextPage()">
      <span class="material-symbols-outlined">chevron_right</span>
    </button>

    <span class="dh-pagination__info">
      Seite {{ currentPage }} von {{ totalPages }}
    </span>
  </div>
</div>
