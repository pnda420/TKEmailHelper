<app-page-title title="Posteingang"></app-page-title>

<div class="inbox">

    <!-- ── Unified Command Bar (single row) ── -->
    <header class="inbox-header">
        <div class="header-row">
            <div class="header-stats">
                <span class="stat-pill">
                    <span class="material-symbols-outlined stat-pill__icon">inbox</span>
                    <strong>{{ totalEmails }}</strong>
                </span>
                <span class="idle-chip" [class.connected]="idleConnected"
                      [title]="idleConnected ? 'IMAP IDLE aktiv — neue Mails werden automatisch erkannt' : 'IMAP IDLE nicht verbunden'">
                    <span class="idle-chip__dot"></span>
                    <span class="idle-chip__label">{{ idleConnected ? 'Live' : 'Offline' }}</span>
                </span>
            </div>

            <span class="header-divider"></span>

            <div class="header-filters">
                <button class="filter-chip" [class.active]="filterRead === undefined" (click)="onFilterReadChange('')">
                    Alle
                </button>
                <button class="filter-chip" [class.active]="filterRead === false" (click)="onFilterReadChange('false')">
                    <span class="material-symbols-outlined">mark_email_unread</span>
                    Ungelesen
                </button>
                <button class="filter-chip" [class.active]="filterRead === true" (click)="onFilterReadChange('true')">
                    <span class="material-symbols-outlined">drafts</span>
                    Gelesen
                </button>
                <button class="filter-chip" *ngIf="hasActiveFilters" (click)="clearFilters()">
                    <span class="material-symbols-outlined">filter_list_off</span>
                    Zurücksetzen
                </button>
            </div>

            <div class="header-search">
                <span class="material-symbols-outlined header-search__icon">search</span>
                <input type="text"
                       [(ngModel)]="searchQuery"
                       (input)="onSearchInput()"
                       placeholder="Suchen…"
                       class="header-search__input" />
                <button class="header-search__clear" *ngIf="searchQuery" (click)="clearSearch()">
                    <span class="material-symbols-outlined">close</span>
                </button>
            </div>

            <div class="header-ai-actions">
                <!-- AI status indicator (when idle) -->
                <span class="ai-status-chip" *ngIf="aiStatus && !aiProcessing && aiStatus.pending === 0">
                    <span class="material-symbols-outlined">check_circle</span>
                    Alle analysiert
                </span>

                <!-- Process pending -->
                <button class="ai-action-btn ai-action-btn--process"
                    *ngIf="!aiProcessing && aiStatus && aiStatus.pending > 0"
                    (click)="processWithAi()">
                    <span class="material-symbols-outlined">bolt</span>
                    <strong>{{ aiStatus.pending }}</strong> analysieren
                </button>

                <!-- Processing in progress (mini inline) -->
                <button class="ai-action-btn ai-action-btn--live"
                    *ngIf="aiProcessing && aiStatus"
                    (click)="terminalOpen = !terminalOpen">
                    <span class="ai-action-btn__pulse"></span>
                    <span class="material-symbols-outlined">auto_awesome</span>
                    <span class="ai-action-btn__progress">{{ aiStatus.processed }}/{{ aiStatus.total }}</span>
                    <span class="material-symbols-outlined ai-action-btn__toggle">{{ terminalOpen ? 'close' : 'terminal' }}</span>
                </button>

                <!-- Recalculate (admin only) -->
                <button class="ai-action-btn ai-action-btn--recalc"
                    *ngIf="isAdmin && !aiProcessing"
                    (click)="recalculateAi()"
                    [disabled]="refreshing"
                    title="Alle E-Mails neu analysieren">
                    <span class="material-symbols-outlined">auto_awesome</span>
                </button>
            </div>

            <button class="header-refresh-btn" (click)="refreshEmails()" [disabled]="refreshing" title="E-Mails abrufen">
                <span class="material-symbols-outlined" [class.spin]="refreshing">sync</span>
                Abrufen
            </button>

            <button class="header-history-btn" routerLink="/history" title="Mail-Archiv">
                <span class="material-symbols-outlined">history</span>
                Mail-Archiv
            </button>
        </div>
    </header>

    <!-- Loading -->
    <div class="inbox-loading" *ngIf="loading">
        <div class="loading-spinner-wrap">
            <div class="loading-spinner"></div>
            <span class="loading-text">E-Mails werden geladen…</span>
        </div>
        <div class="skeleton-row" *ngFor="let i of [1,2,3,4,5,6,7,8]">
            <div class="skeleton-avatar"></div>
            <div class="skeleton-lines">
                <div class="skeleton-line w60"></div>
                <div class="skeleton-line w90"></div>
                <div class="skeleton-line w40"></div>
            </div>
        </div>
    </div>

    <!-- Main split view -->
    <div class="inbox-split" [class.has-sidebar]="terminalOpen" *ngIf="!loading">
        <!-- List pane -->
        <aside class="list-pane" [class.has-detail]="selectedEmail" [@listAnimation]="emails.length">
            <div class="mail-item" *ngFor="let email of emails"
                [class.unread]="!email.isRead"
                [class.active]="selectedEmail?.id === email.id"
                [class.blocked]="email.aiProcessing"
                [class.locked]="email.lockedBy && email.lockedBy !== currentUserId"
                [class.analyzing]="email.aiProcessing && !email.aiProcessedAt"
                (click)="selectEmail(email)">

                <div class="mail-avatar" 
                     [class.ai-pulse]="email.aiProcessing && !email.aiProcessedAt"
                     [style.background-image]="email.fromAddress | identicon">
                    <span class="material-symbols-outlined ai-avatar-icon" *ngIf="email.aiProcessing && !email.aiProcessedAt">auto_awesome</span>
                </div>

                <div class="mail-content">
                    <div class="mail-top">
                        <span class="mail-sender">{{ getSenderName(email) }}</span>
                        <span class="mail-time">{{ formatDate(email.receivedAt) }}</span>
                    </div>
                    <div class="mail-mailbox-row" *ngIf="email.mailboxId && getMailboxName(email.mailboxId)">
                        <span class="mailbox-badge"
                          [style.background-color]="getMailboxColor(email.mailboxId)"
                          [title]="getMailboxName(email.mailboxId)">
                          {{ getMailboxName(email.mailboxId) }}
                        </span>
                    </div>
                    <div class="mail-subject">{{ email.subject }}</div>
                    <div class="mail-snippet"
                        *ngIf="!email.aiProcessing || email.aiSummary || email.aiProcessedAt">
                        {{ email.aiSummary || email.preview || '(Kein Inhalt)' }}
                    </div>
                    <div class="mail-snippet shimmer-line"
                        *ngIf="email.aiProcessing && !email.aiSummary && !email.aiProcessedAt"></div>
                    <div class="mail-tags" *ngIf="email.aiTags?.length">
                        <span class="tag" *ngFor="let tag of email.aiTags">{{ tag }}</span>
                    </div>
                    <!-- AI processing badge -->
                    <div class="mail-ai-badge" *ngIf="email.aiProcessing && !email.aiProcessedAt">
                        <span class="ai-spinner"></span>
                        <span>KI analysiert…</span>
                    </div>
                    <!-- Locked indicator -->
                    <div class="mail-lock-badge" *ngIf="email.lockedBy && email.lockedBy !== currentUserId">
                        <span class="material-symbols-outlined">lock</span>
                        <span>{{ email.lockedByName || 'Benutzer' }}</span>
                    </div>
                </div>

                <div class="mail-meta">
                    <span class="material-symbols-outlined clip-icon" *ngIf="email.hasAttachments"
                        title="Anhänge">attach_file</span>
                    <span class="unread-dot" *ngIf="!email.isRead"></span>
                </div>
            </div>

            <!-- Load more -->
            <div class="list-footer" *ngIf="hasMore">
                <button class="action-btn secondary" (click)="loadMore()">Weitere E-Mails laden</button>
            </div>

            <!-- Empty -->
            <div class="list-empty" *ngIf="emails.length === 0">
                <span class="material-symbols-outlined">markunread_mailbox</span>
                <p>Keine unbearbeiteten E-Mails</p>
                <button class="action-btn primary" (click)="refreshEmails()">E-Mails abrufen</button>
            </div>
        </aside>

        <!-- Detail pane -->
        <main class="detail-pane" *ngIf="selectedEmail" @slideIn>

            <!-- ── Hero Header ── -->
            <div class="detail-hero">
                <div class="hero-row">
                    <button class="hero-back" (click)="closeDetail()">
                        <span class="material-symbols-outlined">arrow_back</span>
                    </button>

                    <div class="hero-sender">
                        <div class="hero-avatar" 
                             [style.background-image]="selectedEmail.fromAddress | identicon">
                        </div>
                        <div class="hero-sender-info">
                            <span class="hero-sender-name">{{ selectedEmail.fromName || selectedEmail.fromAddress }}</span>
                            <span class="hero-sender-meta">
                                <span *ngIf="selectedEmail.fromName" class="hero-email">{{ selectedEmail.fromAddress }}</span>
                                <span class="hero-date">{{ selectedEmail.receivedAt | date:'dd.MM.yy, HH:mm' }}</span>
                            </span>
                        </div>
                    </div>

                    <div class="hero-actions">
                        <button class="hero-icon-btn" *ngIf="isAdmin" (click)="recalculateSingleEmail(selectedEmail)" title="Neu analysieren">
                            <span class="material-symbols-outlined">refresh</span>
                        </button>
                        <button class="hero-icon-btn danger" (click)="moveToTrash()" title="Löschen">
                            <span class="material-symbols-outlined">delete_outline</span>
                        </button>
                        <div class="hero-view-buttons" *ngIf="selectedEmail.aiProcessedAt && selectedEmail.aiSummary">
                            <button class="hero-view-btn" [class.active]="!showAiView" (click)="showAiView = false">
                                <span class="material-symbols-outlined">mail</span>
                                <span class="btn-label">Original</span>
                            </button>
                            <button class="hero-view-btn" [class.active]="showAiView" (click)="showAiView = true">
                                <span class="material-symbols-outlined">auto_awesome</span>
                                <span class="btn-label">KI-Ansicht</span>
                            </button>
                        </div>
                    </div>
                </div>

                <h2 class="hero-subject">{{ selectedEmail.subject }}</h2>

                <div class="hero-to">
                    <span class="material-symbols-outlined">arrow_forward</span>
                    {{ selectedEmail.toAddresses[0] }}
                    <span class="mailbox-badge-detail" 
                          *ngIf="selectedEmail.mailboxId && getMailboxName(selectedEmail.mailboxId)"
                          [style.background-color]="getMailboxColor(selectedEmail.mailboxId)">
                        {{ getMailboxName(selectedEmail.mailboxId) }}
                    </span>
                </div>
            </div>

            <!-- ── Floating Reply FAB ── -->
            <button class="reply-fab" (click)="openReplyPage()" title="Antworten" @slideIn>
                <span class="reply-fab__shine"></span>
                <span class="reply-fab__label">Antworten</span>
                <span class="material-symbols-outlined reply-fab__icon">send</span>
            </button>

            <!-- ── Tab bar ── -->
            <nav class="detail-tabs">
                <button class="detail-tab" [class.active]="activeDetailTab === 'email'"
                    (click)="switchDetailTab('email')">
                    <span class="material-symbols-outlined">mail</span>
                    E-Mail
                </button>
                <button class="detail-tab" [class.active]="activeDetailTab === 'attachments'"
                    (click)="switchDetailTab('attachments')"
                    *ngIf="selectedEmail.attachments?.length">
                    <span class="material-symbols-outlined">attach_file</span>
                    Anhänge
                    <span class="tab-count">{{ selectedEmail.attachments!.length }}</span>
                </button>
            </nav>

            <!-- ═══ TAB: E-Mail ═══ -->
            <div class="detail-content" *ngIf="activeDetailTab === 'email'">

                <!-- AI summary card -->
                <div class="ai-card" *ngIf="selectedEmail.aiProcessedAt && selectedEmail.aiSummary">
                    <div class="ai-card__sparkle">
                        <span class="material-symbols-outlined">auto_awesome</span>
                    </div>
                    <div class="ai-card__body">
                        <p class="ai-card__text">{{ selectedEmail.aiSummary }}</p>
                        <div class="ai-card__tags" *ngIf="selectedEmail.aiTags?.length">
                            <span class="tag" *ngFor="let tag of selectedEmail.aiTags">{{ tag }}</span>
                        </div>
                    </div>
                </div>

                <!-- Email body -->
                <div class="email-body-wrap">
                    <div *ngIf="showAiView && selectedEmail.aiProcessedAt && selectedEmail.cleanedBody" class="email-body-text">
                        <pre class="body-text">{{ selectedEmail.cleanedBody }}</pre>
                    </div>
                    <div *ngIf="!showAiView || !selectedEmail.aiProcessedAt || !selectedEmail.cleanedBody">
                        <div *ngIf="selectedEmail.htmlBody" class="html-body" [innerHTML]="selectedEmail.htmlBody"></div>
                        <pre *ngIf="!selectedEmail.htmlBody && selectedEmail.textBody"
                            class="body-text">{{ selectedEmail.textBody }}</pre>
                        <p *ngIf="!selectedEmail.htmlBody && !selectedEmail.textBody" class="no-body">(Kein Inhalt)</p>
                    </div>
                </div>

            </div>

            <!-- ═══ TAB: Anhänge ═══ -->
            <div class="detail-content" *ngIf="activeDetailTab === 'attachments'">
                <div class="attachments-grid">
                    <button class="att-card" *ngFor="let att of selectedEmail.attachments; let i = index"
                        (click)="openAttachmentPreview(att, i)">
                        <div class="att-card__icon">
                            <span class="material-symbols-outlined">{{ getAttachmentIcon(att.contentType) }}</span>
                        </div>
                        <div class="att-card__info">
                            <span class="att-card__name">{{ att.filename }}</span>
                            <span class="att-card__size">{{ formatFileSize(att.size) }}</span>
                        </div>
                        <span class="material-symbols-outlined att-card__action">visibility</span>
                    </button>
                </div>
            </div>
        </main>

        <!-- No Selection -->
        <div class="detail-empty" *ngIf="!selectedEmail && !terminalOpen">
            <span class="material-symbols-outlined">mail</span>
            <p>Wähle eine E-Mail aus</p>
        </div>
        <div class="detail-empty" *ngIf="!selectedEmail && terminalOpen">
        </div>

        <!-- AI Sidebar (right split pane) -->
        <aside class="ai-sidebar" *ngIf="terminalOpen">
            <div class="ai-sidebar__header">
                <div class="ai-sidebar__title">
                    <span class="material-symbols-outlined">terminal</span>
                    <span>KI-Verarbeitung</span>
                    <span class="ai-sidebar__badge live" *ngIf="aiProcessing">LIVE</span>
                    <span class="ai-sidebar__badge done" *ngIf="!aiProcessing && terminalLogs.length">DONE</span>
                </div>
                <div class="ai-sidebar__actions">
                    <button class="ai-sidebar__btn" (click)="clearTerminal()" title="Leeren">
                        <span class="material-symbols-outlined">delete_sweep</span>
                    </button>
                    <button class="ai-sidebar__btn" (click)="terminalOpen = false" title="Schließen">
                        <span class="material-symbols-outlined">close</span>
                    </button>
                </div>
            </div>

            <!-- Currently processing email card -->
            <div class="ai-sidebar__current" *ngIf="aiProcessing && currentProcessingSubject">
                <div class="ai-sidebar__current-label">
                    <span class="ai-sidebar__current-pulse"></span>
                    <span>Wird analysiert</span>
                </div>
                <div class="ai-sidebar__current-subject">{{ currentProcessingSubject }}</div>
                <div class="ai-sidebar__current-step" *ngIf="currentProcessingStep">
                    <span class="material-symbols-outlined">precision_manufacturing</span>
                    {{ currentProcessingStep }}
                </div>
            </div>

            <!-- Stats strip -->
            <div class="ai-sidebar__stats" *ngIf="aiStatus">
                <div class="ai-stat">
                    <span class="ai-stat__val">{{ aiStatus.processed }}/{{ aiStatus.total }}</span>
                    <span class="ai-stat__lbl">Verarbeitet</span>
                </div>
                <div class="ai-stat" *ngIf="terminalElapsed">
                    <span class="ai-stat__val">{{ terminalElapsed }}</span>
                    <span class="ai-stat__lbl">Laufzeit</span>
                </div>
                <div class="ai-stat" *ngIf="terminalEta && aiProcessing">
                    <span class="ai-stat__val highlight">{{ terminalEta }}</span>
                    <span class="ai-stat__lbl">ETA</span>
                </div>
                <div class="ai-stat" *ngIf="terminalStepCount > 0">
                    <span class="ai-stat__val">{{ terminalStepCount }}</span>
                    <span class="ai-stat__lbl">Agent-Steps</span>
                </div>
                <div class="ai-stat" *ngIf="terminalErrorCount > 0">
                    <span class="ai-stat__val highlight-error">{{ terminalErrorCount }}</span>
                    <span class="ai-stat__lbl">Fehler</span>
                </div>
            </div>

            <!-- Progress bar -->
            <div class="ai-sidebar__progress" *ngIf="aiProcessing && aiStatus && aiStatus.total > 0">
                <div class="ai-sidebar__progress-bar"
                    [style.width.%]="(aiStatus.processed / aiStatus.total) * 100"></div>
            </div>

            <!-- Log filter chips -->
            <div class="ai-sidebar__filters">
                <button class="ai-filter-chip" 
                    [class.active]="terminalFilter === 'all'" 
                    (click)="terminalFilter = 'all'">
                    Alle
                </button>
                <button class="ai-filter-chip" 
                    [class.active]="terminalFilter === 'steps'" 
                    (click)="terminalFilter = 'steps'">
                    <span class="material-symbols-outlined">precision_manufacturing</span>
                    Steps
                </button>
                <button class="ai-filter-chip" 
                    [class.active]="terminalFilter === 'progress'" 
                    (click)="terminalFilter = 'progress'">
                    <span class="material-symbols-outlined">check_circle</span>
                    Fortschritt
                </button>
                <button class="ai-filter-chip" 
                    [class.active]="terminalFilter === 'errors'" 
                    (click)="terminalFilter = 'errors'">
                    <span class="material-symbols-outlined">error</span>
                    Fehler
                    <span class="chip-count" *ngIf="terminalErrorCount > 0">{{ terminalErrorCount }}</span>
                </button>
            </div>

            <!-- Log body -->
            <div class="ai-sidebar__body" #terminalBody (scroll)="onTerminalScroll()">
                <div class="log-line" *ngFor="let log of filteredTerminalLogs" [ngClass]="'log-' + log.type">
                    <span class="log-ts">{{ log.timestamp | date:'HH:mm:ss' }}</span>
                    <span class="log-icon">
                        <ng-container [ngSwitch]="log.type">
                            <span *ngSwitchCase="'system'" class="material-symbols-outlined">terminal</span>
                            <span *ngSwitchCase="'info'" class="material-symbols-outlined">info</span>
                            <span *ngSwitchCase="'step'" class="material-symbols-outlined">precision_manufacturing</span>
                            <span *ngSwitchCase="'progress'" class="material-symbols-outlined">check_circle</span>
                            <span *ngSwitchCase="'success'" class="material-symbols-outlined">task_alt</span>
                            <span *ngSwitchCase="'warn'" class="material-symbols-outlined">warning</span>
                            <span *ngSwitchCase="'error'" class="material-symbols-outlined">error</span>
                        </ng-container>
                    </span>
                    <div class="log-content">
                        <span class="log-msg">{{ log.message }}</span>
                        <span class="log-detail" *ngIf="log.detail">{{ log.detail }}</span>
                    </div>
                </div>
                <div class="log-cursor" *ngIf="aiProcessing">
                    <span class="cursor-blink">▎</span>
                </div>
            </div>

            <!-- Scroll-to-bottom FAB -->
            <button class="ai-sidebar__scroll-btn" 
                *ngIf="!isTerminalAtBottom && terminalLogs.length > 15"
                (click)="scrollTerminalToBottom()">
                <span class="material-symbols-outlined">keyboard_double_arrow_down</span>
            </button>
        </aside>
    </div>

    <!-- Attachment Preview Modal -->
    <app-attachment-preview [attachment]="selectedAttachment" [attachments]="currentAttachments"
        [isOpen]="attachmentPreviewOpen" (close)="closeAttachmentPreview()" (download)="downloadAttachment($event)">
    </app-attachment-preview>
</div>