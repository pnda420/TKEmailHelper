<app-page-title title="Posteingang"></app-page-title>

<div class="inbox">
    <!-- AI processing banner -->
    <div class="ai-banner" *ngIf="aiProcessing && aiStatus" (click)="terminalOpen = !terminalOpen">
        <div class="ai-banner__track">
            <div class="ai-banner__fill"
                [style.width.%]="aiStatus.total > 0 ? (aiStatus.processed / aiStatus.total) * 100 : 0"></div>
        </div>
        <div class="ai-banner__content">
            <div class="ai-banner__left">
                <span class="ai-banner__pulse"></span>
                <span class="ai-banner__icon material-symbols-outlined">auto_awesome</span>
                <span class="ai-banner__text">
                    <strong>{{ aiStatus.processed }}<span class="ai-banner__sep">/</span>{{ aiStatus.total }}</strong>
                    E-Mails analysiert
                </span>
            </div>
            <div class="ai-banner__right">
                <span class="ai-banner__eta" *ngIf="terminalEta">{{ terminalEta }}</span>
                <span class="ai-banner__eta" *ngIf="!terminalEta && terminalElapsed">{{ terminalElapsed }}</span>
                <span class="ai-banner__badge">
                    <span class="material-symbols-outlined">{{ terminalOpen ? 'close' : 'terminal' }}</span>
                </span>
            </div>
        </div>
    </div>

    <!-- Compact Toolbar -->
    <header class="inbox-header">
        <div class="header-left">
            <span class="count-badge">{{ totalEmails }}</span>
            <span class="idle-status" [class.connected]="idleConnected"
                  [title]="idleConnected ? 'IMAP IDLE aktiv — neue Mails werden automatisch erkannt' : 'IMAP IDLE nicht verbunden'">
                <span class="idle-dot"></span>
                <span class="idle-label">{{ idleConnected ? 'Live' : 'Offline' }}</span>
            </span>
        </div>

        <div class="search-box">
            <span class="material-symbols-outlined search-icon">search</span>
            <input type="text"
                   [(ngModel)]="searchQuery"
                   (input)="onSearchInput()"
                   placeholder="Suche…"
                   class="search-input" />
            <button class="search-clear" *ngIf="searchQuery" (click)="clearSearch()">
                <span class="material-symbols-outlined">close</span>
            </button>
        </div>

        <div class="filter-group">
            <select class="filter-select" [(ngModel)]="filterTag" (change)="onFilterTagChange()">
                <option value="">Alle Tags</option>
                <option *ngFor="let tag of availableTags" [value]="tag">{{ tag }}</option>
            </select>
            <select class="filter-select" [ngModel]="filterRead === undefined ? '' : filterRead.toString()"
                    (ngModelChange)="onFilterReadChange($event)">
                <option value="">Alle</option>
                <option value="false">Ungelesen</option>
                <option value="true">Gelesen</option>
            </select>
            <button class="filter-clear" *ngIf="hasActiveFilters" (click)="clearFilters()" title="Filter zurücksetzen">
                <span class="material-symbols-outlined">filter_list_off</span>
            </button>
        </div>

        <div class="header-actions">
            <button class="action-btn accent"
                *ngIf="!aiProcessing && aiStatus && aiStatus.pending > 0"
                (click)="processWithAi()">
                <span class="material-symbols-outlined">bolt</span>
                {{ aiStatus.pending }} analysieren
            </button>
            <button class="action-btn"
                *ngIf="isAdmin"
                (click)="recalculateAi()"
                [disabled]="aiProcessing || refreshing"
                title="Alle E-Mails neu analysieren">
                Alle neu analysieren
                <span class="material-symbols-outlined" [class.spin]="aiProcessing">auto_awesome</span>
            </button>
        </div>
    </header>

    <!-- Loading -->
    <div class="inbox-loading" *ngIf="loading">
        <div class="loading-spinner-wrap">
            <div class="loading-spinner"></div>
            <span class="loading-text">E-Mails werden geladen…</span>
        </div>
        <div class="skeleton-row" *ngFor="let i of [1,2,3,4,5,6,7,8]">
            <div class="skeleton-avatar"></div>
            <div class="skeleton-lines">
                <div class="skeleton-line w60"></div>
                <div class="skeleton-line w90"></div>
                <div class="skeleton-line w40"></div>
            </div>
        </div>
    </div>

    <!-- Main split view -->
    <div class="inbox-split" [class.has-sidebar]="terminalOpen" *ngIf="!loading">
        <!-- List pane -->
        <aside class="list-pane" [class.has-detail]="selectedEmail" [@listAnimation]="emails.length">
            <div class="mail-item" *ngFor="let email of emails"
                [class.unread]="!email.isRead"
                [class.active]="selectedEmail?.id === email.id"
                [class.blocked]="email.aiProcessing"
                [class.locked]="email.lockedBy && email.lockedBy !== currentUserId"
                [class.analyzing]="email.aiProcessing && !email.aiProcessedAt"
                (click)="selectEmail(email)">

                <div class="mail-avatar" 
                     [class.ai-pulse]="email.aiProcessing && !email.aiProcessedAt"
                     [style.background-image]="email.fromAddress | identicon">
                    <span class="material-symbols-outlined ai-avatar-icon" *ngIf="email.aiProcessing && !email.aiProcessedAt">auto_awesome</span>
                </div>

                <div class="mail-content">
                    <div class="mail-top">
                        <span class="mail-sender">{{ getSenderName(email) }}</span>
                        <span class="mail-time">{{ formatDate(email.receivedAt) }}</span>
                    </div>
                    <div class="mail-mailbox-row" *ngIf="email.mailboxId && getMailboxName(email.mailboxId)">
                        <span class="mailbox-badge"
                          [style.background-color]="getMailboxColor(email.mailboxId)"
                          [title]="getMailboxName(email.mailboxId)">
                          {{ getMailboxName(email.mailboxId) }}
                        </span>
                    </div>
                    <div class="mail-subject">{{ email.subject }}</div>
                    <div class="mail-snippet"
                        *ngIf="!email.aiProcessing || email.aiSummary || email.aiProcessedAt">
                        {{ email.aiSummary || email.preview || '(Kein Inhalt)' }}
                    </div>
                    <div class="mail-snippet shimmer-line"
                        *ngIf="email.aiProcessing && !email.aiSummary && !email.aiProcessedAt"></div>
                    <div class="mail-tags" *ngIf="email.aiTags?.length">
                        <span class="tag" *ngFor="let tag of email.aiTags">{{ tag }}</span>
                    </div>
                    <!-- AI processing badge -->
                    <div class="mail-ai-badge" *ngIf="email.aiProcessing && !email.aiProcessedAt">
                        <span class="ai-spinner"></span>
                        <span>KI analysiert…</span>
                    </div>
                    <!-- Locked indicator -->
                    <div class="mail-lock-badge" *ngIf="email.lockedBy && email.lockedBy !== currentUserId">
                        <span class="material-symbols-outlined">lock</span>
                        <span>{{ email.lockedByName || 'Benutzer' }}</span>
                    </div>
                </div>

                <div class="mail-meta">
                    <span class="material-symbols-outlined clip-icon" *ngIf="email.hasAttachments"
                        title="Anhänge">attach_file</span>
                    <span class="unread-dot" *ngIf="!email.isRead"></span>
                </div>
            </div>

            <!-- Load more -->
            <div class="list-footer" *ngIf="hasMore">
                <button class="action-btn secondary" (click)="loadMore()">Weitere E-Mails laden</button>
            </div>

            <!-- Empty -->
            <div class="list-empty" *ngIf="emails.length === 0">
                <span class="material-symbols-outlined">markunread_mailbox</span>
                <p>Keine unbearbeiteten E-Mails</p>
                <button class="action-btn primary" (click)="refreshEmails()">E-Mails abrufen</button>
            </div>
        </aside>

        <!-- Detail pane -->
        <main class="detail-pane" *ngIf="selectedEmail" @slideIn>

            <!-- ── Hero Header ── -->
            <div class="detail-hero">
                <div class="hero-row">
                    <button class="hero-back" (click)="closeDetail()">
                        <span class="material-symbols-outlined">arrow_back</span>
                    </button>

                    <div class="hero-sender">
                        <div class="hero-avatar" 
                             [style.background-image]="selectedEmail.fromAddress | identicon">
                        </div>
                        <div class="hero-sender-info">
                            <span class="hero-sender-name">{{ selectedEmail.fromName || selectedEmail.fromAddress }}</span>
                            <span class="hero-sender-meta">
                                <span *ngIf="selectedEmail.fromName" class="hero-email">{{ selectedEmail.fromAddress }}</span>
                                <span class="hero-date">{{ selectedEmail.receivedAt | date:'dd.MM.yy, HH:mm' }}</span>
                            </span>
                        </div>
                    </div>

                    <div class="hero-actions">
                        <button class="hero-icon-btn" *ngIf="isAdmin" (click)="recalculateSingleEmail(selectedEmail)" title="Neu analysieren">
                            <span class="material-symbols-outlined">refresh</span>
                        </button>
                        <button class="hero-icon-btn danger" (click)="moveToTrash()" title="Löschen">
                            <span class="material-symbols-outlined">delete_outline</span>
                        </button>
                        <button class="hero-view-toggle"
                            *ngIf="selectedEmail.aiProcessedAt && selectedEmail.aiSummary"
                            (click)="showAiView = !showAiView"
                            [class.ai-active]="showAiView">
                            <span class="material-symbols-outlined">{{ showAiView ? 'auto_awesome' : 'mail' }}</span>
                            <span class="toggle-label">{{ showAiView ? 'KI-Ansicht' : 'Original' }}</span>
                        </button>
                    </div>
                </div>

                <h2 class="hero-subject">{{ selectedEmail.subject }}</h2>

                <div class="hero-to">
                    <span class="material-symbols-outlined">arrow_forward</span>
                    {{ selectedEmail.toAddresses[0] }}
                    <span class="mailbox-badge-detail" 
                          *ngIf="selectedEmail.mailboxId && getMailboxName(selectedEmail.mailboxId)"
                          [style.background-color]="getMailboxColor(selectedEmail.mailboxId)">
                        {{ getMailboxName(selectedEmail.mailboxId) }}
                    </span>
                </div>
            </div>

            <!-- ── Floating Reply FAB ── -->
            <button class="reply-fab" (click)="openReplyPage()" title="Antworten" @slideIn>
                <span class="reply-fab__shine"></span>
                <span class="reply-fab__label">Antworten</span>
                <span class="material-symbols-outlined reply-fab__icon">send</span>
            </button>

            <!-- ── Tab bar ── -->
            <nav class="detail-tabs">
                <button class="detail-tab" [class.active]="activeDetailTab === 'email'"
                    (click)="switchDetailTab('email')">
                    <span class="material-symbols-outlined">mail</span>
                    E-Mail
                </button>
                <button class="detail-tab" [class.active]="activeDetailTab === 'attachments'"
                    (click)="switchDetailTab('attachments')"
                    *ngIf="selectedEmail.attachments?.length">
                    <span class="material-symbols-outlined">attach_file</span>
                    Anhänge
                    <span class="tab-count">{{ selectedEmail.attachments!.length }}</span>
                </button>
            </nav>

            <!-- ═══ TAB: E-Mail ═══ -->
            <div class="detail-content" *ngIf="activeDetailTab === 'email'">

                <!-- AI summary card -->
                <div class="ai-card" *ngIf="selectedEmail.aiProcessedAt && selectedEmail.aiSummary">
                    <div class="ai-card__sparkle">
                        <span class="material-symbols-outlined">auto_awesome</span>
                    </div>
                    <div class="ai-card__body">
                        <p class="ai-card__text">{{ selectedEmail.aiSummary }}</p>
                        <div class="ai-card__tags" *ngIf="selectedEmail.aiTags?.length">
                            <span class="tag" *ngFor="let tag of selectedEmail.aiTags">{{ tag }}</span>
                        </div>
                    </div>
                </div>

                <!-- Email body -->
                <div class="email-body-wrap">
                    <div *ngIf="showAiView && selectedEmail.aiProcessedAt && selectedEmail.cleanedBody" class="email-body-text">
                        <pre class="body-text">{{ selectedEmail.cleanedBody }}</pre>
                    </div>
                    <div *ngIf="!showAiView || !selectedEmail.aiProcessedAt || !selectedEmail.cleanedBody">
                        <div *ngIf="selectedEmail.htmlBody" class="html-body" [innerHTML]="selectedEmail.htmlBody"></div>
                        <pre *ngIf="!selectedEmail.htmlBody && selectedEmail.textBody"
                            class="body-text">{{ selectedEmail.textBody }}</pre>
                        <p *ngIf="!selectedEmail.htmlBody && !selectedEmail.textBody" class="no-body">(Kein Inhalt)</p>
                    </div>
                </div>

            </div>

            <!-- ═══ TAB: Anhänge ═══ -->
            <div class="detail-content" *ngIf="activeDetailTab === 'attachments'">
                <div class="attachments-grid">
                    <button class="att-card" *ngFor="let att of selectedEmail.attachments; let i = index"
                        (click)="openAttachmentPreview(att, i)">
                        <div class="att-card__icon">
                            <span class="material-symbols-outlined">{{ getAttachmentIcon(att.contentType) }}</span>
                        </div>
                        <div class="att-card__info">
                            <span class="att-card__name">{{ att.filename }}</span>
                            <span class="att-card__size">{{ formatFileSize(att.size) }}</span>
                        </div>
                        <span class="material-symbols-outlined att-card__action">visibility</span>
                    </button>
                </div>
            </div>
        </main>

        <!-- No Selection -->
        <div class="detail-empty" *ngIf="!selectedEmail && !terminalOpen">
            <span class="material-symbols-outlined">mail</span>
            <p>Wähle eine E-Mail aus</p>
        </div>
        <div class="detail-empty" *ngIf="!selectedEmail && terminalOpen">
        </div>

        <!-- AI Sidebar (right split pane) -->
        <aside class="ai-sidebar" *ngIf="terminalOpen">
            <div class="ai-sidebar__header">
                <div class="ai-sidebar__title">
                    <span class="material-symbols-outlined">terminal</span>
                    <span>KI-Verarbeitung</span>
                    <span class="ai-sidebar__badge live" *ngIf="aiProcessing">LIVE</span>
                    <span class="ai-sidebar__badge done" *ngIf="!aiProcessing && terminalLogs.length">DONE</span>
                </div>
                <div class="ai-sidebar__actions">
                    <button class="ai-sidebar__btn" (click)="clearTerminal()" title="Leeren">
                        <span class="material-symbols-outlined">delete_sweep</span>
                    </button>
                    <button class="ai-sidebar__btn" (click)="terminalOpen = false" title="Schließen">
                        <span class="material-symbols-outlined">close</span>
                    </button>
                </div>
            </div>

            <!-- Stats strip -->
            <div class="ai-sidebar__stats" *ngIf="aiStatus">
                <div class="ai-stat">
                    <span class="ai-stat__val">{{ aiStatus.processed }}/{{ aiStatus.total }}</span>
                    <span class="ai-stat__lbl">Verarbeitet</span>
                </div>
                <div class="ai-stat" *ngIf="terminalElapsed">
                    <span class="ai-stat__val">{{ terminalElapsed }}</span>
                    <span class="ai-stat__lbl">Laufzeit</span>
                </div>
                <div class="ai-stat" *ngIf="terminalEta && aiProcessing">
                    <span class="ai-stat__val highlight">{{ terminalEta }}</span>
                    <span class="ai-stat__lbl">ETA</span>
                </div>
            </div>

            <!-- Progress bar -->
            <div class="ai-sidebar__progress" *ngIf="aiProcessing && aiStatus && aiStatus.total > 0">
                <div class="ai-sidebar__progress-bar"
                    [style.width.%]="(aiStatus.processed / aiStatus.total) * 100"></div>
            </div>

            <!-- Log body -->
            <div class="ai-sidebar__body" #terminalBody>
                <div class="log-line" *ngFor="let log of terminalLogs" [ngClass]="'log-' + log.type">
                    <span class="log-ts">{{ log.timestamp | date:'HH:mm:ss' }}</span>
                    <span class="log-icon">
                        <ng-container [ngSwitch]="log.type">
                            <span *ngSwitchCase="'system'" class="material-symbols-outlined">terminal</span>
                            <span *ngSwitchCase="'info'" class="material-symbols-outlined">info</span>
                            <span *ngSwitchCase="'step'" class="material-symbols-outlined">precision_manufacturing</span>
                            <span *ngSwitchCase="'progress'" class="material-symbols-outlined">check_circle</span>
                            <span *ngSwitchCase="'success'" class="material-symbols-outlined">task_alt</span>
                            <span *ngSwitchCase="'warn'" class="material-symbols-outlined">warning</span>
                            <span *ngSwitchCase="'error'" class="material-symbols-outlined">error</span>
                        </ng-container>
                    </span>
                    <div class="log-content">
                        <span class="log-msg">{{ log.message }}</span>
                        <span class="log-detail" *ngIf="log.detail">{{ log.detail }}</span>
                    </div>
                </div>
                <div class="log-cursor" *ngIf="aiProcessing">
                    <span class="cursor-blink">▎</span>
                </div>
            </div>
        </aside>
    </div>

    <!-- Attachment Preview Modal -->
    <app-attachment-preview [attachment]="selectedAttachment" [attachments]="currentAttachments"
        [isOpen]="attachmentPreviewOpen" (close)="closeAttachmentPreview()" (download)="downloadAttachment($event)">
    </app-attachment-preview>
</div>