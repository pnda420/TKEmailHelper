<app-page-title title="Posteingang"></app-page-title>

<div class="inbox">
    <!-- AI processing banner -->
    <div class="ai-banner" *ngIf="aiProcessing && aiStatus" (click)="terminalOpen = !terminalOpen">
        <div class="ai-banner__track">
            <div class="ai-banner__fill"
                [style.width.%]="aiStatus.total > 0 ? (aiStatus.processed / aiStatus.total) * 100 : 0"></div>
        </div>
        <div class="ai-banner__content">
            <div class="ai-banner__left">
                <span class="ai-banner__pulse"></span>
                <span class="ai-banner__icon material-symbols-outlined">auto_awesome</span>
                <span class="ai-banner__text">
                    <strong>{{ aiStatus.processed }}<span class="ai-banner__sep">/</span>{{ aiStatus.total }}</strong>
                    E-Mails analysiert
                </span>
            </div>
            <div class="ai-banner__right">
                <span class="ai-banner__eta" *ngIf="terminalEta">{{ terminalEta }}</span>
                <span class="ai-banner__eta" *ngIf="!terminalEta && terminalElapsed">{{ terminalElapsed }}</span>
                <span class="ai-banner__badge">
                    <span class="material-symbols-outlined">{{ terminalOpen ? 'close' : 'terminal' }}</span>
                </span>
            </div>
        </div>
    </div>

    <!-- Toolbar -->
    <header class="inbox-header">
        <div class="header-left">
            <h2 class="inbox-title">
                <span class="count-badge">{{ totalEmails }}</span>
                E-Mails
            </h2>
            <!-- IMAP IDLE status indicator -->
            <span class="idle-status" [class.connected]="idleConnected"
                  [title]="idleConnected ? 'IMAP IDLE aktiv — neue Mails werden automatisch erkannt' : 'IMAP IDLE nicht verbunden'">
                <span class="idle-dot"></span>
                <span class="idle-label">{{ idleConnected ? 'Live' : 'Offline' }}</span>
            </span>
        </div>
        <div class="header-actions">
            <button class="action-btn accent"
                *ngIf="!aiProcessing && aiStatus && aiStatus.pending > 0"
                (click)="processWithAi()">
                <span class="material-symbols-outlined">bolt</span>
                {{ aiStatus.pending }} analysieren
            </button>
            <button class="action-btn"
                *ngIf="isAdmin"
                (click)="recalculateAi()"
                [disabled]="aiProcessing || refreshing"
                title="Alle E-Mails neu analysieren">
                Alle neu analysieren  <strong>Achtung!</strong>
                <span class="material-symbols-outlined" [class.spin]="aiProcessing">auto_awesome</span>
            </button>
            <button class="action-btn primary"
                (click)="refreshEmails()"
                [disabled]="refreshing">
                <span class="material-symbols-outlined" [class.spin]="refreshing">sync</span>
                Abrufen
            </button>
        </div>
    </header>

    <!-- Search & Filter Bar -->
    <div class="search-filter-bar">
        <div class="search-box">
            <span class="material-symbols-outlined search-icon">search</span>
            <input type="text"
                   [(ngModel)]="searchQuery"
                   (input)="onSearchInput()"
                   placeholder="Suche nach Betreff, Absender, Inhalt..."
                   class="search-input" />
            <button class="search-clear" *ngIf="searchQuery" (click)="clearSearch()">
                <span class="material-symbols-outlined">close</span>
            </button>
        </div>
        <div class="filter-group">
            <select class="filter-select" [(ngModel)]="filterTag" (change)="onFilterTagChange()">
                <option value="">Alle Tags</option>
                <option *ngFor="let tag of availableTags" [value]="tag">{{ tag }}</option>
            </select>
            <select class="filter-select" [ngModel]="filterRead === undefined ? '' : filterRead.toString()"
                    (ngModelChange)="onFilterReadChange($event)">
                <option value="">Alle</option>
                <option value="false">Ungelesen</option>
                <option value="true">Gelesen</option>
            </select>
            <button class="filter-clear" *ngIf="hasActiveFilters" (click)="clearFilters()" title="Filter zurücksetzen">
                <span class="material-symbols-outlined">filter_list_off</span>
            </button>
        </div>
    </div>

    <!-- Loading -->
    <div class="inbox-loading" *ngIf="loading">
        <div class="loading-spinner-wrap">
            <div class="loading-spinner"></div>
            <span class="loading-text">E-Mails werden geladen…</span>
        </div>
        <div class="skeleton-row" *ngFor="let i of [1,2,3,4,5,6,7,8]">
            <div class="skeleton-avatar"></div>
            <div class="skeleton-lines">
                <div class="skeleton-line w60"></div>
                <div class="skeleton-line w90"></div>
                <div class="skeleton-line w40"></div>
            </div>
        </div>
    </div>

    <!-- Main split view -->
    <div class="inbox-split" [class.has-sidebar]="terminalOpen" *ngIf="!loading">
        <!-- List pane -->
        <aside class="list-pane" [class.has-detail]="selectedEmail" [@listAnimation]="emails.length">
            <div class="mail-item" *ngFor="let email of emails"
                [class.unread]="!email.isRead"
                [class.active]="selectedEmail?.id === email.id"
                [class.blocked]="email.aiProcessing"
                [class.locked]="email.lockedBy && email.lockedBy !== currentUserId"
                [class.analyzing]="email.aiProcessing && !email.aiProcessedAt"
                (click)="selectEmail(email)">

                <div class="mail-avatar" [class.unread]="!email.isRead" [class.ai-pulse]="email.aiProcessing && !email.aiProcessedAt">
                    <span class="material-symbols-outlined ai-avatar-icon" *ngIf="email.aiProcessing && !email.aiProcessedAt">auto_awesome</span>
                    <span *ngIf="!email.aiProcessing || email.aiProcessedAt">{{ getSenderInitials(email) }}</span>
                </div>

                <div class="mail-content">
                    <div class="mail-top">
                        <span class="mail-sender">{{ getSenderName(email) }}</span>
                        <span class="mail-time">{{ formatDate(email.receivedAt) }}</span>
                    </div>
                    <div class="mail-subject">{{ email.subject }}</div>
                    <div class="mail-snippet"
                        *ngIf="!email.aiProcessing || email.aiSummary || email.aiProcessedAt">
                        {{ email.aiSummary || email.preview || '(Kein Inhalt)' }}
                    </div>
                    <div class="mail-snippet shimmer-line"
                        *ngIf="email.aiProcessing && !email.aiSummary && !email.aiProcessedAt"></div>
                    <div class="mail-tags" *ngIf="email.aiTags?.length">
                        <span class="tag" *ngFor="let tag of email.aiTags">{{ tag }}</span>
                    </div>
                    <!-- AI processing badge -->
                    <div class="mail-ai-badge" *ngIf="email.aiProcessing && !email.aiProcessedAt">
                        <span class="ai-spinner"></span>
                        <span>KI analysiert…</span>
                    </div>
                    <!-- Locked indicator -->
                    <div class="mail-lock-badge" *ngIf="email.lockedBy && email.lockedBy !== currentUserId">
                        <span class="material-symbols-outlined">lock</span>
                        <span>{{ email.lockedByName || 'Benutzer' }}</span>
                    </div>
                </div>

                <div class="mail-meta">
                    <span class="material-symbols-outlined clip-icon" *ngIf="email.hasAttachments"
                        title="Anhänge">attach_file</span>
                    <span class="unread-dot" *ngIf="!email.isRead"></span>
                </div>
            </div>

            <!-- Load more -->
            <div class="list-footer" *ngIf="hasMore">
                <button class="action-btn secondary" (click)="loadMore()">Weitere E-Mails laden</button>
            </div>

            <!-- Empty -->
            <div class="list-empty" *ngIf="emails.length === 0">
                <span class="material-symbols-outlined">markunread_mailbox</span>
                <p>Keine unbearbeiteten E-Mails</p>
                <button class="action-btn primary" (click)="refreshEmails()">E-Mails abrufen</button>
            </div>
        </aside>

        <!-- Detail pane -->
        <main class="detail-pane" *ngIf="selectedEmail" @slideIn>
            <!-- Compact top bar -->
            <div class="detail-topbar">
                <button class="topbar-back" (click)="closeDetail()">
                    <span class="material-symbols-outlined">arrow_back</span>
                </button>
                <div class="topbar-spacer"></div>
                <button class="topbar-icon-btn" *ngIf="isAdmin" (click)="recalculateSingleEmail(selectedEmail)" title="Neu analysieren">
                    <span class="material-symbols-outlined">refresh</span>
                </button>
                <button class="topbar-icon-btn danger" (click)="moveToTrash()" title="Löschen">
                    <span class="material-symbols-outlined">delete_outline</span>
                </button>
                <button class="topbar-reply-btn" (click)="openReplyPage()">
                    <span class="material-symbols-outlined">reply</span>
                    Antworten
                </button>
            </div>

            <!-- Sender card -->
            <div class="sender-card">
                <div class="sender-avatar">{{ getSenderInitials(selectedEmail) }}</div>
                <div class="sender-info">
                    <div class="sender-name">{{ selectedEmail.fromName || selectedEmail.fromAddress }}</div>
                    <div class="sender-email" *ngIf="selectedEmail.fromName">{{ selectedEmail.fromAddress }}</div>
                </div>
                <div class="sender-date">{{ selectedEmail.receivedAt | date:'dd.MM.yy, HH:mm' }}</div>
            </div>

            <!-- Subject -->
            <div class="detail-subject-bar">
                <h2 class="detail-subject">{{ selectedEmail.subject }}</h2>
                <div class="detail-to">
                    <span class="material-symbols-outlined">arrow_forward</span>
                    {{ selectedEmail.toAddresses[0] }}
                </div>
            </div>

            <!-- Tab bar -->
            <nav class="detail-tabs">
                <button class="detail-tab" [class.active]="activeDetailTab === 'email'"
                    (click)="switchDetailTab('email')">
                    <span class="material-symbols-outlined">mail</span>
                    E-Mail
                </button>
                <button class="detail-tab" [class.active]="activeDetailTab === 'thread'"
                    (click)="switchDetailTab('thread')">
                    <span class="material-symbols-outlined">forum</span>
                    Konversation
                    <span class="tab-count" *ngIf="threadEmails.length > 0">{{ threadEmails.length }}</span>
                </button>
                <button class="detail-tab" [class.active]="activeDetailTab === 'history'"
                    (click)="switchDetailTab('history')">
                    <span class="material-symbols-outlined">history</span>
                    Verlauf
                    <span class="tab-count" *ngIf="customerHistory.length > 0">{{ customerHistory.length }}</span>
                </button>
            </nav>

            <!-- ═══ TAB: E-Mail ═══ -->
            <div class="detail-content" *ngIf="activeDetailTab === 'email'">
                <!-- AI summary card -->
                <div class="ai-summary-card" *ngIf="selectedEmail.aiProcessedAt && selectedEmail.aiSummary">
                    <div class="ai-summary-card__header">
                        <span class="material-symbols-outlined">auto_awesome</span>
                        KI-Zusammenfassung
                        <button class="ai-toggle-btn" (click)="showAiView = !showAiView">
                            {{ showAiView ? 'Original zeigen' : 'Zusammenfassung zeigen' }}
                        </button>
                    </div>
                    <p class="ai-summary-card__text" *ngIf="showAiView">{{ selectedEmail.aiSummary }}</p>
                    <div class="ai-summary-card__tags" *ngIf="showAiView && selectedEmail.aiTags?.length">
                        <span class="tag" *ngFor="let tag of selectedEmail.aiTags">{{ tag }}</span>
                    </div>
                </div>

                <!-- Email body -->
                <div class="email-body-wrap">
                    <div *ngIf="showAiView && selectedEmail.aiProcessedAt && selectedEmail.cleanedBody" class="email-body-text">
                        <pre class="body-text">{{ selectedEmail.cleanedBody }}</pre>
                    </div>
                    <div *ngIf="!showAiView || !selectedEmail.aiProcessedAt || !selectedEmail.cleanedBody">
                        <div *ngIf="selectedEmail.htmlBody" class="html-body" [innerHTML]="selectedEmail.htmlBody"></div>
                        <pre *ngIf="!selectedEmail.htmlBody && selectedEmail.textBody"
                            class="body-text">{{ selectedEmail.textBody }}</pre>
                        <p *ngIf="!selectedEmail.htmlBody && !selectedEmail.textBody" class="no-body">(Kein Inhalt)</p>
                    </div>
                </div>

                <!-- Attachments inline -->
                <div class="attachments-section" *ngIf="selectedEmail.attachments?.length">
                    <div class="attachments-label">
                        <span class="material-symbols-outlined">attach_file</span>
                        {{ selectedEmail.attachments!.length }} Anhäng{{ selectedEmail.attachments!.length === 1 ? '' : 'e' }}
                    </div>
                    <div class="attachments-list">
                        <button class="att-chip" *ngFor="let att of selectedEmail.attachments; let i = index"
                            (click)="openAttachmentPreview(att, i)">
                            <span class="material-symbols-outlined">{{ getAttachmentIcon(att.contentType) }}</span>
                            <span class="att-name">{{ att.filename }}</span>
                            <span class="att-size">{{ formatFileSize(att.size) }}</span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- ═══ TAB: Konversation ═══ -->
            <div class="detail-content" *ngIf="activeDetailTab === 'thread'">
                <div class="tab-loading" *ngIf="threadLoading">
                    <div class="loading-spinner"></div>
                    <span>Konversation wird geladen…</span>
                </div>
                <div class="tab-empty" *ngIf="!threadLoading && threadEmails.length === 0">
                    <span class="material-symbols-outlined">forum</span>
                    <p>Keine weiteren Nachrichten in dieser Konversation</p>
                </div>
                <div class="thread-list" *ngIf="threadEmails.length > 0">
                    <div class="thread-card" *ngFor="let te of threadEmails"
                         [class.current]="te.id === selectedEmail.id"
                         [class.sent]="te.status === 'sent'"
                         (click)="selectEmail(te)">
                        <div class="thread-card__left">
                            <div class="thread-card__avatar" [class.sent]="te.status === 'sent'">
                                {{ getSenderInitials(te) }}
                            </div>
                            <div class="thread-card__line" *ngIf="te !== threadEmails[threadEmails.length - 1]"></div>
                        </div>
                        <div class="thread-card__body">
                            <div class="thread-card__top">
                                <span class="thread-card__sender">{{ te.fromName || te.fromAddress }}</span>
                                <span class="thread-card__badge sent" *ngIf="te.status === 'sent'">Gesendet</span>
                                <span class="thread-card__date">{{ formatDate(te.receivedAt) }}</span>
                            </div>
                            <div class="thread-card__subject" *ngIf="te.subject !== selectedEmail.subject">{{ te.subject }}</div>
                            <div class="thread-card__preview">{{ te.aiSummary || te.preview || '(Kein Inhalt)' }}</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ═══ TAB: Kundenhistorie ═══ -->
            <div class="detail-content" *ngIf="activeDetailTab === 'history'">
                <div class="tab-loading" *ngIf="historyLoading">
                    <div class="loading-spinner"></div>
                    <span>Verlauf wird geladen…</span>
                </div>
                <div class="tab-empty" *ngIf="!historyLoading && customerHistory.length === 0">
                    <span class="material-symbols-outlined">history</span>
                    <p>Kein bisheriger Verlauf mit diesem Kontakt</p>
                </div>
                <div class="thread-list" *ngIf="customerHistory.length > 0">
                    <div class="thread-card" *ngFor="let ce of customerHistory"
                         [class.current]="ce.id === selectedEmail.id"
                         [class.sent]="ce.status === 'sent'"
                         [class.trash]="ce.status === 'trash'"
                         (click)="selectEmail(ce)">
                        <div class="thread-card__left">
                            <div class="thread-card__avatar" [class.sent]="ce.status === 'sent'">
                                {{ getSenderInitials(ce) }}
                            </div>
                            <div class="thread-card__line" *ngIf="ce !== customerHistory[customerHistory.length - 1]"></div>
                        </div>
                        <div class="thread-card__body">
                            <div class="thread-card__top">
                                <span class="thread-card__sender">{{ ce.fromName || ce.fromAddress }}</span>
                                <span class="thread-card__badge sent" *ngIf="ce.status === 'sent'">Gesendet</span>
                                <span class="thread-card__badge trash" *ngIf="ce.status === 'trash'">Papierkorb</span>
                                <span class="thread-card__date">{{ formatDate(ce.receivedAt) }}</span>
                            </div>
                            <div class="thread-card__subject">{{ ce.subject }}</div>
                            <div class="thread-card__preview">{{ ce.aiSummary || ce.preview || '(Kein Inhalt)' }}</div>
                            <div class="thread-card__tags" *ngIf="ce.aiTags?.length">
                                <span class="tag mini" *ngFor="let tag of ce.aiTags">{{ tag }}</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <!-- No Selection -->
        <div class="detail-empty" *ngIf="!selectedEmail && !terminalOpen">
            <span class="material-symbols-outlined">mail</span>
            <p>Wähle eine E-Mail aus</p>
        </div>
        <div class="detail-empty" *ngIf="!selectedEmail && terminalOpen">
        </div>

        <!-- AI Sidebar (right split pane) -->
        <aside class="ai-sidebar" *ngIf="terminalOpen">
            <div class="ai-sidebar__header">
                <div class="ai-sidebar__title">
                    <span class="material-symbols-outlined">terminal</span>
                    <span>KI-Verarbeitung</span>
                    <span class="ai-sidebar__badge live" *ngIf="aiProcessing">LIVE</span>
                    <span class="ai-sidebar__badge done" *ngIf="!aiProcessing && terminalLogs.length">DONE</span>
                </div>
                <div class="ai-sidebar__actions">
                    <button class="ai-sidebar__btn" (click)="clearTerminal()" title="Leeren">
                        <span class="material-symbols-outlined">delete_sweep</span>
                    </button>
                    <button class="ai-sidebar__btn" (click)="terminalOpen = false" title="Schließen">
                        <span class="material-symbols-outlined">close</span>
                    </button>
                </div>
            </div>

            <!-- Stats strip -->
            <div class="ai-sidebar__stats" *ngIf="aiStatus">
                <div class="ai-stat">
                    <span class="ai-stat__val">{{ aiStatus.processed }}/{{ aiStatus.total }}</span>
                    <span class="ai-stat__lbl">Verarbeitet</span>
                </div>
                <div class="ai-stat" *ngIf="terminalElapsed">
                    <span class="ai-stat__val">{{ terminalElapsed }}</span>
                    <span class="ai-stat__lbl">Laufzeit</span>
                </div>
                <div class="ai-stat" *ngIf="terminalEta && aiProcessing">
                    <span class="ai-stat__val highlight">{{ terminalEta }}</span>
                    <span class="ai-stat__lbl">ETA</span>
                </div>
            </div>

            <!-- Progress bar -->
            <div class="ai-sidebar__progress" *ngIf="aiProcessing && aiStatus && aiStatus.total > 0">
                <div class="ai-sidebar__progress-bar"
                    [style.width.%]="(aiStatus.processed / aiStatus.total) * 100"></div>
            </div>

            <!-- Log body -->
            <div class="ai-sidebar__body" #terminalBody>
                <div class="log-line" *ngFor="let log of terminalLogs" [ngClass]="'log-' + log.type">
                    <span class="log-ts">{{ log.timestamp | date:'HH:mm:ss' }}</span>
                    <span class="log-icon">
                        <ng-container [ngSwitch]="log.type">
                            <span *ngSwitchCase="'system'" class="material-symbols-outlined">terminal</span>
                            <span *ngSwitchCase="'info'" class="material-symbols-outlined">info</span>
                            <span *ngSwitchCase="'step'" class="material-symbols-outlined">precision_manufacturing</span>
                            <span *ngSwitchCase="'progress'" class="material-symbols-outlined">check_circle</span>
                            <span *ngSwitchCase="'success'" class="material-symbols-outlined">task_alt</span>
                            <span *ngSwitchCase="'warn'" class="material-symbols-outlined">warning</span>
                            <span *ngSwitchCase="'error'" class="material-symbols-outlined">error</span>
                        </ng-container>
                    </span>
                    <div class="log-content">
                        <span class="log-msg">{{ log.message }}</span>
                        <span class="log-detail" *ngIf="log.detail">{{ log.detail }}</span>
                    </div>
                </div>
                <div class="log-cursor" *ngIf="aiProcessing">
                    <span class="cursor-blink">▎</span>
                </div>
            </div>
        </aside>
    </div>

    <!-- Attachment Preview Modal -->
    <app-attachment-preview [attachment]="selectedAttachment" [attachments]="currentAttachments"
        [isOpen]="attachmentPreviewOpen" (close)="closeAttachmentPreview()" (download)="downloadAttachment($event)">
    </app-attachment-preview>
</div>