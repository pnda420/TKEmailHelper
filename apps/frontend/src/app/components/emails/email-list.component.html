<app-page-title title="Posteingang"></app-page-title>

<div class="inbox">
    <!-- Processing progress bar (thin, unobtrusive) -->
    <div class="progress-strip" *ngIf="aiProcessing && aiStatus">
        <div class="progress-strip__bar"
            [style.width.%]="aiStatus.total > 0 ? (aiStatus.processed / aiStatus.total) * 100 : 0"></div>
        <span class="progress-strip__label">
            <span class="material-symbols-outlined spin">auto_awesome</span>
            {{ aiStatus.processed }}/{{ aiStatus.total }} analysiert
            <span class="progress-strip__hint">— läuft im Hintergrund</span>
        </span>
    </div>

    <!-- Toolbar -->
    <header class="inbox-header">
        <div class="header-left">
            <h2 class="inbox-title">
                <span class="count-badge">{{ totalEmails }}</span>
                E-Mails
            </h2>
        </div>
        <div class="header-actions">
            <button class="action-btn accent"
                *ngIf="!aiProcessing && aiStatus && aiStatus.pending > 0"
                (click)="processWithAi()">
                <span class="material-symbols-outlined">bolt</span>
                {{ aiStatus.pending }} analysieren
            </button>
            <button class="action-btn"
                (click)="recalculateAi()"
                [disabled]="aiProcessing || refreshing"
                title="Alle E-Mails neu analysieren">
                <span class="material-symbols-outlined" [class.spin]="aiProcessing">auto_awesome</span>
            </button>
            <button class="action-btn primary"
                (click)="refreshEmails()"
                [disabled]="refreshing">
                <span class="material-symbols-outlined" [class.spin]="refreshing">sync</span>
                Abrufen
            </button>
        </div>
    </header>

    <!-- Loading skeleton -->
    <div class="inbox-loading" *ngIf="loading">
        <div class="skeleton-row" *ngFor="let i of [1,2,3,4,5,6]">
            <div class="skeleton-avatar"></div>
            <div class="skeleton-lines">
                <div class="skeleton-line w60"></div>
                <div class="skeleton-line w90"></div>
                <div class="skeleton-line w40"></div>
            </div>
        </div>
    </div>

    <!-- Main split view -->
    <div class="inbox-split" *ngIf="!loading">
        <!-- List pane -->
        <aside class="list-pane" [class.has-detail]="selectedEmail" [@listAnimation]="emails.length">
            <div class="mail-item" *ngFor="let email of emails"
                [class.unread]="!email.isRead"
                [class.active]="selectedEmail?.id === email.id"
                [class.blocked]="aiProcessing"
                [class.analyzing]="aiProcessing && !email.aiProcessedAt"
                (click)="selectEmail(email)">

                <div class="mail-avatar" [class.unread]="!email.isRead">
                    {{ getSenderInitials(email) }}
                </div>

                <div class="mail-content">
                    <div class="mail-top">
                        <span class="mail-sender">{{ getSenderName(email) }}</span>
                        <span class="mail-time">{{ formatDate(email.receivedAt) }}</span>
                    </div>
                    <div class="mail-subject">{{ email.subject }}</div>
                    <div class="mail-snippet"
                        *ngIf="!aiProcessing || email.aiSummary || email.aiProcessedAt">
                        {{ email.aiSummary || email.preview || '(Kein Inhalt)' }}
                    </div>
                    <div class="mail-snippet shimmer-line"
                        *ngIf="aiProcessing && !email.aiSummary && !email.aiProcessedAt"></div>
                    <div class="mail-tags" *ngIf="email.aiTags?.length">
                        <span class="tag" *ngFor="let tag of email.aiTags">{{ tag }}</span>
                    </div>
                </div>

                <div class="mail-meta">
                    <span class="material-symbols-outlined clip-icon" *ngIf="email.hasAttachments"
                        title="Anhänge">attach_file</span>
                    <span class="unread-dot" *ngIf="!email.isRead"></span>
                </div>
            </div>

            <!-- Load more -->
            <div class="list-footer" *ngIf="hasMore">
                <button class="action-btn secondary" (click)="loadMore()">Weitere E-Mails laden</button>
            </div>

            <!-- Empty -->
            <div class="list-empty" *ngIf="emails.length === 0">
                <span class="material-symbols-outlined">markunread_mailbox</span>
                <p>Keine unbearbeiteten E-Mails</p>
                <button class="action-btn primary" (click)="refreshEmails()">E-Mails abrufen</button>
            </div>
        </aside>

        <!-- Detail pane -->
        <main class="detail-pane" *ngIf="selectedEmail" @slideIn>
            <!-- Actions -->
            <div class="detail-actions">
                <button class="action-btn success" (click)="openReplyPage()">
                    <span class="material-symbols-outlined">reply</span>
                    Antworten
                </button>
                <button class="action-btn danger-ghost" (click)="moveToTrash()" title="Keine Antwort nötig">
                    <span class="material-symbols-outlined">delete_outline</span>
                </button>
                <div class="spacer"></div>
                <div class="view-switch" *ngIf="selectedEmail.aiProcessedAt">
                    <button [class.active]="showAiView" (click)="showAiView = true">
                        <span class="material-symbols-outlined">auto_awesome</span> KI
                    </button>
                    <button [class.active]="!showAiView" (click)="showAiView = false">
                        <span class="material-symbols-outlined">article</span> Original
                    </button>
                </div>
                <button class="action-btn ghost" (click)="closeDetail()">
                    <span class="material-symbols-outlined">close</span>
                </button>
            </div>

            <!-- Header -->
            <div class="detail-header">
                <h2 class="detail-subject">{{ selectedEmail.subject }}</h2>
                <div class="detail-meta">
                    <strong>{{ selectedEmail.fromName || selectedEmail.fromAddress }}</strong>
                    <span class="meta-addr" *ngIf="selectedEmail.fromName">&lt;{{ selectedEmail.fromAddress }}&gt;</span>
                    <span class="meta-arrow">→</span>
                    <span class="meta-to">{{ selectedEmail.toAddresses[0] }}</span>
                    <span class="meta-date">{{ selectedEmail.receivedAt | date:'dd.MM.yyyy HH:mm' }}</span>
                </div>
            </div>

            <!-- AI View -->
            <div class="detail-body" *ngIf="showAiView && selectedEmail.aiProcessedAt">
                <div class="ai-card">
                    <div class="ai-card__header">
                        <span class="material-symbols-outlined">auto_awesome</span>
                        Zusammenfassung
                    </div>
                    <p class="ai-card__text">{{ selectedEmail.aiSummary }}</p>
                    <div class="ai-card__tags" *ngIf="selectedEmail.aiTags?.length">
                        <span class="tag" *ngFor="let tag of selectedEmail.aiTags">{{ tag }}</span>
                    </div>
                </div>
                <div class="clean-body" *ngIf="selectedEmail.cleanedBody">
                    <pre class="body-text">{{ selectedEmail.cleanedBody }}</pre>
                </div>
            </div>

            <!-- Original View -->
            <div class="detail-body" *ngIf="!showAiView || !selectedEmail.aiProcessedAt">
                <div *ngIf="selectedEmail.htmlBody" class="html-body" [innerHTML]="selectedEmail.htmlBody"></div>
                <pre *ngIf="!selectedEmail.htmlBody && selectedEmail.textBody"
                    class="body-text">{{ selectedEmail.textBody }}</pre>
                <p *ngIf="!selectedEmail.htmlBody && !selectedEmail.textBody" class="no-body">(Kein Inhalt)</p>
            </div>

            <!-- Attachments -->
            <div class="detail-attachments" *ngIf="selectedEmail.attachments?.length">
                <button class="att-chip" *ngFor="let att of selectedEmail.attachments; let i = index"
                    (click)="openAttachmentPreview(att, i)">
                    <span class="material-symbols-outlined">{{ getAttachmentIcon(att.contentType) }}</span>
                    <span class="att-name">{{ att.filename }}</span>
                    <span class="att-size">{{ formatFileSize(att.size) }}</span>
                </button>
            </div>
        </main>

        <!-- No Selection -->
        <div class="detail-empty" *ngIf="!selectedEmail">
            <span class="material-symbols-outlined">mail</span>
            <p>Wähle eine E-Mail aus</p>
        </div>
    </div>

    <!-- Attachment Preview Modal -->
    <app-attachment-preview [attachment]="selectedAttachment" [attachments]="currentAttachments"
        [isOpen]="attachmentPreviewOpen" (close)="closeAttachmentPreview()" (download)="downloadAttachment($event)">
    </app-attachment-preview>
</div>