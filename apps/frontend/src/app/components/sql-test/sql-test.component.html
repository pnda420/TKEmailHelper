<div class="sql-test">

  <!-- Header -->
  <div class="page-header">
    <h1>
      <span class="material-symbols-outlined">database</span>
      SQL Query Tool
    </h1>
    <span class="sql-test__stats" *ngIf="result">
      {{ result.rowCount }} Ergebnis{{ result.rowCount !== 1 ? 'se' : '' }} in {{ result.duration }}ms
    </span>
    <span class="sql-test__hint">Ctrl + Enter</span>
    <button class="btn-execute" (click)="executeQuery()" [disabled]="loading || !sqlInput.trim()">
      <span class="material-symbols-outlined">play_arrow</span>
      {{ loading ? 'Läuft...' : 'Ausführen' }}
    </button>
  </div>

  <!-- Input Section -->
  <div class="input-section">
    <textarea
      class="sql-textarea"
      [(ngModel)]="sqlInput"
      (keydown)="onKeydown($event)"
      placeholder="SELECT * FROM ..."
      spellcheck="false"
      autocomplete="off"
    ></textarea>
  </div>

  <!-- Loading -->
  <div class="state-fill" *ngIf="loading">
    <div class="spinner"></div>
    <span>Query wird ausgeführt...</span>
  </div>

  <!-- Error -->
  <div class="error-bar" *ngIf="error">
    <span class="material-symbols-outlined">error</span>
    <span>{{ error }}</span>
  </div>

  <!-- Results Table -->
  <div class="table-wrap" *ngIf="result && result.recordset.length > 0">
    <table class="results-table">
      <thead>
        <tr>
          <th *ngFor="let col of columns">{{ col }}</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let row of result.recordset">
          <td *ngFor="let col of columns">{{ row[col] }}</td>
        </tr>
      </tbody>
    </table>
  </div>

  <!-- No Results -->
  <div class="state-fill" *ngIf="result && result.recordset.length === 0 && !loading">
    <span class="material-symbols-outlined">info</span>
    <span>Keine Ergebnisse gefunden.</span>
  </div>

  <!-- Query History -->
  <div class="history-strip" *ngIf="history.length > 0">
    <span class="history-label">History:</span>
    <div class="history-items">
      <button
        *ngFor="let item of history"
        class="history-item"
        [class.history-item--error]="item.error"
        (click)="loadFromHistory(item)"
        [title]="item.sql"
      >
        <span class="history-sql">{{ truncate(item.sql) }}</span>
        <span class="history-meta">
          <ng-container *ngIf="!item.error">{{ item.rowCount }} Zeilen</ng-container>
          <ng-container *ngIf="item.error"><span class="material-symbols-outlined">error</span></ng-container>
          &middot; {{ item.timestamp | date:'HH:mm' }}
        </span>
      </button>
    </div>
  </div>

</div>
