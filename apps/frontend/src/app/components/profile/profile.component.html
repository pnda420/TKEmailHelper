<section class="profile-page">
  <div class="profile-container" *ngIf="user">

    <!-- Page Header -->
    <div class="page-header">
      <h1 class="page-title">
        <span class="material-symbols-outlined ms-fill">settings</span>
        Profil &amp; Einstellungen
      </h1>
      <button class="logout-btn" (click)="logout()">
        <span class="material-symbols-outlined ms-size-20">logout</span>
        Abmelden
      </button>
    </div>

    <!-- Profile Identity Bar -->
    <div class="identity-card">
      <div class="identity-left">
        <div class="avatar">{{ user.name.charAt(0).toUpperCase() }}</div>
        <div class="identity-info">
          <!-- Name display / edit -->
          <div class="name-row" *ngIf="!editMode">
            <h2 class="user-name">{{ user.name }}</h2>
            <button class="icon-btn-subtle" (click)="toggleEditMode()" title="Name bearbeiten">
              <span class="material-symbols-outlined ms-size-18">edit</span>
            </button>
          </div>
          <form class="name-edit-row" *ngIf="editMode" (ngSubmit)="saveProfile()">
            <input type="text" [(ngModel)]="editName" name="editName" placeholder="Dein Name" required minlength="2" maxlength="100" class="name-input" />
            <button type="submit" class="btn btn--primary btn--sm" [disabled]="saving">
              <span class="spinner-small" *ngIf="saving"></span>
              {{ saving ? '...' : 'Speichern' }}
            </button>
            <button type="button" class="btn btn--ghost btn--sm" (click)="cancelEdit()">Abbrechen</button>
          </form>
          <p class="user-email">{{ user.email }}</p>
          <div class="user-meta">
            <span class="role-chip" [ngClass]="getRoleBadgeClass()">
              <span class="material-symbols-outlined ms-size-14 ms-fill">{{ getRoleIcon() }}</span>
              {{ getRoleLabel() }}
            </span>
            <span class="verified-chip" *ngIf="user.isVerified">
              <span class="material-symbols-outlined ms-size-14 ms-fill">verified</span>
              Verifiziert
            </span>
            <span class="id-chip">
              <span class="material-symbols-outlined ms-size-14">fingerprint</span>
              {{ user.id.substring(0, 8) }}...
              <button class="copy-inline" (click)="copyToClipboard(user.id)" title="ID kopieren">
                <span class="material-symbols-outlined ms-size-14">content_copy</span>
              </button>
            </span>
          </div>
        </div>
      </div>
    </div>

    <!-- Settings Grid: Two Columns -->
    <div class="settings-grid">

      <!-- LEFT: KI-Kontext -->
      <div class="settings-card">
        <div class="card-header">
          <div class="card-title">
            <span class="material-symbols-outlined card-icon">psychology</span>
            <h2>KI-Kontext</h2>
          </div>
          <span class="status-pill" [class.active]="hasSignature()">
            {{ hasSignature() ? 'Konfiguriert' : 'Nicht konfiguriert' }}
          </span>
        </div>
        <p class="card-desc">Diese Daten werden der KI übergeben, damit sie weiß wer du bist und personalisierte Antworten generieren kann.</p>

        <form (ngSubmit)="saveSignature()" class="ki-form">
          <div class="field">
            <label for="sigName">
              <span class="material-symbols-outlined ms-size-16">person</span>
              Name
            </label>
            <input type="text" id="sigName" [(ngModel)]="editSignature.name" name="sigName" placeholder="z.B. Max Mustermann" maxlength="100" />
          </div>
          <div class="field">
            <label for="sigPosition">
              <span class="material-symbols-outlined ms-size-16">work</span>
              Position / Titel
            </label>
            <input type="text" id="sigPosition" [(ngModel)]="editSignature.position" name="sigPosition" placeholder="z.B. Geschäftsführer" maxlength="100" />
          </div>
          <button type="submit" class="btn btn--primary btn--block" [disabled]="signatureSaving">
            <span class="material-symbols-outlined ms-size-20" *ngIf="!signatureSaving">check</span>
            <span class="spinner-small" *ngIf="signatureSaving"></span>
            {{ signatureSaving ? 'Speichern...' : 'KI-Kontext speichern' }}
          </button>
        </form>
      </div>

      <!-- RIGHT: Zugewiesene Postfächer -->
      <div class="settings-card">
        <div class="card-header">
          <div class="card-title">
            <span class="material-symbols-outlined card-icon">mail</span>
            <h2>Zugewiesene Postfächer</h2>
          </div>
          <span class="status-pill" [class.active]="myMailboxes.length > 0">
            {{ myMailboxes.length }} Postfächer
          </span>
        </div>
        <p class="card-desc">Die dir zugewiesenen Postfächer. Signaturen und Firmendaten werden pro Postfach vom Administrator konfiguriert.</p>

        <div class="mailbox-list" *ngIf="myMailboxes.length > 0">
          <div class="mailbox-item" *ngFor="let um of myMailboxes" [style.border-left-color]="um.mailbox.color || '#1565c0'">
            <div class="mailbox-item-header">
              <span class="mailbox-name">{{ um.mailbox.name }}</span>
              <span class="mailbox-active-badge" *ngIf="um.isActive">Aktiv</span>
            </div>
            <span class="mailbox-email">{{ um.mailbox.email }}</span>
            <span class="mailbox-company" *ngIf="um.mailbox.companyName">{{ um.mailbox.companyName }}</span>
          </div>
        </div>

        <div class="sig-empty" *ngIf="myMailboxes.length === 0">
          <span class="material-symbols-outlined">mail</span>
          <p>Noch keine Postfächer zugewiesen</p>
          <p class="card-desc">Ein Administrator muss dir Postfächer zuweisen.</p>
        </div>
      </div>

    </div>
  </div>

  <!-- Loading State -->
  <div class="loading-state" *ngIf="!user">
    <div class="spinner"></div>
    <p>Lade Profil...</p>
  </div>
</section>