<section class="profile-page">
  <div class="profile-container" *ngIf="user">

    <!-- Page Header -->
    <div class="page-header">
      <h1 class="page-title">
        <span class="material-symbols-outlined ms-fill">settings</span>
        Profil &amp; Einstellungen
      </h1>
      <button class="logout-btn" (click)="logout()">
        <span class="material-symbols-outlined ms-size-20">logout</span>
        Abmelden
      </button>
    </div>

    <!-- Profile Identity Bar -->
    <div class="identity-card">
      <div class="identity-left">
        <div class="avatar">{{ user.name.charAt(0).toUpperCase() }}</div>
        <div class="identity-info">
          <!-- Name display / edit -->
          <div class="name-row" *ngIf="!editMode">
            <h2 class="user-name">{{ user.name }}</h2>
            <button class="icon-btn-subtle" (click)="toggleEditMode()" title="Name bearbeiten">
              <span class="material-symbols-outlined ms-size-18">edit</span>
            </button>
          </div>
          <form class="name-edit-row" *ngIf="editMode" (ngSubmit)="saveProfile()">
            <input type="text" [(ngModel)]="editName" name="editName" placeholder="Dein Name" required minlength="2" maxlength="100" class="name-input" />
            <button type="submit" class="btn btn--primary btn--sm" [disabled]="saving">
              <span class="spinner-small" *ngIf="saving"></span>
              {{ saving ? '...' : 'Speichern' }}
            </button>
            <button type="button" class="btn btn--ghost btn--sm" (click)="cancelEdit()">Abbrechen</button>
          </form>
          <p class="user-email">{{ user.email }}</p>
          <div class="user-meta">
            <span class="role-chip" [ngClass]="getRoleBadgeClass()">
              <span class="material-symbols-outlined ms-size-14 ms-fill">{{ getRoleIcon() }}</span>
              {{ getRoleLabel() }}
            </span>
            <span class="verified-chip" *ngIf="user.isVerified">
              <span class="material-symbols-outlined ms-size-14 ms-fill">verified</span>
              Verifiziert
            </span>
            <span class="id-chip">
              <span class="material-symbols-outlined ms-size-14">fingerprint</span>
              {{ user.id.substring(0, 8) }}...
              <button class="copy-inline" (click)="copyToClipboard(user.id)" title="ID kopieren">
                <span class="material-symbols-outlined ms-size-14">content_copy</span>
              </button>
            </span>
          </div>
        </div>
      </div>
    </div>

    <!-- Settings Grid: Two Columns -->
    <div class="settings-grid">

      <!-- LEFT: KI-Kontext -->
      <div class="settings-card">
        <div class="card-header">
          <div class="card-title">
            <span class="material-symbols-outlined card-icon">psychology</span>
            <h2>KI-Kontext</h2>
          </div>
          <span class="status-pill" [class.active]="hasSignature()">
            {{ hasSignature() ? 'Konfiguriert' : 'Nicht konfiguriert' }}
          </span>
        </div>
        <p class="card-desc">Diese Daten werden der KI übergeben, damit sie weiß wer du bist und personalisierte Antworten generieren kann.</p>

        <form (ngSubmit)="saveSignature()" class="ki-form">
          <div class="field">
            <label for="sigName">
              <span class="material-symbols-outlined ms-size-16">person</span>
              Name
            </label>
            <input type="text" id="sigName" [(ngModel)]="editSignature.name" name="sigName" placeholder="z.B. Max Mustermann" maxlength="100" />
          </div>
          <div class="field">
            <label for="sigPosition">
              <span class="material-symbols-outlined ms-size-16">work</span>
              Position / Titel
            </label>
            <input type="text" id="sigPosition" [(ngModel)]="editSignature.position" name="sigPosition" placeholder="z.B. Geschäftsführer" maxlength="100" />
          </div>
          <div class="field">
            <label for="sigCompany">
              <span class="material-symbols-outlined ms-size-16">business</span>
              Firma
            </label>
            <input type="text" id="sigCompany" [(ngModel)]="editSignature.company" name="sigCompany" placeholder="z.B. Muster GmbH" maxlength="100" />
          </div>
          <div class="field">
            <label for="sigPhone">
              <span class="material-symbols-outlined ms-size-16">phone</span>
              Telefon
            </label>
            <input type="text" id="sigPhone" [(ngModel)]="editSignature.phone" name="sigPhone" placeholder="z.B. +49 123 456789" maxlength="50" />
          </div>
          <div class="field">
            <label for="sigWebsite">
              <span class="material-symbols-outlined ms-size-16">language</span>
              Website
            </label>
            <input type="text" id="sigWebsite" [(ngModel)]="editSignature.website" name="sigWebsite" placeholder="z.B. www.muster.de" maxlength="100" />
          </div>
          <button type="submit" class="btn btn--primary btn--block" [disabled]="signatureSaving">
            <span class="material-symbols-outlined ms-size-20" *ngIf="!signatureSaving">check</span>
            <span class="spinner-small" *ngIf="signatureSaving"></span>
            {{ signatureSaving ? 'Speichern...' : 'KI-Kontext speichern' }}
          </button>
        </form>
      </div>

      <!-- RIGHT: E-Mail-Signatur -->
      <div class="settings-card signature-card">
        <div class="card-header">
          <div class="card-title">
            <span class="material-symbols-outlined card-icon">draw</span>
            <h2>E-Mail-Signatur</h2>
          </div>
          <span class="status-pill" [class.active]="hasRealSignature()">
            {{ hasRealSignature() ? 'Konfiguriert' : 'Nicht konfiguriert' }}
          </span>
        </div>
        <p class="card-desc">Diese Signatur wird automatisch an alle ausgehenden E-Mails angehängt.</p>

        <!-- Preview Mode -->
        <div class="sig-preview-area" *ngIf="!realSignatureEditMode">
          <div class="sig-preview-box" *ngIf="hasRealSignature()">
            <div class="sig-preview-content" [innerHTML]="getSafeHtml(user!.emailSignature || '')"></div>
          </div>
          <div class="sig-empty" *ngIf="!hasRealSignature()">
            <span class="material-symbols-outlined">draw</span>
            <p>Noch keine Signatur erstellt</p>
          </div>
          <button class="btn btn--primary" (click)="toggleRealSignatureEditMode()">
            <span class="material-symbols-outlined ms-size-20">edit</span>
            {{ hasRealSignature() ? 'Signatur bearbeiten' : 'Signatur erstellen' }}
          </button>
        </div>

        <!-- WYSIWYG Editor Mode -->
        <div class="wysiwyg-container" *ngIf="realSignatureEditMode">

          <!-- Toolbar Header -->
          <div class="editor-toolbar-header">
            <button type="button" class="btn btn--ghost btn--sm" (click)="generateDefaultSignature()" title="Signatur aus KI-Daten generieren">
              <span class="material-symbols-outlined ms-size-18">auto_awesome</span>
              Vorlage
            </button>
            <div class="view-toggle">
              <button type="button" class="toggle-btn" [class.active]="editorView === 'wysiwyg'" (click)="editorView = 'wysiwyg'" title="Visueller Editor">
                <span class="material-symbols-outlined ms-size-18">edit_note</span>
              </button>
              <button type="button" class="toggle-btn" [class.active]="editorView === 'code'" (click)="editorView = 'code'" title="HTML Code">
                <span class="material-symbols-outlined ms-size-18">code</span>
              </button>
              <button type="button" class="toggle-btn" [class.active]="editorView === 'split'" (click)="editorView = 'split'" title="Split-Ansicht">
                <span class="material-symbols-outlined ms-size-18">vertical_split</span>
              </button>
            </div>
          </div>

          <!-- Formatting Toolbar -->
          <div class="formatting-toolbar" *ngIf="editorView !== 'code'">
            <div class="toolbar-group">
              <select class="toolbar-select toolbar-select--wide" (change)="execCommand('fontName', $any($event.target).value); $any($event.target).value = ''" title="Schriftart">
                <option value="">Schriftart</option>
                <option value="Arial, sans-serif">Arial</option>
                <option value="Verdana, sans-serif">Verdana</option>
                <option value="Helvetica, sans-serif">Helvetica</option>
                <option value="Tahoma, sans-serif">Tahoma</option>
                <option value="Trebuchet MS, sans-serif">Trebuchet MS</option>
                <option value="Georgia, serif">Georgia</option>
                <option value="Times New Roman, serif">Times New Roman</option>
                <option value="Courier New, monospace">Courier New</option>
                <option value="Segoe UI, sans-serif">Segoe UI</option>
                <option value="Calibri, sans-serif">Calibri</option>
              </select>
            </div>
            <div class="toolbar-divider"></div>
            <div class="toolbar-group">
              <select class="toolbar-select" (change)="execCommand('fontSize', $any($event.target).value); $any($event.target).value = ''" title="Schriftgröße">
                <option value="">Größe</option>
                <option value="1">Klein (8pt)</option>
                <option value="2">Normal (10pt)</option>
                <option value="3">Mittel (12pt)</option>
                <option value="4">Groß (14pt)</option>
                <option value="5">Sehr groß (18pt)</option>
                <option value="6">Überschrift (24pt)</option>
                <option value="7">Titel (36pt)</option>
              </select>
            </div>
            <div class="toolbar-divider"></div>
            <div class="toolbar-group">
              <button type="button" class="toolbar-btn" (click)="execCommand('bold')" title="Fett (Strg+B)">
                <span class="material-symbols-outlined">format_bold</span>
              </button>
              <button type="button" class="toolbar-btn" (click)="execCommand('italic')" title="Kursiv (Strg+I)">
                <span class="material-symbols-outlined">format_italic</span>
              </button>
              <button type="button" class="toolbar-btn" (click)="execCommand('underline')" title="Unterstrichen (Strg+U)">
                <span class="material-symbols-outlined">format_underlined</span>
              </button>
              <button type="button" class="toolbar-btn" (click)="execCommand('strikeThrough')" title="Durchgestrichen">
                <span class="material-symbols-outlined">strikethrough_s</span>
              </button>
            </div>
            <div class="toolbar-divider"></div>
            <div class="toolbar-group">
              <div class="color-picker-wrapper">
                <button type="button" class="toolbar-btn" (click)="foreColorPicker.click()" title="Textfarbe">
                  <span class="material-symbols-outlined">format_color_text</span>
                  <span class="color-indicator" [style.background-color]="selectedTextColor"></span>
                </button>
                <input type="color" #foreColorPicker [value]="selectedTextColor" (input)="selectedTextColor = $any($event.target).value; execCommand('foreColor', $any($event.target).value)" class="hidden-color-picker">
              </div>
              <div class="color-picker-wrapper">
                <button type="button" class="toolbar-btn" (click)="bgColorPicker.click()" title="Hintergrundfarbe">
                  <span class="material-symbols-outlined">format_color_fill</span>
                  <span class="color-indicator" [style.background-color]="selectedBgColor"></span>
                </button>
                <input type="color" #bgColorPicker [value]="selectedBgColor" (input)="selectedBgColor = $any($event.target).value; execCommand('hiliteColor', $any($event.target).value)" class="hidden-color-picker">
              </div>
            </div>
            <div class="toolbar-divider"></div>
            <div class="toolbar-group">
              <button type="button" class="toolbar-btn" (click)="execCommand('justifyLeft')" title="Linksbündig">
                <span class="material-symbols-outlined">format_align_left</span>
              </button>
              <button type="button" class="toolbar-btn" (click)="execCommand('justifyCenter')" title="Zentriert">
                <span class="material-symbols-outlined">format_align_center</span>
              </button>
              <button type="button" class="toolbar-btn" (click)="execCommand('justifyRight')" title="Rechtsbündig">
                <span class="material-symbols-outlined">format_align_right</span>
              </button>
            </div>
            <div class="toolbar-divider"></div>
            <div class="toolbar-group">
              <button type="button" class="toolbar-btn" (click)="execCommand('insertUnorderedList')" title="Aufzählung">
                <span class="material-symbols-outlined">format_list_bulleted</span>
              </button>
              <button type="button" class="toolbar-btn" (click)="execCommand('insertOrderedList')" title="Nummerierung">
                <span class="material-symbols-outlined">format_list_numbered</span>
              </button>
            </div>
            <div class="toolbar-divider"></div>
            <div class="toolbar-group">
              <button type="button" class="toolbar-btn" (click)="execCommand('insertHorizontalRule')" title="Horizontale Linie">
                <span class="material-symbols-outlined">horizontal_rule</span>
              </button>
              <button type="button" class="toolbar-btn" (click)="insertLinkWysiwyg()" title="Link einfügen">
                <span class="material-symbols-outlined">link</span>
              </button>
              <button type="button" class="toolbar-btn" (click)="triggerImageUpload()" title="Bild einfügen">
                <span class="material-symbols-outlined">image</span>
              </button>
              <button type="button" class="toolbar-btn" (click)="insertTable()" title="Tabelle einfügen">
                <span class="material-symbols-outlined">table</span>
              </button>
            </div>
            <div class="toolbar-divider"></div>
            <div class="toolbar-group">
              <button type="button" class="toolbar-btn" (click)="execCommand('undo')" title="Rückgängig (Strg+Z)">
                <span class="material-symbols-outlined">undo</span>
              </button>
              <button type="button" class="toolbar-btn" (click)="execCommand('redo')" title="Wiederholen (Strg+Y)">
                <span class="material-symbols-outlined">redo</span>
              </button>
              <button type="button" class="toolbar-btn" (click)="execCommand('removeFormat')" title="Formatierung entfernen">
                <span class="material-symbols-outlined">format_clear</span>
              </button>
            </div>
          </div>

          <!-- Hidden file input -->
          <input type="file" #imageUpload accept="image/*" (change)="onImageSelected($event)" style="display:none" multiple>

          <!-- Editor Body -->
          <div class="editor-body" [class.split-view]="editorView === 'split'">
            <div class="editor-pane wysiwyg-pane" *ngIf="editorView === 'wysiwyg' || editorView === 'split'">
              <div class="pane-label" *ngIf="editorView === 'split'">
                <span class="material-symbols-outlined ms-size-14">edit_note</span> Editor
              </div>
              <div
                #wysiwygEditor
                class="wysiwyg-editable"
                contenteditable="true"
                (input)="onWysiwygInput()"
                (paste)="onWysiwygPaste($event)"
                (drop)="onWysiwygDrop($event)"
                (dragover)="$event.preventDefault()"
                [innerHTML]="getSafeHtml(editEmailSignature)"
                spellcheck="true"
              ></div>
            </div>
            <div class="editor-pane code-pane" *ngIf="editorView === 'code' || editorView === 'split'">
              <div class="pane-label">
                <span class="material-symbols-outlined ms-size-14">code</span> HTML
              </div>
              <textarea
                #htmlTextarea
                [(ngModel)]="editEmailSignature"
                name="emailSignature"
                placeholder="HTML-Code hier eingeben..."
                maxlength="500000"
                class="code-textarea"
                (keydown)="onTextareaKeydown($event)"
                (input)="onCodeInput()"
              ></textarea>
              <div class="code-footer">
                <small>{{ editEmailSignature.length | number }} Zeichen</small>
              </div>
            </div>
          </div>

          <!-- Upload status -->
          <div class="upload-status" *ngIf="uploadingImage">
            <div class="upload-spinner"></div>
            <span>Bild wird verarbeitet...</span>
          </div>

          <!-- Editor Actions -->
          <div class="editor-actions">
            <button type="button" class="btn btn--ghost" (click)="cancelRealSignatureEdit()">Abbrechen</button>
            <button type="button" class="btn btn--primary" (click)="saveRealSignature()" [disabled]="realSignatureSaving">
              <span class="material-symbols-outlined ms-size-20" *ngIf="!realSignatureSaving">check</span>
              <span class="spinner-small" *ngIf="realSignatureSaving"></span>
              {{ realSignatureSaving ? 'Speichern...' : 'Signatur speichern' }}
            </button>
          </div>
        </div>
      </div>

    </div>
  </div>

  <!-- Loading State -->
  <div class="loading-state" *ngIf="!user">
    <div class="spinner"></div>
    <p>Lade Profil...</p>
  </div>
</section>