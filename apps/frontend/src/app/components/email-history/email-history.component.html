<section class="history-page">
  <!-- Command Bar Header -->
  <header class="inbox-header">
    <div class="header-row">
      <div class="header-stats">
        <span class="stat-pill">
          <span class="material-symbols-outlined stat-pill__icon">{{ activeTab === 'sent' ? 'send' : 'delete' }}</span>
          <strong>{{ totalEmails }}</strong>
        </span>
      </div>

      <span class="header-divider"></span>

      <nav class="tab-pills">
        <button class="tab-pill" [class.active]="activeTab === 'sent'" (click)="switchTab('sent')">
          <span class="material-symbols-outlined">send</span>
          Gesendet
        </button>
        <button class="tab-pill" [class.active]="activeTab === 'trash'" (click)="switchTab('trash')">
          <span class="material-symbols-outlined">delete</span>
          Papierkorb
        </button>
      </nav>

      <span class="header-divider"></span>

      <!-- Filter Chips -->
      <div class="header-filters">
        <button class="filter-chip" [class.active]="filterAttachments" (click)="toggleAttachmentFilter()" title="Nur mit Anhängen">
          <span class="material-symbols-outlined">attach_file</span>
          Anhänge
        </button>
        <!-- <select class="filter-select" [(ngModel)]="filterTag" (ngModelChange)="onFilterTagChange()" *ngIf="availableTags.length">
          <option value="">Alle Tags</option>
          <option *ngFor="let tag of availableTags" [value]="tag">{{ tag }}</option>
        </select> -->
        <button class="filter-chip reset" *ngIf="hasActiveFilters" (click)="clearFilters()">
          <span class="material-symbols-outlined">filter_list_off</span>
          Zurücksetzen
        </button>
      </div>

      <!-- Sort Dropdown -->
      <div class="header-sort">
        <span class="material-symbols-outlined sort-icon">sort</span>
        <select class="sort-select" [(ngModel)]="sortBy" (ngModelChange)="onSortChange()">
          <option *ngFor="let opt of sortOptions" [value]="opt.value">{{ opt.label }}</option>
        </select>
      </div>

      <!-- Search -->
      <div class="header-search">
        <span class="material-symbols-outlined header-search__icon">search</span>
        <input type="text"
               [(ngModel)]="searchQuery"
               (input)="onSearchInput()"
               placeholder="Betreff, Absender, Inhalt…"
               class="header-search__input" />
        <button class="header-search__clear" *ngIf="searchQuery" (click)="clearSearch()">
          <span class="material-symbols-outlined">close</span>
        </button>
      </div>
    </div>
  </header>

  <!-- Loading -->
  <div class="loading-state" *ngIf="loading">
    <div class="skeleton-list">
      <div class="skeleton-row" *ngFor="let s of [1,2,3,4,5,6]">
        <div class="skeleton-avatar"></div>
        <div class="skeleton-lines">
          <div class="skeleton-line w60"></div>
          <div class="skeleton-line w90"></div>
          <div class="skeleton-line w40"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Empty State -->
  <div class="empty-state" *ngIf="!loading && emails.length === 0">
    <div class="empty-state__visual">
      <div class="empty-state__circle">
        <span class="material-symbols-outlined">{{ activeTab === 'sent' ? 'forward_to_inbox' : 'recycling' }}</span>
      </div>
    </div>
    <h3>{{ hasActiveFilters ? 'Keine Ergebnisse' : (activeTab === 'sent' ? 'Keine gesendeten E-Mails' : 'Papierkorb ist leer') }}</h3>
    <p *ngIf="hasActiveFilters">Versuche andere Filter oder Suchbegriffe</p>
    <button *ngIf="hasActiveFilters" class="cta-btn" (click)="clearFilters()">
      <span class="material-symbols-outlined">filter_list_off</span>
      Filter zurücksetzen
    </button>
    <a *ngIf="!hasActiveFilters" routerLink="/emails" class="cta-btn">
      <span class="material-symbols-outlined">inbox</span>
      Zum Posteingang
    </a>
  </div>

  <!-- Split View -->
  <div class="split" *ngIf="!loading && emails.length > 0">
    <!-- List pane -->
    <div class="list-pane" [class.has-detail]="selectedEmail" [@listAnimation]="emails.length">
      <!-- List header with count -->
      <div class="list-header">
        <span class="list-header__count">{{ emails.length }} von {{ totalEmails }}</span>
        <span class="list-header__label">{{ activeTab === 'sent' ? 'Gesendet' : 'Papierkorb' }}</span>
      </div>

      <div class="mail-item"
        *ngFor="let email of emails"
        [class.active]="selectedEmail?.id === email.id"
        (click)="selectEmail(email)">

        <div class="mail-avatar"
             [style.background-image]="email.fromAddress | identicon">
        </div>

        <div class="mail-content">
          <div class="mail-top">
            <span class="mail-sender">{{ getSenderName(email) }}</span>
            <span class="mail-time">
              {{ formatDate(email.repliedAt || email.receivedAt) }}
            </span>
          </div>
          <div class="mail-mailbox-row" *ngIf="email.mailboxId && getMailboxName(email.mailboxId)">
            <span class="mailbox-badge"
              [style.background-color]="getMailboxColor(email.mailboxId)">
              {{ getMailboxName(email.mailboxId) }}
            </span>
          </div>
          <div class="mail-subject">{{ email.subject }}</div>
          <div class="mail-snippet">{{ getListSnippet(email) | slice:0:120 }}</div>

          <!-- Response time badge in list -->
          <div class="mail-bottom-row">
            <div class="mail-tags" *ngIf="email.aiTags?.length">
              <span class="mail-tag" *ngFor="let tag of email.aiTags | slice:0:3">{{ tag }}</span>
            </div>
            <span class="response-time-badge" *ngIf="getResponseTime(email)" [ngClass]="getResponseTimeClass(email)" title="Antwortzeit">
              <span class="material-symbols-outlined">timer</span>
              {{ getResponseTime(email) }}
            </span>
          </div>

          <!-- Attachment chips in list -->
          <div class="mail-attachments-mini" *ngIf="email.attachments?.length">
            <span class="material-symbols-outlined att-mini-icon">attach_file</span>
            <span class="att-mini-count">{{ email.attachments!.length }}</span>
            <span class="att-mini-names" *ngFor="let att of email.attachments | slice:0:2">
              {{ att.filename | slice:0:20 }}{{ att.filename.length > 20 ? '…' : '' }}
            </span>
            <span class="att-mini-more" *ngIf="email.attachments!.length > 2">
              +{{ email.attachments!.length - 2 }}
            </span>
          </div>
        </div>

        <div class="mail-meta">
          <span class="material-symbols-outlined status-icon sent-icon" *ngIf="email.repliedAt && activeTab === 'sent'" title="Beantwortet">reply</span>
          <button class="restore-inline" *ngIf="activeTab === 'trash'" (click)="restoreEmail(email, $event)" title="Wiederherstellen">
            <span class="material-symbols-outlined">restore</span>
          </button>
        </div>
      </div>

      <button *ngIf="hasMore" class="load-more" (click)="loadMore()">
        <span class="material-symbols-outlined">expand_more</span>
        Mehr laden
      </button>
    </div>

    <!-- Detail pane -->
    <div class="detail-pane" *ngIf="selectedEmail" @fadeSlide>
      <div class="detail-bar">
        <button class="back-btn" (click)="closeDetail()">
          <span class="material-symbols-outlined">arrow_back</span>
        </button>
        <div class="detail-bar__subject">{{ selectedEmail.subject }}</div>
        <div class="detail-bar__spacer"></div>
        <!-- Response time in detail bar -->
        <span class="detail-bar__rt" *ngIf="getResponseTime(selectedEmail)" [ngClass]="getResponseTimeClass(selectedEmail)">
          <span class="material-symbols-outlined">timer</span>
          {{ getResponseTime(selectedEmail) }}
        </span>
        <button class="restore-btn" *ngIf="activeTab === 'trash'" (click)="restoreEmail(selectedEmail)">
          <span class="material-symbols-outlined">restore</span>
          Wiederherstellen
        </button>
      </div>

      <!-- Detail loading skeleton -->
      <div class="detail-loading" *ngIf="loadingDetail">
        <div class="skeleton-detail">
          <div class="skeleton-line w60"></div>
          <div class="skeleton-line w90"></div>
          <div class="skeleton-line w40"></div>
          <div class="skeleton-line w90"></div>
          <div class="skeleton-line w60"></div>
        </div>
      </div>

      <div class="detail-scroll" *ngIf="!loadingDetail">
        <!-- Conversation header -->
        <div class="conversation-header">
          <h2>{{ selectedEmail.subject }}</h2>
          <div class="conversation-meta">
            <div class="conversation-participants">
              <span class="material-symbols-outlined">person</span>
              <span>{{ getSenderName(selectedEmail) }} &lt;{{ selectedEmail.fromAddress }}&gt;</span>
            </div>
            <div class="conversation-participants" *ngIf="selectedEmail.toAddresses.length">
              <span class="material-symbols-outlined">arrow_forward</span>
              <span>{{ getToDisplay(selectedEmail) }}</span>
            </div>
            <div class="conversation-date">
              <span class="material-symbols-outlined">schedule</span>
              <span>Empfangen: {{ formatFullDate(selectedEmail.receivedAt) }}</span>
            </div>
            <div class="conversation-date" *ngIf="selectedEmail.repliedAt">
              <span class="material-symbols-outlined">reply</span>
              <span>Beantwortet: {{ formatFullDate(selectedEmail.repliedAt) }}</span>
            </div>
            <div class="conversation-rt" *ngIf="getResponseTime(selectedEmail)">
              <span class="material-symbols-outlined">timer</span>
              <span>Antwortzeit: <strong [ngClass]="getResponseTimeClass(selectedEmail)">{{ getResponseTime(selectedEmail) }}</strong></span>
            </div>
          </div>
        </div>

        <!-- AI Summary Card -->
        <div class="ai-card" *ngIf="selectedEmail.aiSummary || selectedEmail.aiTags?.length">
          <div class="ai-card__header">
            <span class="material-symbols-outlined ai-icon">auto_awesome</span>
            <span class="ai-card__title">KI-Zusammenfassung</span>
          </div>
          <p class="ai-card__summary" *ngIf="selectedEmail.aiSummary">{{ selectedEmail.aiSummary }}</p>
          <div class="ai-card__tags" *ngIf="selectedEmail.aiTags?.length">
            <span class="ai-tag" *ngFor="let tag of selectedEmail.aiTags">{{ tag }}</span>
          </div>
        </div>

        <!-- Agent Key Facts -->
        <div class="keyfacts-card" *ngIf="selectedEmail.agentKeyFacts?.length">
          <div class="keyfacts-card__header">
            <span class="material-symbols-outlined">fact_check</span>
            <span>Wichtige Infos</span>
          </div>
          <div class="keyfacts-grid">
            <div class="keyfact" *ngFor="let fact of selectedEmail.agentKeyFacts">
              <span class="material-symbols-outlined keyfact__icon">{{ fact.icon }}</span>
              <div class="keyfact__text">
                <span class="keyfact__label">{{ fact.label }}</span>
                <span class="keyfact__value">{{ fact.value }}</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Attachments Card (detail view) -->
        <div class="attachments-card" *ngIf="selectedEmail.attachments?.length">
          <div class="attachments-card__header">
            <span class="material-symbols-outlined">attach_file</span>
            <span>{{ selectedEmail.attachments!.length }} Anhang{{ selectedEmail.attachments!.length > 1 ? 'e' : '' }}</span>
          </div>
          <div class="attachments-card__grid">
            <button class="att-chip-card" *ngFor="let att of selectedEmail.attachments; let i = index" (click)="openAttachmentPreview(att, i)">
              <div class="att-chip-card__icon">
                <span class="material-symbols-outlined">{{ getFileIcon(att.contentType) }}</span>
              </div>
              <div class="att-chip-card__info">
                <span class="att-chip-card__name">{{ att.filename }}</span>
                <span class="att-chip-card__size">{{ formatFileSize(att.size) }}</span>
              </div>
            </button>
          </div>
        </div>

        <!-- ═══ FULL CONVERSATION THREAD ═══ -->
        <div class="thread-section" *ngIf="threadEmails.length > 1">
          <div class="thread-section__header">
            <span class="material-symbols-outlined">forum</span>
            <span>Gesamter Verlauf ({{ threadEmails.length }})</span>
          </div>

          <div class="thread-timeline">
            <div class="thread-msg" *ngFor="let te of threadEmails; let last = last"
                 [class.is-reply]="te.status === 'sent'"
                 [class.is-current]="te.id === selectedEmail.id"
                 [class.is-trash]="te.status === 'trash'">
              <div class="thread-msg__gutter">
                <div class="thread-msg__avatar" [class.reply]="te.status === 'sent'">
                  <span class="material-symbols-outlined">{{ te.status === 'sent' ? 'reply' : 'mail' }}</span>
                </div>
                <div class="thread-msg__line" *ngIf="!last"></div>
              </div>
              <div class="thread-msg__body">
                <div class="thread-msg__top">
                  <span class="thread-msg__sender">
                    {{ te.status === 'sent' ? 'Deine Antwort' : (te.fromName || te.fromAddress) }}
                  </span>
                  <span class="thread-msg__badge sent" *ngIf="te.status === 'sent'">Gesendet</span>
                  <span class="thread-msg__badge trash" *ngIf="te.status === 'trash'">Papierkorb</span>
                  <span class="thread-msg__date">{{ formatFullDate(te.status === 'sent' && te.repliedAt ? te.repliedAt : te.receivedAt) }}</span>
                </div>
                <div class="thread-msg__subject" *ngIf="te.subject !== selectedEmail.subject">{{ te.subject }}</div>
                <!-- Show reply body for sent emails, original body for received -->
                <div class="thread-msg__content">
                  <pre class="body-text" *ngIf="te.status === 'sent' && te.replySentBody">{{ te.replySentBody }}</pre>
                  <pre class="body-text" *ngIf="te.status !== 'sent'">{{ te.cleanedBody || te.textBody || te.preview || '(Kein Inhalt)' }}</pre>
                  <pre class="body-text" *ngIf="te.status === 'sent' && !te.replySentBody">{{ te.preview || '(Kein Inhalt)' }}</pre>
                </div>

                <!-- Attachments in thread messages -->
                <div class="thread-msg__attachments" *ngIf="te.attachments?.length">
                  <div class="thread-att-header">
                    <span class="material-symbols-outlined">attach_file</span>
                    {{ te.attachments!.length }} Anhang{{ te.attachments!.length > 1 ? 'e' : '' }}
                  </div>
                  <div class="thread-att-list">
                    <button class="att-chip mini" *ngFor="let att of te.attachments; let ai = index" (click)="openAttachmentPreview(att, ai, te)">
                      <span class="material-symbols-outlined">{{ getFileIcon(att.contentType) }}</span>
                      <span class="att-name">{{ att.filename }}</span>
                      <span class="att-size">{{ formatFileSize(att.size) }}</span>
                    </button>
                  </div>
                </div>

                <div class="thread-msg__tags" *ngIf="te.aiTags?.length">
                  <span class="ai-tag mini" *ngFor="let tag of te.aiTags">{{ tag }}</span>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Loading thread -->
        <div class="thread-loading" *ngIf="threadLoading">
          <div class="loading-spinner-small"></div>
          <span>Verlauf wird geladen…</span>
        </div>

        <!-- Fallback: single email view when no thread -->
        <ng-container *ngIf="threadEmails.length <= 1 && !threadLoading">
          <!-- Cleaned Body / Conversation Summary -->
          <div class="summary-card" *ngIf="selectedEmail.cleanedBody">
            <div class="summary-card__header">
              <span class="material-symbols-outlined">summarize</span>
              <span>Gesprächsverlauf</span>
            </div>
            <p class="summary-card__text">{{ selectedEmail.cleanedBody }}</p>
          </div>

          <!-- Sent reply section -->
          <div class="message-block message-block--reply" *ngIf="activeTab === 'sent' && (selectedEmail.replySentBody || selectedEmail.repliedAt)">
            <div class="message-block__gutter">
              <div class="message-block__avatar reply">
                <span class="material-symbols-outlined">reply</span>
              </div>
              <div class="message-block__line"></div>
            </div>
            <div class="message-block__body">
              <div class="message-block__header">
                <span class="message-block__label">Deine Antwort</span>
                <span class="message-block__time" *ngIf="selectedEmail.repliedAt">{{ formatFullDate(selectedEmail.repliedAt) }}</span>
              </div>
              <div class="message-block__meta">
                <div class="meta-row">
                  <span class="meta-key">An</span>
                  <span class="meta-val">{{ selectedEmail.fromAddress }}</span>
                </div>
                <div class="meta-row" *ngIf="selectedEmail.replySentSubject">
                  <span class="meta-key">Betreff</span>
                  <span class="meta-val">{{ selectedEmail.replySentSubject }}</span>
                </div>
              </div>
              <div class="message-block__content" *ngIf="selectedEmail.replySentBody">
                <pre class="body-text">{{ selectedEmail.replySentBody }}</pre>
              </div>
              <div class="message-block__content message-block__empty" *ngIf="!selectedEmail.replySentBody">
                <span class="material-symbols-outlined">info</span>
                <span>Antwort-Inhalt nicht verfügbar</span>
              </div>
            </div>
          </div>

          <!-- Original email section -->
          <div class="message-block message-block--original">
            <div class="message-block__gutter">
              <div class="message-block__avatar original">
                <span class="material-symbols-outlined">mail</span>
              </div>
            </div>
            <div class="message-block__body">
              <div class="message-block__header">
                <span class="message-block__label">{{ activeTab === 'sent' ? 'Original E-Mail' : 'E-Mail' }}</span>
                <span class="message-block__time">{{ formatFullDate(selectedEmail.receivedAt) }}</span>
              </div>
              <div class="message-block__meta">
                <div class="meta-row">
                  <span class="meta-key">Von</span>
                  <span class="meta-val">{{ getSenderName(selectedEmail) }} &lt;{{ selectedEmail.fromAddress }}&gt;</span>
                </div>
                <div class="meta-row" *ngIf="selectedEmail.toAddresses.length">
                  <span class="meta-key">An</span>
                  <span class="meta-val">{{ getToDisplay(selectedEmail) }}</span>
                </div>
                <div class="meta-row">
                  <span class="meta-key">Betreff</span>
                  <span class="meta-val">{{ selectedEmail.subject }}</span>
                </div>
              </div>

              <!-- Attachments (fallback single view) -->
              <div class="attachments" *ngIf="selectedEmail.attachments?.length">
                <div class="att-header">
                  <span class="material-symbols-outlined">attach_file</span>
                  {{ selectedEmail.attachments!.length }} Anhang{{ selectedEmail.attachments!.length > 1 ? 'e' : '' }}
                </div>
                <div class="att-list">
                  <button class="att-chip" *ngFor="let att of selectedEmail.attachments; let i = index" (click)="openAttachmentPreview(att, i)">
                    <span class="material-symbols-outlined">{{ getFileIcon(att.contentType) }}</span>
                    <span class="att-name">{{ att.filename }}</span>
                    <span class="att-size">{{ formatFileSize(att.size) }}</span>
                  </button>
                </div>
              </div>

              <div class="message-block__content">
                <div *ngIf="selectedEmail.htmlBody" [innerHTML]="selectedEmail.htmlBody" class="html-body"></div>
                <pre *ngIf="!selectedEmail.htmlBody && getOriginalBody(selectedEmail)" class="body-text">{{ getOriginalBody(selectedEmail) }}</pre>
                <div *ngIf="!selectedEmail.htmlBody && !getOriginalBody(selectedEmail)" class="message-block__empty">
                  <span class="material-symbols-outlined">info</span>
                  <span>Kein Inhalt verfügbar</span>
                </div>
              </div>
            </div>
          </div>
        </ng-container>
      </div>
    </div>

    <!-- No selection -->
    <div class="detail-empty" *ngIf="!selectedEmail">
      <div class="detail-empty__inner">
        <span class="material-symbols-outlined">touch_app</span>
        <p>Wähle eine E-Mail aus</p>
      </div>
    </div>
  </div>
</section>

<!-- Attachment Preview Modal -->
<app-attachment-preview
  [attachment]="selectedAttachment"
  [attachments]="currentAttachments"
  [isOpen]="attachmentPreviewOpen"
  (close)="closeAttachmentPreview()"
  (download)="downloadAttachment($event)">
</app-attachment-preview>