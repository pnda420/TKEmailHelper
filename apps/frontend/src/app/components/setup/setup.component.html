<section class="setup-page">
  <div class="setup-container" *ngIf="user">

    <!-- Progress Bar -->
    <div class="progress-bar">
      <div class="progress-track">
        <div class="progress-fill" [style.width.%]="(currentStep / totalSteps) * 100"></div>
      </div>
      <div class="progress-steps">
        <div class="step-dot" *ngFor="let s of [1,2,3]" [class.active]="currentStep >= s" [class.current]="currentStep === s">
          <span class="step-num">{{ s }}</span>
        </div>
      </div>
    </div>

    <!-- Step Header -->
    <div class="step-header" @fadeUp>
      <h1>{{ stepTitle }}</h1>
      <p>{{ stepDescription }}</p>
    </div>

    <!-- ═══════════ STEP 1: KI-Kontext ═══════════ -->
    <div class="step-content" *ngIf="currentStep === 1" @slideIn>
      <div class="setup-card">
        <div class="card-icon-header">
          <span class="material-symbols-outlined ms-fill card-icon">psychology</span>
          <h2>KI-Kontext</h2>
        </div>

        <form class="setup-form">
          <div class="field">
            <label for="sigName">
              <span class="material-symbols-outlined ms-size-16">person</span>
              Name <span class="required">*</span>
            </label>
            <input type="text" id="sigName" [(ngModel)]="editSignature.name" name="sigName"
              placeholder="z.B. Max Mustermann" maxlength="100" />
          </div>
          <div class="field">
            <label for="sigPosition">
              <span class="material-symbols-outlined ms-size-16">work</span>
              Position / Titel
            </label>
            <input type="text" id="sigPosition" [(ngModel)]="editSignature.position" name="sigPosition"
              placeholder="z.B. Geschäftsführer" maxlength="100" />
          </div>
        </form>
      </div>
    </div>

    <!-- ═══════════ STEP 2: Postfächer auswählen ═══════════ -->
    <div class="step-content" *ngIf="currentStep === 2" @slideIn>
      <div class="setup-card">
        <div class="card-icon-header">
          <span class="material-symbols-outlined ms-fill card-icon">mail</span>
          <h2>Postfächer</h2>
        </div>

        <div class="mailbox-selection" *ngIf="myMailboxes.length > 0">
          <div class="mailbox-option" *ngFor="let um of myMailboxes"
            [class.selected]="isMailboxSelected(um.mailbox.id)"
            (click)="toggleMailbox(um.mailbox.id)"
            [style.border-left-color]="um.mailbox.color || '#1565c0'">
            <div class="mailbox-option-check">
              <span class="material-symbols-outlined ms-fill" *ngIf="isMailboxSelected(um.mailbox.id)">check_box</span>
              <span class="material-symbols-outlined" *ngIf="!isMailboxSelected(um.mailbox.id)">check_box_outline_blank</span>
            </div>
            <div class="mailbox-option-info">
              <span class="mailbox-option-name">{{ um.mailbox.name }}</span>
              <span class="mailbox-option-email">{{ um.mailbox.email }}</span>
              <span class="mailbox-option-company" *ngIf="um.mailbox.companyName">{{ um.mailbox.companyName }}</span>
            </div>
          </div>
        </div>

        <div class="mailbox-empty" *ngIf="myMailboxes.length === 0">
          <span class="material-symbols-outlined">mail</span>
          <p>Noch keine Postfächer zugewiesen</p>
          <p class="hint">Ein Administrator muss dir zuerst Postfächer zuweisen. Du kannst diesen Schritt überspringen.</p>
        </div>
      </div>
    </div>

    <!-- ═══════════ STEP 3: Done ═══════════ -->
    <div class="step-content" *ngIf="currentStep === 3" @slideIn>
      <div class="setup-card done-card">
        <div class="done-icon">
          <span class="material-symbols-outlined ms-fill">check_circle</span>
        </div>
        <h2>Alles eingerichtet!</h2>
        <p>Dein Profil ist bereit. Du kannst jetzt mit MailFlow loslegen.</p>

        <div class="setup-summary">
          <div class="summary-item" *ngIf="editSignature.name">
            <span class="material-symbols-outlined ms-size-18">person</span>
            <span>{{ editSignature.name }}</span>
          </div>
          <div class="summary-item" *ngIf="editSignature.position">
            <span class="material-symbols-outlined ms-size-18">work</span>
            <span>{{ editSignature.position }}</span>
          </div>
          <div class="summary-item" *ngIf="selectedMailboxIds.size > 0">
            <span class="material-symbols-outlined ms-size-18">mail</span>
            <span>{{ selectedMailboxIds.size }} Postfach/Postfächer aktiviert</span>
          </div>
          <div class="summary-item muted" *ngIf="selectedMailboxIds.size === 0">
            <span class="material-symbols-outlined ms-size-18">mail</span>
            <span>Keine Postfächer ausgewählt (kannst du später im Profil einrichten)</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Navigation Buttons -->
    <div class="step-nav">
      <button class="btn btn--ghost" (click)="prevStep()" *ngIf="currentStep > 1 && currentStep < 3" [disabled]="saving">
        <span class="material-symbols-outlined ms-size-20">arrow_back</span>
        Zurück
      </button>
      <div class="nav-spacer" *ngIf="currentStep === 1 || currentStep === 3"></div>

      <!-- Step 2: Skip button -->
      <button class="btn btn--ghost" (click)="skipStep()" *ngIf="currentStep === 2" [disabled]="saving">
        Überspringen
      </button>

      <!-- Next / Save button -->
      <button class="btn btn--primary" (click)="nextStep()" *ngIf="currentStep < 3"
        [disabled]="saving || !canProceed">
        <span class="spinner-small" *ngIf="saving"></span>
        <span *ngIf="!saving">
          {{ currentStep === 1 ? 'Weiter' : 'Speichern & Weiter' }}
        </span>
        <span *ngIf="saving">Wird gespeichert...</span>
        <span class="material-symbols-outlined ms-size-20" *ngIf="!saving">arrow_forward</span>
      </button>

      <!-- Complete button -->
      <button class="btn btn--primary btn--large" (click)="completeSetup()" *ngIf="currentStep === 3" [disabled]="saving">
        <span class="spinner-small" *ngIf="saving"></span>
        <span *ngIf="!saving">
          <span class="material-symbols-outlined ms-size-20">rocket_launch</span>
          Los geht's!
        </span>
        <span *ngIf="saving">Wird abgeschlossen...</span>
      </button>
    </div>

  </div>
</section>
